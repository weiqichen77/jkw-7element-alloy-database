<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RDFå’Œåº”åŠ›åº”å˜æ›²çº¿è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { color: #667eea; }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status { 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 6px;
            font-weight: 500;
        }
        .success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
        .info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            border: 1px solid #dee2e6;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover { background: #5568d3; }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .test-item {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            background: #fafafa;
        }
        .test-item.pass { border-color: #28a745; background: #f1f9f3; }
        .test-item.fail { border-color: #dc3545; background: #fef5f5; }
        .chart-preview {
            width: 100%;
            height: 200px;
            border: 1px solid #ddd;
            margin: 10px 0;
            background: white;
        }
        code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .step-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            background: #667eea;
            color: white;
            border-radius: 50%;
            font-weight: bold;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” RDFå’Œåº”åŠ›åº”å˜æ›²çº¿è¯Šæ–­å·¥å…·</h1>
    
    <div class="section">
        <h2>ğŸ“‹ è¯Šæ–­æ­¥éª¤</h2>
        <div style="margin: 20px 0;">
            <div style="margin: 15px 0;">
                <span class="step-number">1</span>
                <strong>æ¸…é™¤æµè§ˆå™¨ç¼“å­˜</strong>
                <button onclick="hardRefresh()">æ‰§è¡Œå¼ºåˆ¶åˆ·æ–°</button>
            </div>
            <div style="margin: 15px 0;">
                <span class="step-number">2</span>
                <strong>æ£€æŸ¥æ•°æ®æ ¼å¼</strong>
                <button onclick="checkData()">å¼€å§‹æ£€æŸ¥</button>
            </div>
            <div style="margin: 15px 0;">
                <span class="step-number">3</span>
                <strong>æµ‹è¯•å›¾è¡¨æ¸²æŸ“</strong>
                <button onclick="testCharts()">æµ‹è¯•æ¸²æŸ“</button>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>ğŸ” æ•°æ®æ ¼å¼æ£€æŸ¥</h2>
        <div id="format-check" class="info status">
            ç‚¹å‡»ä¸Šæ–¹"å¼€å§‹æ£€æŸ¥"æŒ‰é’®è¿›è¡Œæ•°æ®æ ¼å¼éªŒè¯
        </div>
        <div class="test-grid" id="test-results"></div>
    </div>

    <div class="section">
        <h2>ğŸ“Š å›¾è¡¨æ¸²æŸ“æµ‹è¯•</h2>
        <div id="chart-status" class="info status">
            ç‚¹å‡»ä¸Šæ–¹"æµ‹è¯•æ¸²æŸ“"æŒ‰é’®æŸ¥çœ‹å›¾è¡¨
        </div>
        <div id="chart-container"></div>
    </div>

    <div class="section">
        <h2>ğŸŒ åœ¨çº¿æ•°æ®éªŒè¯</h2>
        <button onclick="verifyOnline()">éªŒè¯çº¿ä¸Šæ•°æ®</button>
        <div id="online-check" class="info status">
            ç‚¹å‡»æŒ‰é’®éªŒè¯GitHub Pagesä¸Šçš„æ•°æ®
        </div>
        <pre id="online-data"></pre>
    </div>

    <div class="section">
        <h2>ğŸ’¡ æ•…éšœæ’é™¤å»ºè®®</h2>
        <div id="troubleshooting"></div>
    </div>

    <script>
        let materialsData = null;

        function hardRefresh() {
            const status = document.getElementById('format-check');
            status.className = 'info status';
            status.innerHTML = 'æ­£åœ¨å¼ºåˆ¶åˆ·æ–°é¡µé¢...';
            setTimeout(() => {
                location.reload(true);
            }, 500);
        }

        async function checkData() {
            const statusDiv = document.getElementById('format-check');
            const resultsDiv = document.getElementById('test-results');
            
            statusDiv.className = 'info status';
            statusDiv.textContent = 'â³ æ­£åœ¨åŠ è½½æ•°æ®...';
            resultsDiv.innerHTML = '';

            try {
                // æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜
                const response = await fetch('./data/materials.json?t=' + Date.now());
                materialsData = await response.json();
                
                statusDiv.className = 'success status';
                statusDiv.innerHTML = `âœ… æ•°æ®åŠ è½½æˆåŠŸï¼å…± ${materialsData.length} ä¸ªææ–™`;

                // æµ‹è¯•é¡¹ç›®
                const tests = [
                    {
                        name: 'RDFæ•°æ®æ ¼å¼',
                        test: () => {
                            const amorphous = materialsData.find(m => m.type === 'amorphous');
                            const rdf = amorphous?.data[0]?.properties?.structure?.rdf;
                            return Array.isArray(rdf);
                        },
                        expected: 'åº”ä¸ºæ•°ç»„'
                    },
                    {
                        name: 'RDFæ•°æ®å†…å®¹',
                        test: () => {
                            const amorphous = materialsData.find(m => m.type === 'amorphous');
                            const rdf = amorphous?.data[0]?.properties?.structure?.rdf;
                            return Array.isArray(rdf) && rdf.length > 0 && Array.isArray(rdf[0]);
                        },
                        expected: 'åº”ä¸ºäºŒç»´æ•°ç»„'
                    },
                    {
                        name: 'åº”åŠ›åº”å˜æ ¼å¼',
                        test: () => {
                            const material = materialsData[0];
                            const stress = material?.data[0]?.properties?.mechanics?.stressStrain;
                            return Array.isArray(stress);
                        },
                        expected: 'åº”ä¸ºæ•°ç»„'
                    },
                    {
                        name: 'åº”åŠ›åº”å˜å†…å®¹',
                        test: () => {
                            const material = materialsData[0];
                            const stress = material?.data[0]?.properties?.mechanics?.stressStrain;
                            return Array.isArray(stress) && stress.length > 0 && Array.isArray(stress[0]);
                        },
                        expected: 'åº”ä¸ºäºŒç»´æ•°ç»„'
                    },
                    {
                        name: 'RDFææ–™æ•°é‡',
                        test: () => {
                            let count = 0;
                            materialsData.forEach(m => {
                                m.data.forEach(d => {
                                    if (d.properties?.structure?.rdf && Array.isArray(d.properties.structure.rdf)) {
                                        count++;
                                    }
                                });
                            });
                            return count > 40; // åº”è¯¥æœ‰50+ä¸ªRDFæ•°æ®ç‚¹
                        },
                        expected: 'åº”>40ä¸ªæ•°æ®ç‚¹'
                    },
                    {
                        name: 'åº”åŠ›åº”å˜æ•°é‡',
                        test: () => {
                            let count = 0;
                            materialsData.forEach(m => {
                                m.data.forEach(d => {
                                    if (d.properties?.mechanics?.stressStrain && Array.isArray(d.properties.mechanics.stressStrain)) {
                                        count++;
                                    }
                                });
                            });
                            return count > 200; // åº”è¯¥æœ‰250+ä¸ª
                        },
                        expected: 'åº”>200ä¸ªæ•°æ®ç‚¹'
                    }
                ];

                let passCount = 0;
                tests.forEach(test => {
                    const result = test.test();
                    const div = document.createElement('div');
                    div.className = 'test-item ' + (result ? 'pass' : 'fail');
                    div.innerHTML = `
                        <strong>${result ? 'âœ…' : 'âŒ'} ${test.name}</strong>
                        <div style="margin-top: 5px; font-size: 12px; color: #666;">
                            ${test.expected}
                        </div>
                    `;
                    resultsDiv.appendChild(div);
                    if (result) passCount++;
                });

                // æ·»åŠ æ€»ç»“
                const summary = document.createElement('div');
                summary.className = 'test-item ' + (passCount === tests.length ? 'pass' : 'fail');
                summary.innerHTML = `
                    <strong>${passCount === tests.length ? 'ğŸ‰' : 'âš ï¸'} æµ‹è¯•ç»“æœ</strong>
                    <div style="margin-top: 5px;">
                        ${passCount}/${tests.length} é¡¹æµ‹è¯•é€šè¿‡
                    </div>
                `;
                resultsDiv.appendChild(summary);

                // æ˜¾ç¤ºæ•…éšœæ’é™¤å»ºè®®
                if (passCount < tests.length) {
                    showTroubleshooting('fail');
                } else {
                    showTroubleshooting('success');
                }

            } catch (error) {
                statusDiv.className = 'error status';
                statusDiv.innerHTML = `âŒ é”™è¯¯: ${error.message}<br>
                    <small>å¯èƒ½åŸå› ï¼šæ•°æ®æ–‡ä»¶æœªåŠ è½½æˆ–æ ¼å¼é”™è¯¯</small>`;
                showTroubleshooting('error');
            }
        }

        async function testCharts() {
            const statusDiv = document.getElementById('chart-status');
            const container = document.getElementById('chart-container');

            if (!materialsData) {
                statusDiv.className = 'warning status';
                statusDiv.textContent = 'âš ï¸ è¯·å…ˆæ‰§è¡Œ"æ£€æŸ¥æ•°æ®æ ¼å¼"';
                return;
            }

            statusDiv.className = 'info status';
            statusDiv.textContent = 'â³ æ­£åœ¨æ¸²æŸ“å›¾è¡¨...';
            container.innerHTML = '';

            try {
                // æ‰¾ä¸€ä¸ªæœ‰RDFæ•°æ®çš„ææ–™
                const amorphous = materialsData.find(m => m.type === 'amorphous' && 
                    m.data[0]?.properties?.structure?.rdf);
                
                if (!amorphous) {
                    throw new Error('æœªæ‰¾åˆ°RDFæ•°æ®');
                }

                const rdfData = amorphous.data[0].properties.structure.rdf;
                const stressData = amorphous.data[0].properties.mechanics.stressStrain;

                // åˆ›å»ºRDFå›¾è¡¨
                const rdfDiv = document.createElement('div');
                rdfDiv.innerHTML = `<h3>RDFå›¾è¡¨ - ${amorphous.name}</h3>`;
                const rdfCanvas = document.createElement('canvas');
                rdfCanvas.className = 'chart-preview';
                rdfDiv.appendChild(rdfCanvas);
                container.appendChild(rdfDiv);

                drawChart(rdfCanvas, rdfData, 'Distance (Ã…)', 'g(r)');

                // åˆ›å»ºåº”åŠ›åº”å˜å›¾è¡¨
                const stressDiv = document.createElement('div');
                stressDiv.innerHTML = `<h3>åº”åŠ›åº”å˜æ›²çº¿ - ${amorphous.name}</h3>`;
                const stressCanvas = document.createElement('canvas');
                stressCanvas.className = 'chart-preview';
                stressDiv.appendChild(stressCanvas);
                container.appendChild(stressDiv);

                drawChart(stressCanvas, stressData, 'Strain (%)', 'Stress (GPa)');

                statusDiv.className = 'success status';
                statusDiv.innerHTML = 'âœ… å›¾è¡¨æ¸²æŸ“æˆåŠŸï¼<br><small>å¦‚æœæ‚¨åœ¨ä¸»é¡µé¢çœ‹ä¸åˆ°å›¾è¡¨ï¼Œå¯èƒ½æ˜¯æµè§ˆå™¨ç¼“å­˜é—®é¢˜</small>';

            } catch (error) {
                statusDiv.className = 'error status';
                statusDiv.innerHTML = `âŒ æ¸²æŸ“å¤±è´¥: ${error.message}`;
            }
        }

        function drawChart(canvas, data, xLabel, yLabel) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth;
            const height = canvas.height = 200;
            
            ctx.clearRect(0, 0, width, height);
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, width, height);
            
            const padding = 50;
            const plotWidth = width - 2 * padding;
            const plotHeight = height - 2 * padding;
            
            const xData = data.map(d => d[0]);
            const yData = data.map(d => d[1]);
            const xMin = Math.min(...xData);
            const xMax = Math.max(...xData);
            const yMin = Math.min(...yData);
            const yMax = Math.max(...yData);
            
            // åæ ‡è½´
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();
            
            // æ›²çº¿
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            data.forEach((point, i) => {
                const x = padding + ((point[0] - xMin) / (xMax - xMin || 1)) * plotWidth;
                const y = height - padding - ((point[1] - yMin) / (yMax - yMin || 1)) * plotHeight;
                
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            
            ctx.stroke();
            
            // æ ‡ç­¾
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(xLabel, width / 2, height - 10);
            
            ctx.save();
            ctx.translate(15, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText(yLabel, 0, 0);
            ctx.restore();
        }

        async function verifyOnline() {
            const statusDiv = document.getElementById('online-check');
            const dataDiv = document.getElementById('online-data');
            
            statusDiv.className = 'info status';
            statusDiv.textContent = 'â³ æ­£åœ¨éªŒè¯çº¿ä¸Šæ•°æ®...';
            dataDiv.textContent = '';

            try {
                const url = 'https://wqchen007.github.io/jkw-7element-alloy-database/data/materials.json?t=' + Date.now();
                const response = await fetch(url);
                const data = await response.json();
                
                const amorphous = data.find(m => m.name === 'W2Zr2Fe1-amorphous');
                const rdf = amorphous.data[0].properties.structure.rdf;
                const stress = amorphous.data[0].properties.mechanics.stressStrain;
                
                const rdfType = typeof rdf;
                const stressType = typeof stress;
                const rdfIsArray = Array.isArray(rdf);
                const stressIsArray = Array.isArray(stress);
                
                if (rdfIsArray && stressIsArray) {
                    statusDiv.className = 'success status';
                    statusDiv.innerHTML = 'âœ… çº¿ä¸Šæ•°æ®æ ¼å¼æ­£ç¡®ï¼<br><small>å¦‚æœæµè§ˆå™¨ä¸­ä»æ˜¾ç¤ºé”™è¯¯ï¼Œè¯·æ¸…é™¤ç¼“å­˜</small>';
                } else {
                    statusDiv.className = 'error status';
                    statusDiv.innerHTML = 'âŒ çº¿ä¸Šæ•°æ®æ ¼å¼é”™è¯¯ï¼<br><small>RDF: ' + rdfType + ', åº”åŠ›åº”å˜: ' + stressType + '</small>';
                }
                
                dataDiv.textContent = JSON.stringify({
                    material: 'W2Zr2Fe1-amorphous',
                    rdf: {
                        type: rdfIsArray ? 'array' : rdfType,
                        length: rdfIsArray ? rdf.length : 'N/A',
                        sample: rdfIsArray ? rdf.slice(0, 3) : rdf
                    },
                    stressStrain: {
                        type: stressIsArray ? 'array' : stressType,
                        length: stressIsArray ? stress.length : 'N/A',
                        sample: stressIsArray ? stress.slice(0, 3) : stress
                    }
                }, null, 2);

            } catch (error) {
                statusDiv.className = 'error status';
                statusDiv.innerHTML = `âŒ éªŒè¯å¤±è´¥: ${error.message}`;
            }
        }

        function showTroubleshooting(status) {
            const div = document.getElementById('troubleshooting');
            
            if (status === 'success') {
                div.innerHTML = `
                    <div class="success status">
                        <strong>âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼</strong>
                        <p>å¦‚æœæ‚¨åœ¨ä¸»é¡µé¢ä¸­çœ‹ä¸åˆ°å›¾è¡¨ï¼Œè¯·å°è¯•ï¼š</p>
                        <ol>
                            <li><strong>æ¸…é™¤æµè§ˆå™¨ç¼“å­˜</strong>ï¼šæŒ‰ <code>Ctrl+Shift+Delete</code>ï¼ˆWindowsï¼‰æˆ– <code>Cmd+Shift+Delete</code>ï¼ˆMacï¼‰</li>
                            <li><strong>ç¡¬åˆ·æ–°</strong>ï¼šæŒ‰ <code>Ctrl+F5</code>ï¼ˆWindowsï¼‰æˆ– <code>Cmd+Shift+R</code>ï¼ˆMacï¼‰</li>
                            <li><strong>ä½¿ç”¨æ— ç—•æ¨¡å¼</strong>ï¼šæŒ‰ <code>Ctrl+Shift+N</code>ï¼ˆChromeï¼‰æˆ– <code>Ctrl+Shift+P</code>ï¼ˆFirefoxï¼‰</li>
                            <li><strong>ç¦ç”¨ç¼“å­˜</strong>ï¼šæ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰ â†’ Networkæ ‡ç­¾ â†’ å‹¾é€‰"Disable cache"</li>
                        </ol>
                    </div>
                `;
            } else if (status === 'fail') {
                div.innerHTML = `
                    <div class="error status">
                        <strong>âŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥</strong>
                        <p>å¯èƒ½çš„åŸå› ï¼š</p>
                        <ol>
                            <li><strong>æµè§ˆå™¨ç¼“å­˜</strong>ï¼šå°è¯•æ¸…é™¤ç¼“å­˜æˆ–ä½¿ç”¨æ— ç—•æ¨¡å¼</li>
                            <li><strong>æœ¬åœ°æ–‡ä»¶</strong>ï¼šç¡®ä¿æ‚¨è®¿é—®çš„æ˜¯çº¿ä¸Šç‰ˆæœ¬ï¼Œè€Œä¸æ˜¯æœ¬åœ°æ–‡ä»¶</li>
                            <li><strong>CDNå»¶è¿Ÿ</strong>ï¼šGitHub Pagesçš„CDNå¯èƒ½éœ€è¦5-10åˆ†é’Ÿæ›´æ–°</li>
                        </ol>
                        <button onclick="verifyOnline()">éªŒè¯çº¿ä¸Šæ•°æ®</button>
                    </div>
                `;
            } else {
                div.innerHTML = `
                    <div class="error status">
                        <strong>âŒ æ•°æ®åŠ è½½å¤±è´¥</strong>
                        <p>è¯·æ£€æŸ¥ï¼š</p>
                        <ol>
                            <li>æ‚¨æ˜¯å¦è®¿é—®æ­£ç¡®çš„ç½‘å€</li>
                            <li><code>data/materials.json</code> æ–‡ä»¶æ˜¯å¦å­˜åœ¨</li>
                            <li>æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯ï¼ˆæŒ‰F12æŸ¥çœ‹ï¼‰</li>
                        </ol>
                    </div>
                `;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', () => {
            document.getElementById('format-check').innerHTML = `
                <strong>ğŸ‘‹ æ¬¢è¿ä½¿ç”¨è¯Šæ–­å·¥å…·</strong><br>
                <small>æ­¤å·¥å…·å°†å¸®åŠ©æ‚¨éªŒè¯RDFå’Œåº”åŠ›åº”å˜æ›²çº¿æ•°æ®æ˜¯å¦æ­£ç¡®åŠ è½½</small><br>
                <button onclick="checkData()" style="margin-top:10px;">å¼€å§‹è‡ªåŠ¨æ£€æŸ¥</button>
            `;
        });
    </script>
</body>
</html>
