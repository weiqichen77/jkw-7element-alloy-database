# 数据模板更新说明 (V2.1)

## 更新日期
2024年 - 提交哈希：d72431d

## 主要变更

### 1. 移除ID必填项 ✅
**之前**：用户需要在CSV中手动分配和管理ID
```csv
id,name,type,composition,...
1,Al2Cu4-sample,solid-solution,Al2Cu4,...
1,Al2Cu4-sample,solid-solution,Al2Cu4,...  (同一材料的不同温度数据)
```

**现在**：系统自动分配ID
```csv
name,source,type,composition,...
Al2Cu4-sample,Wang Lab,solid-solution,Al2Cu4,...
Al2Cu4-sample,Wang Lab,solid-solution,Al2Cu4,...
```

**好处**：
- 减轻数据贡献者负担
- 避免ID冲突和编号错误
- 系统保证ID的连续性和唯一性

### 2. 新增材料来源字段 ✅
添加了 `source` 列用于标识材料的来源/作者：

```csv
name,source,type,composition,...
Al2Cu4-sample,Wang Lab,solid-solution,Al2Cu4,...
Ni-pure,Zhang Group,element,Ni1,...
Fe3Ti2-alloy,Li Research,intermetallic,Fe3Ti2,...
```

**来源示例**：
- Wang Lab（王老师实验室）
- Zhang Group（张老师课题组）
- Li Research（李老师研究组）
- Chen Lab（陈老师实验室）
- 或其他能识别数据贡献者的标识

### 3. 区分材料来源与数据来源 ✅
现在有两个独立的"来源"字段：

| 字段 | 位置 | 含义 | 示例 |
|------|------|------|------|
| `source` | 材料级别 | 谁提供了这个材料 | Wang Lab, Zhang Group |
| `data_source` | 数据点级别 | 计算/测量方法 | DFT, DPA-1, DPA-3, Experiment |

**CSV示例**：
```csv
name,source,type,composition,temperature,data_source,...
Al2Cu4,Wang Lab,solid-solution,Al2Cu4,0,DFT,...
Al2Cu4,Wang Lab,solid-solution,Al2Cu4,300,DPA-3,...
```

**JSON结构**：
```json
{
  "id": 1,
  "name": "Al2Cu4",
  "source": "Wang Lab",  // 材料来源
  "type": "solid-solution",
  "data": [
    {
      "temperature": 0,
      "source": "DFT",  // 数据来源
      "properties": {...}
    },
    {
      "temperature": 300,
      "source": "DPA-3",
      "properties": {...}
    }
  ]
}
```

## 转换脚本更新

### 材料分组逻辑
**之前**：按ID分组
```javascript
const materials = {};
rows.forEach(row => {
  const id = row.id;
  materials[id] = materials[id] || [];
  materials[id].push(row);
});
```

**现在**：按名称+来源分组
```javascript
const materials = {};
rows.forEach(row => {
  const key = `${row.name}|||${row.source || 'Unknown'}`;
  materials[key] = materials[key] || [];
  materials[key].push(row);
});
```

### ID自动分配
转换后自动按顺序分配ID：
```javascript
materials.forEach((material, index) => {
  material.id = index + 1;
});
console.log(`Assigned IDs from 1 to ${materials.length}`);
```

### 验证要求更新
- ✅ 移除：id字段验证
- ✅ 新增：source字段验证（必填）
- ✅ 保留：name, type, composition验证

## 界面显示更新

所有四个属性表格均已添加"来源"列：

### 结构属性表
```
ID | 名称 | 来源 | 类型 | 元素组成 | ...
1  | Al2Cu4 | Wang Lab | 固溶体 | Al₂Cu₄ | ...
```

### 热力学属性表
```
ID | 名称 | 来源 | 类型 | 元素组成 | 比热容 | ...
1  | Al2Cu4 | Wang Lab | 固溶体 | Al₂Cu₄ | 0.45 | ...
```

### 力学属性表
```
ID | 名称 | 来源 | 类型 | 元素组成 | 弹性常数 | ...
1  | Al2Cu4 | Wang Lab | 固溶体 | Al₂Cu₄ | C₁₁=230 | ...
```

### 缺陷属性表
```
ID | 名称 | 来源 | 类型 | 元素组成 | 空位能 | ...
1  | Al2Cu4 | Wang Lab | 固溶体 | Al₂Cu₄ | 1.35 | ...
```

## 数据迁移

已有100个材料已自动添加默认来源字段：
```json
{
  "id": 1,
  "name": "Al3Zr3-intermetallic",
  "source": "Research Database",  // 默认来源
  "type": "intermetallic",
  ...
}
```

## 使用指南

### 新数据提交流程

1. **准备CSV文件**（使用 example-template-v2.csv）
```csv
name,source,type,composition,poscar,temperature,data_source,...
MyMaterial,Your Lab,solid-solution,Al2Cu3,data/poscar/my.vasp,0,DFT,...
MyMaterial,Your Lab,solid-solution,Al2Cu3,data/poscar/my.vasp,300,DPA-3,...
```

2. **运行转换脚本**
```bash
node scripts/convert-data-v2.js your-data.csv output.json
```

3. **验证输出**
- 检查ID是否自动分配（1, 2, 3...）
- 确认材料来源字段存在
- 确认数据来源字段正确（DFT/DPA-3/Experiment）

4. **合并到主数据库**
```bash
# 手动合并或使用脚本
node scripts/merge-materials.js output.json data/materials.json
```

### CSV字段说明

#### 必填字段
- `name`：材料名称（可重复，同一材料的不同温度数据）
- `source`：材料来源（作者/实验室/课题组）
- `type`：材料类型（element/solid-solution/intermetallic/amorphous）
- `composition`：化学组成（如 Al2Cu4）
- `temperature`：温度（K）

#### 推荐字段
- `data_source`：数据来源（DFT/DPA-1/DPA-3/Experiment/MD）
- `poscar`：POSCAR文件路径

#### 属性字段（可选）
结构、热力学、力学、缺陷属性字段（参考模板）

## 兼容性说明

### 向后兼容 ✅
- 旧的JSON数据格式完全兼容
- 已有材料自动添加默认来源
- 前端显示正常

### 新功能 ✅
- ID自动分配
- 材料来源追踪
- 数据来源与材料来源清晰分离

## 技术实现

### 文件修改清单
1. `.github/workflows/deploy-pages.yml`
   - 4个表格函数添加来源列

2. `scripts/convert-data-v2.js`
   - 修改分组逻辑（ID → name+source）
   - 添加ID自动分配
   - 区分material.source和dataPoint.source
   - 更新验证规则

3. `example-template-v2.csv`
   - 移除id列
   - 添加source列
   - 重命名source为data_source

4. `data/materials.json`
   - 为所有材料添加source字段

5. `scripts/add-source-field.js`（新增）
   - 数据迁移工具

## 测试验证

### 转换测试 ✅
```bash
$ node scripts/convert-data-v2.js example-template-v2.csv test-output.json
Reading input file: example-template-v2.csv
Parsed 6 data rows
Grouped into 4 materials
Assigned IDs from 1 to 4

Successfully converted 4 materials to test-output.json
Total data entries: 6
```

### 数据迁移 ✅
```bash
$ node scripts/add-source-field.js
Backup created: /workspaces/.../data/materials.json.backup
Processing 100 materials...
Added source field to 100 materials
Updated materials written to /workspaces/.../data/materials.json
Migration complete!
```

### 部署状态 ✅
- 提交：d72431d
- 分支：main
- 状态：已推送，等待GitHub Pages部署

## 常见问题

### Q: 是否必须提供source字段？
A: 是的，现在source（材料来源）是必填字段。建议使用可识别的实验室/课题组名称。

### Q: 旧数据的ID会改变吗？
A: 不会。已有数据的ID保持不变，新数据从下一个可用ID开始分配。

### Q: data_source和source有什么区别？
A: 
- `source`（材料级别）：谁提供了这个材料（如"Wang Lab"）
- `data_source`（数据点级别）：数据如何获得（如"DFT"、"Experiment"）

### Q: 如何批量更新已有材料的来源？
A: 可以编写脚本或手动编辑materials.json，将默认的"Research Database"替换为实际来源。

### Q: 分组逻辑如何工作？
A: 系统将相同name和source的所有行视为同一材料的不同数据点（温度/条件）。

## 下一步计划

- [ ] 添加来源字段的搜索/筛选功能
- [ ] 导出功能包含来源信息
- [ ] 材料详情页显示来源
- [ ] 来源统计和可视化

## 联系方式

如有问题或建议，请提交Issue或联系维护者。
