name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
      - scaffold/frontend-backend-structure
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Check for real data
        id: check_data
        run: |
          if [ -f "real-data/materials.json" ]; then
            echo "has_real_data=true" >> $GITHUB_OUTPUT
            echo "Using real data from real-data/materials.json"
          else
            echo "has_real_data=false" >> $GITHUB_OUTPUT
            echo "No real data found, will generate sample data"
          fi
      
      - name: Generate sample data
        if: steps.check_data.outputs.has_real_data == 'false'
        run: |
          cd scripts
          node generate-sample-data.js
          echo "Generated sample data"
      
      - name: Use real data
        if: steps.check_data.outputs.has_real_data == 'true'
        run: |
          mkdir -p backend/data
          cp real-data/materials.json backend/data/materials.json
          echo "Copied real data to backend/data/"
      
      - name: Prepare deployment
        run: |
          mkdir -p _site
          cp -r frontend/* _site/
          cp -r backend/data _site/data
          
          # Create a simple API mock for GitHub Pages
          cat > _site/api-mock.js << 'EOF'
          // Simple client-side API mock for GitHub Pages
          async function loadMaterials() {
            const response = await fetch('./data/materials.json');
            return await response.json();
          }
          
          window.MaterialsAPI = {
            async search(query = {}) {
              const allData = await loadMaterials();
              let results = allData;
              
              // Filter by query string
              if (query.q) {
                const searchTerm = query.q.toLowerCase();
                results = results.filter(item => 
                  item.name.toLowerCase().includes(searchTerm) ||
                  item.elements.some(el => el.toLowerCase().includes(searchTerm))
                );
              }
              
              // Filter by type
              if (query.type) {
                results = results.filter(item => item.type === query.type);
              }
              
              // Filter by element
              if (query.element) {
                results = results.filter(item => item.elements.includes(query.element));
              }
              
              // Pagination
              const page = parseInt(query.page) || 1;
              const perPage = parseInt(query.per_page) || 25;
              const total = results.length;
              const start = (page - 1) * perPage;
              const end = start + perPage;
              
              return {
                total,
                page,
                per_page: perPage,
                results: results.slice(start, end)
              };
            },
            
            async getById(id) {
              const allData = await loadMaterials();
              return allData.find(item => item.id == id);
            }
          };
          EOF
      
      - name: Update frontend to use mock API
        run: |
          # Update app.js to use the mock API for GitHub Pages with i18n support
          cat > _site/js/app.js << 'EOF'
          // Internationalization
          const translations = {
            en: {
              title: 'Alloy Materials Database',
              subtitle: 'Material Properties (Primary: Al-Ni-Cu-Zr-Nb-Ta-W System)',
              elementNote: 'Note: Database supports elements beyond the primary 7-element system',
              search: 'Search',
              searchPlaceholder: 'Search materials or elements...',
              infoText: 'Tip: Select material type and property category, or use search to find specific materials',
              typeTitle: 'Material Type',
              propertyTitle: 'Property Category',
              loading: 'Loading...',
              noData: 'No matching data found',
              resultsCount: 'Found {count} results',
              githubLink: 'GitHub Repository',
              docsLink: 'Documentation',
              updateLabel: 'Data Updated:',
              viewDetails: 'View Details',
              closeDetails: 'Close',
              allProperties: 'All Properties',
              basicInfo: 'Basic Information',
              structureInfo: 'Structure Properties',
              thermoInfo: 'Thermodynamics Properties',
              mechInfo: 'Mechanics Properties',
              defectInfo: 'Defect Properties',
              noDataAvailable: 'No data available',
              plotData: 'Plot Data',
              export: {
                title: 'Export Data',
                format: 'Export Format',
                range: 'Export Range',
                properties: 'Properties to Export',
                execute: 'üì• Export',
                cancel: 'Cancel',
                allMaterials: 'All materials',
                filteredResults: 'Current filtered results',
                selectedMaterials: 'Selected materials',
                searchPlaceholder: 'Search to select...',
                jsonDesc: 'Complete data with full structure',
                csvDesc: 'Spreadsheet format (flattened)',
                noDataToExport: 'No data to export',
                structure: 'Structure',
                thermodynamics: 'Thermodynamics',
                mechanics: 'Mechanics',
                defects: 'Defects'
              },
              type: {
                all: 'All',
                element: 'Element',
                'solid-solution': 'Solid Solution',
                intermetallic: 'Intermetallic',
                amorphous: 'Amorphous',
                interface: 'Interface'
              },
              property: {
                structure: 'Structure',
                thermodynamics: 'Thermodynamics',
                mechanics: 'Mechanics',
                defects: 'Defects'
              },
              table: {
                id: 'ID',
                name: 'Name',
                type: 'Type',
                elements: 'Elements',
                density: 'Density',
                latticeA: 'Lattice a',
                latticeB: 'Lattice b',
                latticeC: 'Lattice c',
                rdf: 'RDF',
                specificHeat: 'Specific Heat',
                mixingEnthalpy: 'Mixing Enthalpy',
                diffusionCoeff: 'Diffusion Coeff.',
                thermalExpansion: 'Thermal Expansion',
                elasticConstants: 'Elastic Constants',
                stressStrain: 'Stress-Strain',
                youngsModulus: "Young's Modulus",
                poissonsRatio: "Poisson's Ratio",
                vacancyEnergy: 'Vacancy Energy',
                interstitialEnergy: 'Interstitial Energy',
                stackingFault: 'Stacking Fault'
              }
            },
            zh: {
              title: 'ÂêàÈáëÊùêÊñôÊï∞ÊçÆÂ∫ì',
              subtitle: 'ÊùêÊñôÊÄßËÉΩÊï∞ÊçÆÔºà‰∏ªË¶ÅÂÖ≥Ê≥®ÔºöAl-Ni-Cu-Zr-Nb-Ta-W ‰ΩìÁ≥ªÔºâ',
              elementNote: 'ËØ¥ÊòéÔºöÊï∞ÊçÆÂ∫ìÊîØÊåÅ‰∏ªË¶Å7ÂÖÉÁ¥†‰ΩìÁ≥ª‰πãÂ§ñÁöÑÂÖ∂‰ªñÂÖÉÁ¥†',
              search: 'ÊêúÁ¥¢',
              searchPlaceholder: 'ÊêúÁ¥¢ÊùêÊñôÂêçÁß∞ÊàñÂÖÉÁ¥†...',
              infoText: 'ÊèêÁ§∫ÔºöÈÄâÊã©ÊùêÊñôÁ±ªÂûãÂíåÊÄßË¥®ÂàÜÁ±ªÔºåÊàñ‰ΩøÁî®ÊêúÁ¥¢ÂäüËÉΩÊü•ÊâæÁâπÂÆöÊùêÊñô',
              typeTitle: 'ÊùêÊñôÁ±ªÂûã',
              propertyTitle: 'ÊÄßË¥®ÂàÜÁ±ª',
              loading: 'Âä†ËΩΩ‰∏≠...',
              noData: 'Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÊï∞ÊçÆ',
              resultsCount: 'ÊâæÂà∞ {count} Êù°ÁªìÊûú',
              githubLink: 'GitHub ‰ªìÂ∫ì',
              docsLink: '‰ΩøÁî®ËØ¥Êòé',
              updateLabel: 'Êï∞ÊçÆÊõ¥Êñ∞Êó∂Èó¥:',
              viewDetails: 'Êü•ÁúãËØ¶ÊÉÖ',
              closeDetails: 'ÂÖ≥Èó≠',
              allProperties: 'ÊâÄÊúâÊÄßË¥®',
              basicInfo: 'Âü∫Êú¨‰ø°ÊÅØ',
              structureInfo: 'ÁªìÊûÑÊÄßË¥®',
              thermoInfo: 'ÁÉ≠ÂäõÂ≠¶ÊÄßË¥®',
              mechInfo: 'ÂäõÂ≠¶ÊÄßËÉΩ',
              defectInfo: 'Áº∫Èô∑ÊÄßË¥®',
              noDataAvailable: 'Êó†Êï∞ÊçÆ',
              plotData: 'ÁªòÂà∂Êï∞ÊçÆ',
              export: {
                title: 'ÂØºÂá∫Êï∞ÊçÆ',
                format: 'ÂØºÂá∫Ê†ºÂºè',
                range: 'ÂØºÂá∫ËåÉÂõ¥',
                properties: 'ÂØºÂá∫Â±ûÊÄß',
                execute: 'üì• ÂØºÂá∫',
                cancel: 'ÂèñÊ∂à',
                allMaterials: 'ÂÖ®ÈÉ®ÊùêÊñô',
                filteredResults: 'ÂΩìÂâçÁ≠õÈÄâÁªìÊûú',
                selectedMaterials: 'ÈÄâÊã©ÁöÑÊùêÊñô',
                searchPlaceholder: 'ÊêúÁ¥¢‰ª•ÈÄâÊã©...',
                jsonDesc: 'ÂÆåÊï¥Êï∞ÊçÆÁªìÊûÑ',
                csvDesc: 'Ë°®Ê†ºÊ†ºÂºèÔºàÊâÅÂπ≥ÂåñÔºâ',
                noDataToExport: 'Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑÊï∞ÊçÆ',
                structure: 'ÁªìÊûÑ',
                thermodynamics: 'ÁÉ≠ÂäõÂ≠¶',
                mechanics: 'ÂäõÂ≠¶',
                defects: 'Áº∫Èô∑'
              },
              type: {
                all: 'ÂÖ®ÈÉ®',
                element: 'ÂçïË¥®',
                'solid-solution': 'Âõ∫Ê∫∂‰Ωì',
                intermetallic: 'ÈáëÂ±ûÈó¥ÂåñÂêàÁâ©',
                amorphous: 'ÈùûÊô∂',
                interface: 'ÁïåÈù¢'
              },
              property: {
                structure: 'ÁªìÊûÑ‰ø°ÊÅØ',
                thermodynamics: 'ÁÉ≠ÂäõÂ≠¶/Âä®ÂäõÂ≠¶',
                mechanics: 'ÂäõÂ≠¶ÊÄßËÉΩ',
                defects: 'Áº∫Èô∑ÊÄßË¥®'
              },
              table: {
                id: 'ID',
                name: 'ÂêçÁß∞',
                type: 'Á±ªÂûã',
                elements: 'ÂÖÉÁ¥†',
                density: 'ÂØÜÂ∫¶',
                latticeA: 'Êô∂Ê†ºÂ∏∏Êï∞ a',
                latticeB: 'Êô∂Ê†ºÂ∏∏Êï∞ b',
                latticeC: 'Êô∂Ê†ºÂ∏∏Êï∞ c',
                rdf: 'ÂæÑÂêëÂàÜÂ∏ÉÂáΩÊï∞',
                specificHeat: 'ÊØîÁÉ≠ÂÆπ',
                mixingEnthalpy: 'Ê∑∑ÂêàÁÑì',
                diffusionCoeff: 'Êâ©Êï£Á≥ªÊï∞',
                thermalExpansion: 'ÁÉ≠ËÜ®ËÉÄÁ≥ªÊï∞',
                elasticConstants: 'ÂºπÊÄßÂ∏∏Êï∞',
                stressStrain: 'Â∫îÂäõ-Â∫îÂèòÊõ≤Á∫ø',
                youngsModulus: 'Êù®Ê∞èÊ®°Èáè',
                poissonsRatio: 'Ê≥äÊùæÊØî',
                vacancyEnergy: 'Á©∫‰ΩçÂΩ¢ÊàêËÉΩ',
                interstitialEnergy: 'Èó¥ÈöôÂΩ¢ÊàêËÉΩ',
                stackingFault: 'Â±ÇÈîôËÉΩ'
              }
            }
          };
          
          // Global state
          let allData = [];
          let currentType = 'all';
          let currentProperty = 'structure';
          let currentLang = localStorage.getItem('lang') || 'en';
          
          // Load the API mock
          const script = document.createElement('script');
          script.src = './api-mock.js';
          document.head.appendChild(script);
          
          script.onload = function() {
            initApp();
          };
          
          // Translation function
          function t(key) {
            const keys = key.split('.');
            let value = translations[currentLang];
            for (const k of keys) {
              value = value[k];
              if (!value) return key;
            }
            return value;
          }
          
          // Update UI text
          function updateUIText() {
            document.getElementById('title').textContent = t('title');
            document.getElementById('subtitle').textContent = t('subtitle');
            document.getElementById('searchBtnText').textContent = t('search');
            document.getElementById('exportBtnText').textContent = t('export.execute');
            document.getElementById('q').placeholder = t('searchPlaceholder');
            document.getElementById('infoText').textContent = t('infoText');
            document.getElementById('typeTitle').textContent = t('typeTitle');
            document.getElementById('propertyTitle').textContent = t('propertyTitle');
            document.getElementById('loading').textContent = t('loading');
            document.getElementById('githubLink').textContent = t('githubLink');
            document.getElementById('docsLink').textContent = t('docsLink');
            document.getElementById('updateLabel').textContent = t('updateLabel');
            document.getElementById('langText').textContent = currentLang === 'en' ? '‰∏≠Êñá' : 'English';
            
            // Export dialog translations
            if (document.getElementById('exportTitle')) {
              document.getElementById('exportTitle').textContent = t('export.title');
              document.getElementById('exportFormatTitle').textContent = t('export.format');
              document.getElementById('exportRangeTitle').textContent = t('export.range');
              document.getElementById('exportPropsTitle').textContent = t('export.properties');
              document.getElementById('jsonDesc').textContent = t('export.jsonDesc');
              document.getElementById('csvDesc').textContent = t('export.csvDesc');
              document.getElementById('rangeAll').textContent = t('export.allMaterials');
              document.getElementById('rangeFiltered').textContent = t('export.filteredResults');
              document.getElementById('rangeSelected').textContent = t('export.selectedMaterials');
              document.getElementById('selectorSearch').placeholder = t('export.searchPlaceholder');
              document.getElementById('propStructureLabel').textContent = t('export.structure');
              document.getElementById('propThermodynamicsLabel').textContent = t('export.thermodynamics');
              document.getElementById('propMechanicsLabel').textContent = t('export.mechanics');
              document.getElementById('propDefectsLabel').textContent = t('export.defects');
              document.getElementById('exportExecuteBtn').textContent = t('export.execute');
              document.getElementById('exportCancelBtn').textContent = t('export.cancel');
            }
            
            // Update data-i18n elements
            document.querySelectorAll('[data-i18n]').forEach(el => {
              el.textContent = t(el.dataset.i18n);
            });
            
            // Update date format
            const dateOptions = currentLang === 'zh' ? 
              { year: 'numeric', month: '2-digit', day: '2-digit', locale: 'zh-CN' } :
              { year: 'numeric', month: 'short', day: 'numeric', locale: 'en-US' };
            document.getElementById('updateTime').textContent = new Date().toLocaleDateString(
              currentLang === 'zh' ? 'zh-CN' : 'en-US'
            );
            
            // Update HTML lang attribute
            document.documentElement.lang = currentLang === 'zh' ? 'zh-CN' : 'en';
            
            // Re-render table if data is loaded
            if (allData.length > 0) {
              filterAndDisplay();
            }
          }
          
          // V2 Data Helper Functions
          
          // Format composition with subscript numbers (Al2Cu4 ‚Üí Al‚ÇÇCu‚ÇÑ, a-Al2Cu3 ‚Üí a-Al‚ÇÇCu‚ÇÉ)
          function formatComposition(composition) {
            if (!composition) return '-';
            const subscripts = ['‚ÇÄ','‚ÇÅ','‚ÇÇ','‚ÇÉ','‚ÇÑ','‚ÇÖ','‚ÇÜ','‚Çá','‚Çà','‚Çâ'];
            // Handle interface notation (A/B or A2B3/C4D5)
            if (composition.includes('/')) {
              return composition.split('/').map(part => {
                // Preserve a- prefix for amorphous
                const hasPrefix = part.startsWith('a-');
                const comp = hasPrefix ? part.substring(2) : part;
                const formatted = comp.replace(/(\d+)/g, (match) => {
                  return match.split('').map(d => subscripts[parseInt(d)]).join('');
                });
                return hasPrefix ? 'a-' + formatted : formatted;
              }).join('/');
            }
            // Handle amorphous prefix
            if (composition.startsWith('a-')) {
              const comp = composition.substring(2);
              return 'a-' + comp.replace(/(\d+)/g, (match) => {
                return match.split('').map(d => subscripts[parseInt(d)]).join('');
              });
            }
            // Regular composition
            return composition.replace(/(\d+)/g, (match) => {
              return match.split('').map(d => subscripts[parseInt(d)]).join('');
            });
          }
          
          // Get primary data (0K) for display
          // Priority: 0K DFT > 0K DPA-3 > 0K DPA-1 > other 0K > first entry
          function getPrimaryData(material) {
            if (!material.data || material.data.length === 0) return null;
            // Priority: 0K DFT > 0K DPA-3 > 0K DPA-1 > other 0K > first entry
            let primary = material.data.find(d => d.temperature === 0 && d.source === 'DFT');
            if (!primary) {
              primary = material.data.find(d => d.temperature === 0 && d.source === 'DPA-3');
            }
            if (!primary) {
              primary = material.data.find(d => d.temperature === 0 && d.source === 'DPA-1');
            }
            if (!primary) {
              primary = material.data.find(d => d.temperature === 0);
            }
            if (!primary) {
              primary = material.data[0]; // Fallback to first entry
            }
            return primary;
          }
          
          // Get all secondary data (non-primary temperatures/sources), sorted by source then temperature
          function getSecondaryData(material) {
            if (!material.data || material.data.length <= 1) return [];
            const primary = getPrimaryData(material);
            const secondary = material.data.filter(d => d !== primary);
            
            // Sort by source (DFT > DPA-3 > DPA-1 > others) then by temperature (ascending)
            const sourceOrder = { 'DFT': 1, 'DPA-3': 2, 'DPA-1': 3 };
            secondary.sort((a, b) => {
              const orderA = sourceOrder[a.source] || 99;
              const orderB = sourceOrder[b.source] || 99;
              if (orderA !== orderB) {
                return orderA - orderB;
              }
              return a.temperature - b.temperature;
            });
            
            return secondary;
          }
          
          // Check if material has data for V2 format
          function hasV2Data(material) {
            return material.data && Array.isArray(material.data) && material.data.length > 0;
          }
          
          // Normalize material to V2 format (convert old format if needed)
          function normalizeMaterial(material) {
            // If already V2 format, return as is
            if (hasV2Data(material)) {
              return material;
            }
            
            // Convert V1 format to V2 format
            return {
              id: material.id,
              name: material.name,
              type: material.type,
              composition: material.elements ? material.elements.join('') : '',
              elements: material.elements || [],
              atomCount: {},
              data: [{
                temperature: 0,
                source: 'DFT',
                properties: {
                  structure: material.structure || {},
                  thermodynamics: material.thermodynamics || {},
                  mechanics: material.mechanics || {},
                  defects: material.defects || {}
                }
              }]
            };
          }
          
          // Filter by element composition
          function matchesElementFilter(material, query) {
            if (!query) return true;
            
            const cleanQuery = query.trim().toLowerCase();
            if (!cleanQuery) return true;
            
            // Check if it's a composition query (contains digits)
            if (/\d/.test(cleanQuery)) {
              // Match exact composition
              const materialComp = material.composition ? material.composition.toLowerCase() : '';
              return materialComp.includes(cleanQuery);
            }
            
            // Simple element filter - check if material contains the element
            return material.elements && material.elements.some(el => 
              el.toLowerCase().includes(cleanQuery)
            );
          }
          
          async function initApp() {
            // Load all data
            const response = await fetch('./data/materials.json');
            const rawData = await response.json();
            
            // Normalize all materials to V2 format
            allData = rawData.map(m => normalizeMaterial(m));
            
            // Initialize UI text
            updateUIText();
            
            // Bind events
            document.getElementById('search').onclick = () => filterAndDisplay();
            document.getElementById('q').addEventListener('keypress', function(e) {
              if (e.key === 'Enter') filterAndDisplay();
            });
            
            // Language toggle
            document.getElementById('langToggle').addEventListener('click', function() {
              currentLang = currentLang === 'en' ? 'zh' : 'en';
              localStorage.setItem('lang', currentLang);
              updateUIText();
            });
            
            // Material type tabs
            document.querySelectorAll('.type-tab').forEach(tab => {
              tab.addEventListener('click', function() {
                document.querySelectorAll('.type-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentType = this.dataset.type;
                filterAndDisplay();
              });
            });
            
            // Property category tabs
            document.querySelectorAll('.property-tab').forEach(tab => {
              tab.addEventListener('click', function() {
                document.querySelectorAll('.property-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentProperty = this.dataset.property;
                filterAndDisplay();
              });
            });
            
            // Initial display
            filterAndDisplay();
            
            // Event delegation for material detail links
            document.getElementById('table').addEventListener('click', function(e) {
              // Find closest material-link (handles clicks on child elements)
              const link = e.target.closest('.material-link');
              if (link) {
                e.preventDefault();
                const materialId = link.getAttribute('data-id');
                showDetail(materialId);
              }
            });
            
            // Export button
            document.getElementById('exportBtn').addEventListener('click', function() {
              openExportDialog();
            });
          }
          
          function filterAndDisplay() {
            const searchTerm = document.getElementById('q').value.toLowerCase();
            
            // Filter data
            let filtered = allData;
            
            // Filter by type
            if (currentType !== 'all') {
              filtered = filtered.filter(item => item.type === currentType);
            }
            
            // Filter by search term (name or element composition)
            if (searchTerm) {
              filtered = filtered.filter(item => {
                const matchesName = item.name.toLowerCase().includes(searchTerm);
                const matchesElement = matchesElementFilter(item, searchTerm);
                return matchesName || matchesElement;
              });
            }
            
            displayResults(filtered);
          }
          
          function displayResults(data) {
            const container = document.getElementById('table');
            
            if (data.length === 0) {
              container.innerHTML = '<p class="no-data">' + t('noData') + '</p>';
              return;
            }
            
            // Calculate total data points (accounting for multi-temperature/source)
            let totalDataPoints = 0;
            data.forEach(material => {
              if (material.data && Array.isArray(material.data)) {
                totalDataPoints += material.data.length;
              } else {
                totalDataPoints += 1; // V1 format
              }
            });
            
            const countText = currentLang === 'en' 
              ? `Found ${data.length} materials with ${totalDataPoints} data points`
              : `ÊâæÂà∞ ${data.length} ÁßçÊùêÊñôÔºåÂÖ± ${totalDataPoints} Êù°Êï∞ÊçÆ`;
            
            let html = '<div class="result-count">' + countText + '</div>';
            
            // Display different tables based on selected property category
            if (currentProperty === 'structure') {
              html += displayStructureTable(data);
            } else if (currentProperty === 'thermodynamics') {
              html += displayThermodynamicsTable(data);
            } else if (currentProperty === 'mechanics') {
              html += displayMechanicsTable(data);
            } else if (currentProperty === 'defects') {
              html += displayDefectsTable(data);
            }
            
            container.innerHTML = html;
          }
          
          function displayStructureTable(data) {
            let html = '<div class="data-note">';
            html += currentLang === 'en' ? 
              'Note: Values shown are at 0K unless specified. Click row to expand other temperatures.' :
              'Ê≥®ÔºöÊòæÁ§∫Êï∞ÂÄº‰∏∫0K‰∏ãÁöÑÊï∞ÊçÆÔºàÈô§ÈùûÂè¶ÊúâËØ¥ÊòéÔºâ„ÄÇÁÇπÂáªË°åÂèØÂ±ïÂºÄÂÖ∂‰ªñÊ∏©Â∫¶Êï∞ÊçÆ„ÄÇ';
            html += '</div>';
            
            html += '<div class="table-wrapper"><table><thead><tr>';
            html += '<th style="width:30px"></th>'; // Expand toggle
            html += '<th>' + t('table.id') + '</th>';
            html += '<th>' + t('table.name') + '</th>';
            html += '<th>' + t('table.type') + '</th>';
            html += '<th>' + (currentLang === 'en' ? 'Composition' : 'ÂÖÉÁ¥†ÁªÑÊàê') + '</th>';
            html += '<th>' + t('table.density') + '<br/>(g/cm¬≥)</th>';
            html += '<th>' + (currentLang === 'en' ? 'Lattice Params' : 'Êô∂Ê†ºÂèÇÊï∞') + '</th>';
            html += '<th>' + t('table.rdf') + '</th>';
            html += '</tr></thead><tbody>';
            
            for (const material of data) {
              const primary = getPrimaryData(material);
              const secondary = getSecondaryData(material);
              const hasSecondary = secondary.length > 0;
              
              if (!primary) continue;
              
              const props = primary.properties || {};
              const struct = props.structure || {};
              
              // Main row
              html += '<tr class="material-row" data-id="' + material.id + '">';
              
              // Expand toggle
              html += '<td class="expand-cell">';
              if (hasSecondary) {
                html += '<button class="expand-btn" onclick="toggleExpand(this)">‚ñ∂</button>';
              }
              html += '</td>';
              
              html += '<td>' + material.id + '</td>';
              html += '<td><a href="#" class="material-link" data-id="' + material.id + '">' + material.name + '</a></td>';
              html += '<td>' + translateType(material.type) + '</td>';
              html += '<td class="composition">' + formatComposition(material.composition) + '</td>';
              html += '<td>' + formatValue(struct.density, 3);
              if (hasSecondary) html += ' <span class="data-meta">(0K, ' + primary.source + ')</span>';
              html += '</td>';
              
              // Lattice parameters with dropdown
              html += '<td class="lattice-cell">';
              const lattice = struct.latticeParameters;
              if (lattice && lattice.pointGroup) {
                html += '<div class="lattice-display">';
                html += '<span class="point-group">' + lattice.pointGroup + '</span>';
                html += '<button class="lattice-expand" onclick="toggleLattice(this, event)">‚ñº</button>';
                html += '</div>';
                html += '<div class="lattice-details hidden">';
                if (lattice.a) html += '<div>a = ' + formatValue(lattice.a, 3) + ' √Ö</div>';
                if (lattice.b) html += '<div>b = ' + formatValue(lattice.b, 3) + ' √Ö</div>';
                if (lattice.c) html += '<div>c = ' + formatValue(lattice.c, 3) + ' √Ö</div>';
                if (lattice.alpha) html += '<div>Œ± = ' + formatValue(lattice.alpha, 1) + '¬∞</div>';
                if (lattice.beta) html += '<div>Œ≤ = ' + formatValue(lattice.beta, 1) + '¬∞</div>';
                if (lattice.gamma) html += '<div>Œ≥ = ' + formatValue(lattice.gamma, 1) + '¬∞</div>';
                html += '</div>';
              } else {
                html += '-';
              }
              html += '</td>';
              
              html += '<td>' + formatFile(struct.rdf) + '</td>';
              html += '</tr>';
              
              // Expanded row for secondary data
              if (hasSecondary) {
                // Collect unique temperatures and sources from ALL data
                const allDataPoints = [primary, ...secondary];
                const temperatures = [...new Set(allDataPoints.map(d => d.temperature))].sort((a, b) => a - b);
                const sources = [...new Set(allDataPoints.map(d => d.source))].sort();
                
                html += '<tr class="expanded-row hidden" data-parent-id="' + material.id + '">';
                html += '<td colspan="100%"><div class="expanded-content">';
                
                // Add selectors for temperature and source
                html += '<div class="expanded-selectors">';
                html += '<div class="selector-group">';
                html += '<label>' + (currentLang === 'en' ? 'Temperature:' : 'Ê∏©Â∫¶:') + '</label>';
                html += '<select class="expanded-temp-select" onchange="filterExpandedRows(this, \'structure\', ' + material.id + ')">';
                html += '<option value="all">' + (currentLang === 'en' ? 'All' : 'ÂÖ®ÈÉ®') + '</option>';
                temperatures.forEach(temp => {
                  html += '<option value="' + temp + '">' + temp + 'K</option>';
                });
                html += '</select>';
                html += '</div>';
                html += '<div class="selector-group">';
                html += '<label>' + (currentLang === 'en' ? 'Source:' : 'Êù•Ê∫ê:') + '</label>';
                html += '<select class="expanded-source-select" onchange="filterExpandedRows(this, \'structure\', ' + material.id + ')">';
                html += '<option value="all">' + (currentLang === 'en' ? 'All' : 'ÂÖ®ÈÉ®') + '</option>';
                sources.forEach(src => {
                  html += '<option value="' + src + '">' + src + '</option>';
                });
                html += '</select>';
                html += '</div>';
                html += '</div>';
                
                html += '<table class="sub-table" data-material-id="' + material.id + '"><thead><tr>';
                html += '<th>' + (currentLang === 'en' ? 'Temperature' : 'Ê∏©Â∫¶') + '</th>';
                html += '<th>' + (currentLang === 'en' ? 'Source' : 'Êï∞ÊçÆÊù•Ê∫ê') + '</th>';
                html += '<th>' + t('table.density') + '</th>';
                html += '<th>' + (currentLang === 'en' ? 'Lattice' : 'Êô∂Ê†º') + '</th>';
                html += '<th>' + t('table.rdf') + '</th>';
                html += '</tr></thead><tbody>';
                
                for (const dataPoint of allDataPoints) {
                  const p = dataPoint.properties || {};
                  const s = p.structure || {};
                  const lattice = s.latticeParameters;
                  html += '<tr data-temperature="' + dataPoint.temperature + '" data-source="' + dataPoint.source + '">';
                  html += '<td>' + dataPoint.temperature + 'K</td>';
                  html += '<td>' + dataPoint.source + '</td>';
                  html += '<td>' + formatValue(s.density, 3) + '</td>';
                  
                  // Lattice with dropdown
                  html += '<td class="lattice-cell">';
                  if (lattice && lattice.pointGroup) {
                    html += '<div class="lattice-display">';
                    html += '<span class="point-group">' + lattice.pointGroup + '</span>';
                    html += '<button class="lattice-expand" onclick="toggleLattice(this, event)">‚ñº</button>';
                    html += '</div>';
                    html += '<div class="lattice-details hidden">';
                    if (lattice.a) html += '<div>a = ' + formatValue(lattice.a, 3) + ' √Ö</div>';
                    if (lattice.b) html += '<div>b = ' + formatValue(lattice.b, 3) + ' √Ö</div>';
                    if (lattice.c) html += '<div>c = ' + formatValue(lattice.c, 3) + ' √Ö</div>';
                    if (lattice.alpha) html += '<div>Œ± = ' + formatValue(lattice.alpha, 1) + '¬∞</div>';
                    if (lattice.beta) html += '<div>Œ≤ = ' + formatValue(lattice.beta, 1) + '¬∞</div>';
                    if (lattice.gamma) html += '<div>Œ≥ = ' + formatValue(lattice.gamma, 1) + '¬∞</div>';
                    html += '</div>';
                  } else {
                    html += '-';
                  }
                  html += '</td>';
                  
                  html += '<td>' + formatFile(s.rdf) + '</td>';
                  html += '</tr>';
                }
                
                html += '</tbody></table></div></td></tr>';
              }
            }
            
            html += '</tbody></table></div>';
            return html;
          }
          
          function displayThermodynamicsTable(data) {
            let html = '<div class="data-note">';
            html += currentLang === 'en' ? 
              'Note: Values shown are at 0K unless specified. Click row to expand other temperatures.' :
              'Ê≥®ÔºöÊòæÁ§∫Êï∞ÂÄº‰∏∫0K‰∏ãÁöÑÊï∞ÊçÆÔºàÈô§ÈùûÂè¶ÊúâËØ¥ÊòéÔºâ„ÄÇÁÇπÂáªË°åÂèØÂ±ïÂºÄÂÖ∂‰ªñÊ∏©Â∫¶Êï∞ÊçÆ„ÄÇ';
            html += '</div>';
            
            html += '<div class="table-wrapper"><table><thead><tr>';
            html += '<th style="width:30px"></th>';
            html += '<th>' + t('table.id') + '</th>';
            html += '<th>' + t('table.name') + '</th>';
            html += '<th>' + t('table.type') + '</th>';
            html += '<th>' + (currentLang === 'en' ? 'Composition' : 'ÂÖÉÁ¥†ÁªÑÊàê') + '</th>';
            html += '<th>' + t('table.specificHeat') + '<br/>(J/kg¬∑K)</th>';
            html += '<th>' + t('table.mixingEnthalpy') + '<br/>(kJ/mol)</th>';
            html += '<th>' + t('table.diffusionCoeff') + '<br/>(m¬≤/s)</th>';
            html += '<th>' + t('table.thermalExpansion') + '<br/>(10‚Åª‚Å∂/K)</th>';
            html += '</tr></thead><tbody>';
            
            for (const material of data) {
              const primary = getPrimaryData(material);
              const secondary = getSecondaryData(material);
              const hasSecondary = secondary.length > 0;
              
              if (!primary) continue;
              
              const props = primary.properties || {};
              const thermo = props.thermodynamics || {};
              
              html += '<tr class="material-row" data-id="' + material.id + '">';
              
              html += '<td class="expand-cell">';
              if (hasSecondary) {
                html += '<button class="expand-btn" onclick="toggleExpand(this)">‚ñ∂</button>';
              }
              html += '</td>';
              
              html += '<td>' + material.id + '</td>';
              html += '<td><a href="#" class="material-link" data-id="' + material.id + '">' + material.name + '</a></td>';
              html += '<td>' + translateType(material.type) + '</td>';
              html += '<td class="composition">' + formatComposition(material.composition) + '</td>';
              html += '<td>' + formatValue(thermo.specificHeat, 2);
              if (hasSecondary) html += ' <span class="data-meta">(0K, ' + primary.source + ')</span>';
              html += '</td>';
              html += '<td>' + formatValue(thermo.mixingEnthalpy, 2) + '</td>';
              html += '<td>' + formatScientific(thermo.diffusionCoefficient) + '</td>';
              html += '<td>' + formatScientific(thermo.thermalExpansion) + '</td>';
              html += '</tr>';
              
              if (hasSecondary) {
                const allDataPoints = [primary, ...secondary];
                const temperatures = [...new Set(allDataPoints.map(d => d.temperature))].sort((a, b) => a - b);
                const sources = [...new Set(allDataPoints.map(d => d.source))].sort();
                
                html += '<tr class="expanded-row hidden" data-parent-id="' + material.id + '">';
                html += '<td colspan="100%"><div class="expanded-content">';
                
                html += '<div class="expanded-selectors">';
                html += '<div class="selector-group">';
                html += '<label>' + (currentLang === 'en' ? 'Temperature:' : 'Ê∏©Â∫¶:') + '</label>';
                html += '<select class="expanded-temp-select" onchange="filterExpandedRows(this, \'thermodynamics\', ' + material.id + ')">';
                html += '<option value="all">' + (currentLang === 'en' ? 'All' : 'ÂÖ®ÈÉ®') + '</option>';
                temperatures.forEach(temp => {
                  html += '<option value="' + temp + '">' + temp + 'K</option>';
                });
                html += '</select>';
                html += '</div>';
                html += '<div class="selector-group">';
                html += '<label>' + (currentLang === 'en' ? 'Source:' : 'Êù•Ê∫ê:') + '</label>';
                html += '<select class="expanded-source-select" onchange="filterExpandedRows(this, \'thermodynamics\', ' + material.id + ')">';
                html += '<option value="all">' + (currentLang === 'en' ? 'All' : 'ÂÖ®ÈÉ®') + '</option>';
                sources.forEach(src => {
                  html += '<option value="' + src + '">' + src + '</option>';
                });
                html += '</select>';
                html += '</div>';
                html += '</div>';
                
                html += '<table class="sub-table" data-material-id="' + material.id + '"><thead><tr>';
                html += '<th>' + (currentLang === 'en' ? 'Temperature' : 'Ê∏©Â∫¶') + '</th>';
                html += '<th>' + (currentLang === 'en' ? 'Source' : 'Êï∞ÊçÆÊù•Ê∫ê') + '</th>';
                html += '<th>' + t('table.specificHeat') + '</th>';
                html += '<th>' + t('table.mixingEnthalpy') + '</th>';
                html += '<th>' + t('table.diffusionCoeff') + '</th>';
                html += '<th>' + t('table.thermalExpansion') + '</th>';
                html += '</tr></thead><tbody>';
                
                for (const dataPoint of allDataPoints) {
                  const p = dataPoint.properties || {};
                  const th = p.thermodynamics || {};
                  html += '<tr data-temperature="' + dataPoint.temperature + '" data-source="' + dataPoint.source + '">';
                  html += '<td>' + dataPoint.temperature + 'K</td>';
                  html += '<td>' + dataPoint.source + '</td>';
                  html += '<td>' + formatValue(th.specificHeat, 2) + '</td>';
                  html += '<td>' + formatValue(th.mixingEnthalpy, 2) + '</td>';
                  html += '<td>' + formatScientific(th.diffusionCoefficient) + '</td>';
                  html += '<td>' + formatScientific(th.thermalExpansion) + '</td>';
                  html += '</tr>';
                }
                
                html += '</tbody></table></div></td></tr>';
              }
            }
            
            html += '</tbody></table></div>';
            return html;
          }
          
          function displayMechanicsTable(data) {
            let html = '<div class="data-note">';
            html += currentLang === 'en' ? 
              'Note: Values shown are at 0K unless specified. Click row to expand other temperatures. Click elastic constants to view full Cij matrix.' :
              'Ê≥®ÔºöÊòæÁ§∫Êï∞ÂÄº‰∏∫0K‰∏ãÁöÑÊï∞ÊçÆÔºàÈô§ÈùûÂè¶ÊúâËØ¥ÊòéÔºâ„ÄÇÁÇπÂáªË°åÂèØÂ±ïÂºÄÂÖ∂‰ªñÊ∏©Â∫¶Êï∞ÊçÆ„ÄÇÁÇπÂáªÂºπÊÄßÂ∏∏Êï∞ÂèØÊü•ÁúãÂÆåÊï¥CijÁü©Èòµ„ÄÇ';
            html += '</div>';
            
            html += '<div class="table-wrapper"><table><thead><tr>';
            html += '<th style="width:30px"></th>';
            html += '<th>' + t('table.id') + '</th>';
            html += '<th>' + t('table.name') + '</th>';
            html += '<th>' + t('table.type') + '</th>';
            html += '<th>' + (currentLang === 'en' ? 'Composition' : 'ÂÖÉÁ¥†ÁªÑÊàê') + '</th>';
            html += '<th>' + (currentLang === 'en' ? 'Elastic (GPa)' : 'ÂºπÊÄßÂ∏∏Êï∞') + '</th>';
            html += '<th>' + t('table.youngsModulus') + '<br/>(GPa)</th>';
            html += '<th>' + t('table.poissonsRatio') + '</th>';
            html += '<th>' + t('table.stressStrain') + '</th>';
            html += '</tr></thead><tbody>';
            
            for (const material of data) {
              const primary = getPrimaryData(material);
              const secondary = getSecondaryData(material);
              const hasSecondary = secondary.length > 0;
              
              if (!primary) continue;
              
              const props = primary.properties || {};
              const mech = props.mechanics || {};
              const elastic = mech.elasticConstants;
              
              html += '<tr class="material-row" data-id="' + material.id + '">';
              
              html += '<td class="expand-cell">';
              if (hasSecondary) {
                html += '<button class="expand-btn" onclick="toggleExpand(this)">‚ñ∂</button>';
              }
              html += '</td>';
              
              html += '<td>' + material.id + '</td>';
              html += '<td><a href="#" class="material-link" data-id="' + material.id + '">' + material.name + '</a></td>';
              html += '<td>' + translateType(material.type) + '</td>';
              html += '<td class="composition">' + formatComposition(material.composition) + '</td>';
              
              // Elastic constants with matrix view
              html += '<td class="elastic-cell">';
              if (elastic && elastic.matrix) {
                html += '<div class="elastic-display">';
                html += '<span>C‚ÇÅ‚ÇÅ=' + formatValue(elastic.matrix[0][0], 1) + '</span>';
                html += '<button class="matrix-expand" onclick="toggleMatrix(this, event)">üìä</button>';
                html += '</div>';
                html += '<div class="matrix-details hidden"><table class="cij-matrix">';
                for (let i = 0; i < 6; i++) {
                  html += '<tr>';
                  for (let j = 0; j < 6; j++) {
                    const val = elastic.matrix[i][j];
                    html += '<td>' + formatValue(val, 1) + '</td>';
                  }
                  html += '</tr>';
                }
                html += '</table></div>';
              } else {
                html += '-';
              }
              html += '</td>';
              
              html += '<td>' + formatValue(mech.youngsModulus, 2);
              if (hasSecondary) html += ' <span class="data-meta">(0K, ' + primary.source + ')</span>';
              html += '</td>';
              html += '<td>' + formatValue(mech.poissonsRatio, 3) + '</td>';
              html += '<td>' + formatFile(mech.stressStrain) + '</td>';
              html += '</tr>';
              
              if (hasSecondary) {
                const allDataPoints = [primary, ...secondary];
                const temperatures = [...new Set(allDataPoints.map(d => d.temperature))].sort((a, b) => a - b);
                const sources = [...new Set(allDataPoints.map(d => d.source))].sort();
                
                html += '<tr class="expanded-row hidden" data-parent-id="' + material.id + '">';
                html += '<td colspan="100%"><div class="expanded-content">';
                
                html += '<div class="expanded-selectors">';
                html += '<div class="selector-group">';
                html += '<label>' + (currentLang === 'en' ? 'Temperature:' : 'Ê∏©Â∫¶:') + '</label>';
                html += '<select class="expanded-temp-select" onchange="filterExpandedRows(this, \'mechanics\', ' + material.id + ')">';
                html += '<option value="all">' + (currentLang === 'en' ? 'All' : 'ÂÖ®ÈÉ®') + '</option>';
                temperatures.forEach(temp => {
                  html += '<option value="' + temp + '">' + temp + 'K</option>';
                });
                html += '</select>';
                html += '</div>';
                html += '<div class="selector-group">';
                html += '<label>' + (currentLang === 'en' ? 'Source:' : 'Êù•Ê∫ê:') + '</label>';
                html += '<select class="expanded-source-select" onchange="filterExpandedRows(this, \'mechanics\', ' + material.id + ')">';
                html += '<option value="all">' + (currentLang === 'en' ? 'All' : 'ÂÖ®ÈÉ®') + '</option>';
                sources.forEach(src => {
                  html += '<option value="' + src + '">' + src + '</option>';
                });
                html += '</select>';
                html += '</div>';
                html += '</div>';
                
                html += '<table class="sub-table" data-material-id="' + material.id + '"><thead><tr>';
                html += '<th>' + (currentLang === 'en' ? 'Temperature' : 'Ê∏©Â∫¶') + '</th>';
                html += '<th>' + (currentLang === 'en' ? 'Source' : 'Êï∞ÊçÆÊù•Ê∫ê') + '</th>';
                html += '<th>' + (currentLang === 'en' ? 'Elastic' : 'ÂºπÊÄßÂ∏∏Êï∞') + '</th>';
                html += '<th>' + t('table.youngsModulus') + '</th>';
                html += '<th>' + t('table.poissonsRatio') + '</th>';
                html += '<th>' + t('table.stressStrain') + '</th>';
                html += '</tr></thead><tbody>';
                
                for (const dataPoint of allDataPoints) {
                  const p = dataPoint.properties || {};
                  const m = p.mechanics || {};
                  const elastic = m.elasticConstants;
                  html += '<tr data-temperature="' + dataPoint.temperature + '" data-source="' + dataPoint.source + '">';
                  html += '<td>' + dataPoint.temperature + 'K</td>';
                  html += '<td>' + dataPoint.source + '</td>';
                  
                  // Elastic constants with matrix view
                  html += '<td class="elastic-cell">';
                  if (elastic && elastic.matrix) {
                    html += '<div class="elastic-display">';
                    html += '<span>C‚ÇÅ‚ÇÅ=' + formatValue(elastic.matrix[0][0], 1) + '</span>';
                    html += '<button class="matrix-expand" onclick="toggleMatrix(this, event)">üìä</button>';
                    html += '</div>';
                    html += '<div class="matrix-details hidden"><table class="cij-matrix">';
                    for (let i = 0; i < 6; i++) {
                      html += '<tr>';
                      for (let j = 0; j < 6; j++) {
                        const val = elastic.matrix[i][j];
                        html += '<td>' + formatValue(val, 1) + '</td>';
                      }
                      html += '</tr>';
                    }
                    html += '</table></div>';
                  } else {
                    html += '-';
                  }
                  html += '</td>';
                  
                  html += '<td>' + formatValue(m.youngsModulus, 2) + '</td>';
                  html += '<td>' + formatValue(m.poissonsRatio, 3) + '</td>';
                  html += '<td>' + formatFile(m.stressStrain) + '</td>';
                  html += '</tr>';
                }
                
                html += '</tbody></table></div></td></tr>';
              }
            }
            
            html += '</tbody></table></div>';
            return html;
          }
          
          function displayDefectsTable(data) {
            let html = '<div class="data-note">';
            html += currentLang === 'en' ? 
              'Note: Values shown are at 0K unless specified. Click row to expand other temperatures. Interstitial shows all sites.' :
              'Ê≥®ÔºöÊòæÁ§∫Êï∞ÂÄº‰∏∫0K‰∏ãÁöÑÊï∞ÊçÆÔºàÈô§ÈùûÂè¶ÊúâËØ¥ÊòéÔºâ„ÄÇÁÇπÂáªË°åÂèØÂ±ïÂºÄÂÖ∂‰ªñÊ∏©Â∫¶Êï∞ÊçÆ„ÄÇÈó¥ÈöôËÉΩÊòæÁ§∫ÊâÄÊúâ‰ΩçÁÇπ„ÄÇ';
            html += '</div>';
            
            html += '<div class="table-wrapper"><table><thead><tr>';
            html += '<th style="width:30px"></th>';
            html += '<th>' + t('table.id') + '</th>';
            html += '<th>' + t('table.name') + '</th>';
            html += '<th>' + t('table.type') + '</th>';
            html += '<th>' + (currentLang === 'en' ? 'Composition' : 'ÂÖÉÁ¥†ÁªÑÊàê') + '</th>';
            html += '<th>' + t('table.vacancyEnergy') + '<br/>(eV)</th>';
            html += '<th>' + t('table.interstitialEnergy') + '<br/>(eV)</th>';
            html += '<th>' + t('table.stackingFault') + '<br/>(mJ/m¬≤)</th>';
            html += '</tr></thead><tbody>';
            
            for (const material of data) {
              const primary = getPrimaryData(material);
              const secondary = getSecondaryData(material);
              const hasSecondary = secondary.length > 0;
              
              if (!primary) continue;
              
              const props = primary.properties || {};
              const defects = props.defects || {};
              
              html += '<tr class="material-row" data-id="' + material.id + '">';
              
              html += '<td class="expand-cell">';
              if (hasSecondary) {
                html += '<button class="expand-btn" onclick="toggleExpand(this)">‚ñ∂</button>';
              }
              html += '</td>';
              
              html += '<td>' + material.id + '</td>';
              html += '<td><a href="#" class="material-link" data-id="' + material.id + '">' + material.name + '</a></td>';
              html += '<td>' + translateType(material.type) + '</td>';
              html += '<td class="composition">' + formatComposition(material.composition) + '</td>';
              html += '<td>' + formatValue(defects.vacancyFormationEnergy, 3);
              if (hasSecondary) html += ' <span class="data-meta">(0K, ' + primary.source + ')</span>';
              html += '</td>';
              
              // Interstitial with multiple sites
              html += '<td class="interstitial-cell">';
              if (defects.interstitialFormationEnergy) {
                if (typeof defects.interstitialFormationEnergy === 'object') {
                  // Multiple sites
                  const sites = Object.keys(defects.interstitialFormationEnergy);
                  html += '<div class="interstitial-display">';
                  html += '<span>' + sites[0] + ': ' + formatValue(defects.interstitialFormationEnergy[sites[0]], 3) + '</span>';
                  if (sites.length > 1) {
                    html += '<button class="sites-expand" onclick="toggleSites(this, event)">‚ñº</button>';
                    html += '<div class="sites-details hidden">';
                    for (const site of sites.slice(1)) {
                      html += '<div>' + site + ': ' + formatValue(defects.interstitialFormationEnergy[site], 3) + ' eV</div>';
                    }
                    html += '</div>';
                  }
                  html += '</div>';
                } else {
                  html += formatValue(defects.interstitialFormationEnergy, 3);
                }
              } else {
                html += '-';
              }
              html += '</td>';
              
              html += '<td>' + formatValue(defects.stackingFaultEnergy, 2) + '</td>';
              html += '</tr>';
              
              if (hasSecondary) {
                const allDataPoints = [primary, ...secondary];
                const temperatures = [...new Set(allDataPoints.map(d => d.temperature))].sort((a, b) => a - b);
                const sources = [...new Set(allDataPoints.map(d => d.source))].sort();
                
                html += '<tr class="expanded-row hidden" data-parent-id="' + material.id + '">';
                html += '<td colspan="100%"><div class="expanded-content">';
                
                html += '<div class="expanded-selectors">';
                html += '<div class="selector-group">';
                html += '<label>' + (currentLang === 'en' ? 'Temperature:' : 'Ê∏©Â∫¶:') + '</label>';
                html += '<select class="expanded-temp-select" onchange="filterExpandedRows(this, \'defects\', ' + material.id + ')">';
                html += '<option value="all">' + (currentLang === 'en' ? 'All' : 'ÂÖ®ÈÉ®') + '</option>';
                temperatures.forEach(temp => {
                  html += '<option value="' + temp + '">' + temp + 'K</option>';
                });
                html += '</select>';
                html += '</div>';
                html += '<div class="selector-group">';
                html += '<label>' + (currentLang === 'en' ? 'Source:' : 'Êù•Ê∫ê:') + '</label>';
                html += '<select class="expanded-source-select" onchange="filterExpandedRows(this, \'defects\', ' + material.id + ')">';
                html += '<option value="all">' + (currentLang === 'en' ? 'All' : 'ÂÖ®ÈÉ®') + '</option>';
                sources.forEach(src => {
                  html += '<option value="' + src + '">' + src + '</option>';
                });
                html += '</select>';
                html += '</div>';
                html += '</div>';
                
                html += '<table class="sub-table" data-material-id="' + material.id + '"><thead><tr>';
                html += '<th>' + (currentLang === 'en' ? 'Temperature' : 'Ê∏©Â∫¶') + '</th>';
                html += '<th>' + (currentLang === 'en' ? 'Source' : 'Êï∞ÊçÆÊù•Ê∫ê') + '</th>';
                html += '<th>' + t('table.vacancyEnergy') + '</th>';
                html += '<th>' + t('table.interstitialEnergy') + '</th>';
                html += '<th>' + t('table.stackingFault') + '</th>';
                html += '</tr></thead><tbody>';
                
                for (const dataPoint of allDataPoints) {
                  const p = dataPoint.properties || {};
                  const d = p.defects || {};
                  html += '<tr data-temperature="' + dataPoint.temperature + '" data-source="' + dataPoint.source + '">';
                  html += '<td>' + dataPoint.temperature + 'K</td>';
                  html += '<td>' + dataPoint.source + '</td>';
                  html += '<td>' + formatValue(d.vacancyFormationEnergy, 3) + '</td>';
                  html += '<td>';
                  if (typeof d.interstitialFormationEnergy === 'object') {
                    const sites = Object.keys(d.interstitialFormationEnergy);
                    html += sites.map(s => s + ':' + formatValue(d.interstitialFormationEnergy[s], 3)).join(', ');
                  } else {
                    html += formatValue(d.interstitialFormationEnergy, 3);
                  }
                  html += '</td>';
                  html += '<td>' + formatValue(d.stackingFaultEnergy, 2) + '</td>';
                  html += '</tr>';
                }
                
                html += '</tbody></table></div></td></tr>';
              }
            }
            
            html += '</tbody></table></div>';
            return html;
          }
          
          function formatValue(val, decimals = 2) {
            if (val === null || val === undefined) return '-';
            if (typeof val === 'number') return val.toFixed(decimals);
            return val;
          }
          
          function formatScientific(val) {
            if (val === null || val === undefined) return '-';
            if (typeof val === 'number') return val.toExponential(2);
            return val;
          }
          
          function formatFile(file) {
            if (!file) return '-';
            const filename = file.split('/').pop();
            return '<a href="' + file + '" target="_blank">üìÑ ' + filename + '</a>';
          }
          
          function translateType(type) {
            const typeMap = {
              en: {
                'element': 'Element',
                'solid-solution': 'Solid Solution',
                'intermetallic': 'Intermetallic',
                'amorphous': 'Amorphous',
                'interface': 'Interface',
                'crystalline': 'Crystalline'
              },
              zh: {
                'element': 'ÂçïË¥®',
                'solid-solution': 'Âõ∫Ê∫∂‰Ωì',
                'intermetallic': 'ÈáëÂ±ûÈó¥ÂåñÂêàÁâ©',
                'amorphous': 'ÈùûÊô∂ÊÄÅ',
                'interface': 'ÁïåÈù¢',
                'crystalline': 'Êô∂ÊÄÅ'
              }
            };
            return typeMap[currentLang][type] || type;
          }
          
          // Toggle row expansion for multi-temperature data
          window.toggleExpand = function(btn) {
            const mainRow = btn.closest('tr');
            const materialId = mainRow.dataset.id;
            const expandedRow = document.querySelector('.expanded-row[data-parent-id="' + materialId + '"]');
            
            if (expandedRow) {
              const isExpanded = !expandedRow.classList.contains('hidden');
              expandedRow.classList.toggle('hidden');
              btn.textContent = isExpanded ? '‚ñ∂' : '‚ñº';
            }
          };
          
          // Toggle lattice parameters dropdown
          window.toggleLattice = function(btn, event) {
            event.stopPropagation();
            const cell = btn.closest('.lattice-cell');
            const details = cell.querySelector('.lattice-details');
            if (details) {
              details.classList.toggle('hidden');
              btn.textContent = details.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
            }
          };
          
          // Toggle Cij matrix display
          window.toggleMatrix = function(btn, event) {
            event.stopPropagation();
            const cell = btn.closest('.elastic-cell');
            const details = cell.querySelector('.matrix-details');
            if (details) {
              details.classList.toggle('hidden');
              btn.textContent = details.classList.contains('hidden') ? 'üìä' : '‚úñ';
            }
          };
          
          // Toggle interstitial sites display
          window.toggleSites = function(btn, event) {
            event.stopPropagation();
            const display = btn.closest('.interstitial-display');
            const details = display.querySelector('.sites-details');
            if (details) {
              details.classList.toggle('hidden');
              btn.textContent = details.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
            }
          };
          
          // Filter expanded rows by temperature and/or source
          window.filterExpandedRows = function(selectElement, tableType, materialId) {
            const expandedRow = selectElement.closest('.expanded-content');
            const tempSelect = expandedRow.querySelector('.expanded-temp-select');
            const sourceSelect = expandedRow.querySelector('.expanded-source-select');
            const table = expandedRow.querySelector('.sub-table[data-material-id="' + materialId + '"]');
            
            if (!table || !tempSelect || !sourceSelect) return;
            
            const selectedTemp = tempSelect.value;
            const selectedSource = sourceSelect.value;
            
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
              const rowTemp = row.getAttribute('data-temperature');
              const rowSource = row.getAttribute('data-source');
              
              let showRow = true;
              if (selectedTemp !== 'all' && rowTemp !== selectedTemp) {
                showRow = false;
              }
              if (selectedSource !== 'all' && rowSource !== selectedSource) {
                showRow = false;
              }
              
              row.style.display = showRow ? '' : 'none';
            });
          };
          
          // View 3D structure from expandable row
          window.view3DStructure = function(materialId, temperature, source) {
            const material = allData.find(m => m.id == materialId);
            if (!material) return;
            
            // Find the specific data point
            let dataPoint;
            if (temperature && source) {
              dataPoint = material.data.find(d => 
                d.temperature == temperature && d.source === source
              );
            }
            
            // If not found or no filters, use primary data
            if (!dataPoint) {
              dataPoint = getPrimaryData(material);
            }
            
            if (!dataPoint) return;
            
            // Open detail modal
            showDetail(materialId);
            
            // Wait for modal to render, then scroll to 3D viewer
            setTimeout(() => {
              const viewerContainer = document.querySelector('.structure-viewer-container');
              if (viewerContainer) {
                viewerContainer.scrollIntoView({ 
                  behavior: 'smooth', 
                  block: 'center' 
                });
              }
            }, 300);
          };
          
          // Show material detail in modal
          window.showDetail = function(materialId) {
            const material = allData.find(m => m.id == materialId);
            if (!material) return;
            
            const modal = document.getElementById('detailModal');
            const content = document.getElementById('detailContent');
            
            const primary = getPrimaryData(material);
            if (!primary) {
              content.innerHTML = '<p>No data available for this material.</p>';
              modal.style.display = 'block';
              return;
            }
            
            const props = primary.properties || {};
            
            let html = '<h2>' + material.name + '</h2>';
            
            // Data Source Selector for multi-temperature/source
            if (material.data && material.data.length > 1) {
              // Get unique temperatures and sources
              const temperatures = [...new Set(material.data.map(d => d.temperature))].sort((a, b) => a - b);
              const sources = [...new Set(material.data.map(d => d.source))].sort();
              
              html += '<div class="data-selector">';
              
              // Temperature selector
              html += '<div class="selector-group">';
              html += '<label>' + (currentLang === 'en' ? 'Temperature:' : 'Ê∏©Â∫¶:') + '</label>';
              html += '<select id="tempSelect-' + materialId + '" onchange="filterDetailData(\'' + materialId + '\', \'temp\')">';
              html += '<option value="all">' + (currentLang === 'en' ? 'All' : 'ÂÖ®ÈÉ®') + '</option>';
              temperatures.forEach(temp => {
                html += '<option value="' + temp + '">' + temp + 'K</option>';
              });
              html += '</select>';
              html += '</div>';
              
              // Source selector
              html += '<div class="selector-group">';
              html += '<label>' + (currentLang === 'en' ? 'Source:' : 'Êù•Ê∫ê:') + '</label>';
              html += '<select id="sourceSelect-' + materialId + '" onchange="filterDetailData(\'' + materialId + '\', \'source\')">';
              html += '<option value="all">' + (currentLang === 'en' ? 'All' : 'ÂÖ®ÈÉ®') + '</option>';
              sources.forEach(src => {
                html += '<option value="' + src + '">' + src + '</option>';
              });
              html += '</select>';
              html += '</div>';
              
              html += '</div>';
            }
            
            html += '<div id="detailDataView">';
            html += generateDetailView(material, primary);
            html += '</div>';
            
            content.innerHTML = html;
            modal.style.display = 'block';
            
            // Initialize 3D viewer if POSCAR exists
            const struct = primary.properties?.structure;
            if (struct && struct.poscar) {
              setTimeout(() => init3DViewer(materialId, struct.poscar), 100);
            }
          };
          
          // Filter detail data by temperature or source
          window.filterDetailData = function(materialId, filterType) {
            const material = allData.find(m => m.id == materialId);
            if (!material) return;
            
            const tempSelect = document.getElementById('tempSelect-' + materialId);
            const sourceSelect = document.getElementById('sourceSelect-' + materialId);
            
            if (!tempSelect || !sourceSelect) return;
            
            const selectedTemp = tempSelect.value;
            const selectedSource = sourceSelect.value;
            
            // Filter data based on selections
            let filteredData = material.data;
            
            if (selectedTemp !== 'all') {
              filteredData = filteredData.filter(d => d.temperature == selectedTemp);
            }
            
            if (selectedSource !== 'all') {
              filteredData = filteredData.filter(d => d.source === selectedSource);
            }
            
            // Generate combined view for filtered data
            const container = document.getElementById('detailDataView');
            if (!container || filteredData.length === 0) return;
            
            // If multiple data points match, show them in sections
            let html = '';
            if (filteredData.length === 1) {
              html = generateDetailView(material, filteredData[0]);
            } else {
              filteredData.forEach((dataPoint, idx) => {
                html += '<div class="data-point-section">';
                html += '<h3 class="data-point-header">' + dataPoint.temperature + 'K, ' + dataPoint.source + '</h3>';
                html += generateDetailView(material, dataPoint);
                html += '</div>';
                if (idx < filteredData.length - 1) {
                  html += '<hr class="data-separator">';
                }
              });
            }
            
            container.innerHTML = html;
            
            // Re-initialize 3D viewers if needed
            filteredData.forEach(dp => {
              if (dp.properties?.structure?.poscar) {
                setTimeout(() => init3DViewer(materialId, dp.properties.structure.poscar), 100);
              }
            });
          };
          
          // Generate detail view for specific data point
          function generateDetailView(material, dataPoint) {
            const props = dataPoint.properties || {};
            let html = '';
            
            // Basic Information
            html += '<div class="detail-section">';
            html += '<h3>' + t('basicInfo') + '</h3>';
            html += '<div class="detail-grid">';
            html += '<div class="detail-item"><label>ID:</label><span>' + material.id + '</span></div>';
            html += '<div class="detail-item"><label>' + t('table.name') + ':</label><span>' + material.name + '</span></div>';
            html += '<div class="detail-item"><label>' + t('table.type') + ':</label><span>' + translateType(material.type) + '</span></div>';
            html += '<div class="detail-item"><label>' + (currentLang === 'en' ? 'Composition:' : 'ÂÖÉÁ¥†ÁªÑÊàê:') + '</label><span>' + formatComposition(material.composition) + '</span></div>';
            html += '<div class="detail-item"><label>' + (currentLang === 'en' ? 'Temperature:' : 'Ê∏©Â∫¶:') + '</label><span>' + dataPoint.temperature + ' K</span></div>';
            html += '<div class="detail-item"><label>' + (currentLang === 'en' ? 'Source:' : 'Êï∞ÊçÆÊù•Ê∫ê:') + '</label><span>' + dataPoint.source + '</span></div>';
            html += '</div></div>';
            
            // Structure Properties
            const struct = props.structure || {};
            html += '<div class="detail-section">';
            html += '<h3>' + t('structureInfo') + '</h3>';
            
            // POSCAR 3D Viewer
            if (struct.poscar) {
              html += '<div class="structure-viewer-container">';
              html += '<h4>' + (currentLang === 'en' ? 'Atomic Structure' : 'ÂéüÂ≠êÁªìÊûÑ') + '</h4>';
              html += '<div id="viewer-' + material.id + '" class="structure-viewer"></div>';
              html += '<div class="viewer-controls">';
              html += '<button onclick="resetView(\'' + material.id + '\')" class="viewer-btn">' + (currentLang === 'en' ? 'Reset View' : 'ÈáçÁΩÆËßÜËßí') + '</button>';
              html += '<button onclick="toggleStyle(\'' + material.id + '\')" class="viewer-btn">' + (currentLang === 'en' ? 'Toggle Style' : 'ÂàáÊç¢Ê†∑Âºè') + '</button>';
              html += '<a href="' + struct.poscar + '" download class="viewer-btn download-btn">' + (currentLang === 'en' ? 'Download POSCAR' : '‰∏ãËΩΩPOSCAR') + '</a>';
              html += '</div>';
              html += '</div>';
            }
            
            html += '<div class="detail-grid">';
            html += '<div class="detail-item"><label>' + t('table.density') + ':</label><span>' + formatValue(struct.density, 3) + ' g/cm¬≥</span></div>';
            if (struct.latticeParameters) {
              html += '<div class="detail-item"><label>' + (currentLang === 'en' ? 'Point Group:' : 'ÁÇπÁæ§:') + '</label><span>' + (struct.latticeParameters.pointGroup || '-') + '</span></div>';
              if (struct.latticeParameters.a) html += '<div class="detail-item"><label>a:</label><span>' + formatValue(struct.latticeParameters.a, 3) + ' √Ö</span></div>';
              if (struct.latticeParameters.b) html += '<div class="detail-item"><label>b:</label><span>' + formatValue(struct.latticeParameters.b, 3) + ' √Ö</span></div>';
              if (struct.latticeParameters.c) html += '<div class="detail-item"><label>c:</label><span>' + formatValue(struct.latticeParameters.c, 3) + ' √Ö</span></div>';
              if (struct.latticeParameters.alpha) html += '<div class="detail-item"><label>Œ±:</label><span>' + formatValue(struct.latticeParameters.alpha, 1) + '¬∞</span></div>';
              if (struct.latticeParameters.beta) html += '<div class="detail-item"><label>Œ≤:</label><span>' + formatValue(struct.latticeParameters.beta, 1) + '¬∞</span></div>';
              if (struct.latticeParameters.gamma) html += '<div class="detail-item"><label>Œ≥:</label><span>' + formatValue(struct.latticeParameters.gamma, 1) + '¬∞</span></div>';
            }
            html += '</div>';
            if (struct.rdf) {
              html += '<div class="chart-container">';
              html += '<h4>' + t('table.rdf') + '</h4>';
              html += renderChart(struct.rdf, 'rdf-' + material.id, 'RDF');
              html += '</div>';
            }
            html += '</div>';
            
            // Thermodynamics Properties
            const thermo = props.thermodynamics || {};
            html += '<div class="detail-section">';
            html += '<h3>' + t('thermoInfo') + '</h3>';
            html += '<div class="detail-grid">';
            html += '<div class="detail-item"><label>' + t('table.specificHeat') + ':</label><span>' + formatValue(thermo.specificHeat, 2) + ' J/kg¬∑K</span></div>';
            html += '<div class="detail-item"><label>' + t('table.mixingEnthalpy') + ':</label><span>' + formatValue(thermo.mixingEnthalpy, 2) + ' kJ/mol</span></div>';
            html += '<div class="detail-item"><label>' + t('table.diffusionCoeff') + ':</label><span>' + formatScientific(thermo.diffusionCoefficient) + ' m¬≤/s</span></div>';
            html += '<div class="detail-item"><label>' + t('table.thermalExpansion') + ':</label><span>' + formatScientific(thermo.thermalExpansion) + ' 10‚Åª‚Å∂/K</span></div>';
            html += '</div></div>';
            
            // Mechanics Properties
            const mech = props.mechanics || {};
            html += '<div class="detail-section">';
            html += '<h3>' + t('mechInfo') + '</h3>';
            html += '<div class="detail-grid">';
            html += '<div class="detail-item"><label>' + t('table.youngsModulus') + ':</label><span>' + formatValue(mech.youngsModulus, 2) + ' GPa</span></div>';
            html += '<div class="detail-item"><label>' + t('table.bulkModulus') + ':</label><span>' + formatValue(mech.bulkModulus, 2) + ' GPa</span></div>';
            html += '<div class="detail-item"><label>' + t('table.shearModulus') + ':</label><span>' + formatValue(mech.shearModulus, 2) + ' GPa</span></div>';
            html += '<div class="detail-item"><label>' + t('table.poissonsRatio') + ':</label><span>' + formatValue(mech.poissonsRatio, 3) + '</span></div>';
            html += '</div>';
            
            // Elastic Constants Matrix - support both array and object format
            const elasticMatrix = mech.elasticConstants?.matrix || mech.elasticConstants;
            if (elasticMatrix && Array.isArray(elasticMatrix)) {
              html += '<div class="elastic-constants-section">';
              html += '<h4>' + (currentLang === 'en' ? 'Elastic Constants Matrix C' : 'ÂºπÊÄßÂ∏∏Êï∞Áü©Èòµ C') + '<sub>ij</sub> (GPa)</h4>';
              html += '<table class="cij-matrix">';
              html += '<thead><tr><th></th>';
              for (let j = 1; j <= 6; j++) {
                html += '<th>C<sub>' + j + '</sub></th>';
              }
              html += '</tr></thead><tbody>';
              for (let i = 0; i < 6; i++) {
                html += '<tr><th>C<sub>' + (i+1) + '</sub></th>';
                for (let j = 0; j < 6; j++) {
                  const val = elasticMatrix[i] && elasticMatrix[i][j] !== undefined ? elasticMatrix[i][j] : 0;
                  html += '<td>' + formatValue(val, 1) + '</td>';
                }
                html += '</tr>';
              }
              html += '</tbody></table>';
              html += '</div>';
            }
            
            if (mech.stressStrain) {
              html += '<div class="chart-container">';
              html += '<h4>' + t('table.stressStrain') + '</h4>';
              html += renderChart(mech.stressStrain, 'stress-' + material.id, 'Stress-Strain');
              html += '</div>';
            }
            html += '</div>';
            
            // Defect Properties
            const defects = props.defects || {};
            html += '<div class="detail-section">';
            html += '<h3>' + t('defectInfo') + '</h3>';
            html += '<div class="detail-grid">';
            html += '<div class="detail-item"><label>' + t('table.vacancyEnergy') + ':</label><span>' + formatValue(defects.vacancyFormationEnergy, 3) + ' eV</span></div>';
            
            // Interstitial with multiple sites
            if (defects.interstitialFormationEnergy) {
              if (typeof defects.interstitialFormationEnergy === 'object') {
                html += '<div class="detail-item full-width"><label>' + t('table.interstitialEnergy') + ':</label><div class="sites-list">';
                for (const [site, energy] of Object.entries(defects.interstitialFormationEnergy)) {
                  html += '<div><strong>' + site + ':</strong> ' + formatValue(energy, 3) + ' eV</div>';
                }
                html += '</div></div>';
              } else {
                html += '<div class="detail-item"><label>' + t('table.interstitialEnergy') + ':</label><span>' + formatValue(defects.interstitialFormationEnergy, 3) + ' eV</span></div>';
              }
            }
            
            html += '<div class="detail-item"><label>' + t('table.stackingFault') + ':</label><span>' + formatValue(defects.stackingFaultEnergy, 2) + ' mJ/m¬≤</span></div>';
            html += '</div></div>';
            
            return html;
          }
          
          // Update detail view when user changes data source
          window.updateDetailView = function(materialId, dataIndex) {
            const material = allData.find(m => m.id == materialId);
            if (!material || !material.data[dataIndex]) return;
            
            const dataPoint = material.data[dataIndex];
            const viewDiv = document.getElementById('detailDataView');
            if (viewDiv) {
              viewDiv.innerHTML = generateDetailView(material, dataPoint);
              // Re-initialize 3D viewer if POSCAR exists
              const struct = dataPoint.properties?.structure;
              if (struct && struct.poscar) {
                setTimeout(() => init3DViewer(materialId, struct.poscar), 100);
              }
            }
          };
          
          // Initialize 3D molecular viewer
          let viewerInstances = {};
          let viewerStyles = {}; // Track current style for each viewer
          
          function init3DViewer(materialId, poscarUrl) {
            const viewerId = 'viewer-' + materialId;
            const element = document.getElementById(viewerId);
            if (!element) return;
            
            // Clean up existing viewer
            if (viewerInstances[materialId]) {
              element.innerHTML = '';
            }
            
            // Create viewer
            const config = { backgroundColor: 'white' };
            const viewer = $3Dmol.createViewer(element, config);
            viewerInstances[materialId] = viewer;
            viewerStyles[materialId] = 'sphere'; // Default style
            
            // Load POSCAR file
            fetch(poscarUrl)
              .then(response => response.text())
              .then(poscarData => {
                viewer.addModel(poscarData, 'vasp');
                viewer.setStyle({}, { sphere: { radius: 0.5 }, stick: { radius: 0.15 } });
                viewer.zoomTo();
                viewer.render();
              })
              .catch(error => {
                console.error('Error loading POSCAR:', error);
                element.innerHTML = '<p class="error-message">' + 
                  (currentLang === 'en' ? 'Failed to load structure file' : 'Êó†Ê≥ïÂä†ËΩΩÁªìÊûÑÊñá‰ª∂') + 
                  '</p>';
              });
          }
          
          // Reset viewer camera
          window.resetView = function(materialId) {
            const viewer = viewerInstances[materialId];
            if (viewer) {
              viewer.zoomTo();
              viewer.render();
            }
          };
          
          // Toggle visualization style
          window.toggleStyle = function(materialId) {
            const viewer = viewerInstances[materialId];
            if (!viewer) return;
            
            const currentStyle = viewerStyles[materialId] || 'sphere';
            let newStyle;
            
            if (currentStyle === 'sphere') {
              // Ball and stick
              viewer.setStyle({}, { sphere: { radius: 0.5 }, stick: { radius: 0.15 } });
              newStyle = 'ball-stick';
            } else if (currentStyle === 'ball-stick') {
              // Stick only
              viewer.setStyle({}, { stick: { radius: 0.2 } });
              newStyle = 'stick';
            } else if (currentStyle === 'stick') {
              // Lines
              viewer.setStyle({}, { line: {} });
              newStyle = 'line';
            } else {
              // Back to sphere
              viewer.setStyle({}, { sphere: { radius: 0.5 }, stick: { radius: 0.15 } });
              newStyle = 'sphere';
            }
            
            viewerStyles[materialId] = newStyle;
            viewer.render();
          };
          
          // Render chart (image or plot)
          function renderChart(data, id, title) {
            if (!data || data === '-') {
              return '<p class="no-data">' + t('noDataAvailable') + '</p>';
            }
            
            // If data is a URL (string), display as image
            if (typeof data === 'string') {
              return '<img src="' + data + '" alt="' + title + '" class="chart-image" />';
            }
            
            // If data is an array, create a simple plot
            if (Array.isArray(data)) {
              return '<canvas id="' + id + '" class="chart-canvas"></canvas><script>renderPlot("' + id + '", ' + JSON.stringify(data) + ', "' + title + '");</script>';
            }
            
            return '<p>' + t('noDataAvailable') + '</p>';
          }
          
          // Simple plot rendering using Canvas
          window.renderPlot = function(canvasId, data, title) {
            setTimeout(function() {
              const canvas = document.getElementById(canvasId);
              if (!canvas) return;
              
              const ctx = canvas.getContext('2d');
              const width = canvas.width = canvas.offsetWidth;
              const height = canvas.height = 300;
              
              // Clear canvas
              ctx.clearRect(0, 0, width, height);
              
              // Simple line plot
              ctx.strokeStyle = '#667eea';
              ctx.lineWidth = 2;
              ctx.beginPath();
              
              const padding = 40;
              const plotWidth = width - 2 * padding;
              const plotHeight = height - 2 * padding;
              
              const xStep = plotWidth / (data.length - 1);
              const yMin = Math.min(...data.map(d => d.y || d[1] || d));
              const yMax = Math.max(...data.map(d => d.y || d[1] || d));
              const yRange = yMax - yMin || 1;
              
              data.forEach((point, i) => {
                const y = typeof point === 'object' ? (point.y || point[1]) : point;
                const x = padding + i * xStep;
                const plotY = height - padding - ((y - yMin) / yRange) * plotHeight;
                
                if (i === 0) {
                  ctx.moveTo(x, plotY);
                } else {
                  ctx.lineTo(x, plotY);
                }
              });
              
              ctx.stroke();
              
              // Draw axes
              ctx.strokeStyle = '#333';
              ctx.lineWidth = 1;
              ctx.beginPath();
              ctx.moveTo(padding, padding);
              ctx.lineTo(padding, height - padding);
              ctx.lineTo(width - padding, height - padding);
              ctx.stroke();
              
              // Add labels
              ctx.fillStyle = '#333';
              ctx.font = '12px Arial';
              ctx.textAlign = 'center';
              ctx.fillText(title, width / 2, 20);
            }, 100);
          };
          
          // Export functionality
          let currentFilteredData = [];
          let selectedMaterials = new Set();
          
          function openExportDialog() {
            const modal = document.getElementById('exportModal');
            currentFilteredData = getCurrentFilteredData();
            
            // Update filtered count
            const filteredCountEl = document.getElementById('filteredCount');
            if (filteredCountEl) {
              filteredCountEl.textContent = `(${currentFilteredData.length} materials)`;
            }
            
            // Show/hide material selector based on selection
            document.querySelectorAll('input[name="exportRange"]').forEach(radio => {
              radio.addEventListener('change', function() {
                const selector = document.getElementById('materialSelector');
                if (this.value === 'selected') {
                  selector.classList.remove('hidden');
                  populateMaterialSelector();
                } else {
                  selector.classList.add('hidden');
                }
              });
            });
            
            modal.style.display = 'block';
          }
          
          function getCurrentFilteredData() {
            const searchTerm = document.getElementById('q').value.toLowerCase();
            let filtered = allData;
            
            if (currentType !== 'all') {
              filtered = filtered.filter(item => item.type === currentType);
            }
            
            if (searchTerm) {
              filtered = filtered.filter(item => {
                const matchesName = item.name.toLowerCase().includes(searchTerm);
                const matchesElement = matchesElementFilter(item, searchTerm);
                return matchesName || matchesElement;
              });
            }
            
            return filtered;
          }
          
          function populateMaterialSelector() {
            const listEl = document.getElementById('selectorList');
            listEl.innerHTML = '';
            
            allData.forEach(material => {
              const item = document.createElement('label');
              item.className = 'selector-item';
              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.value = material.id;
              checkbox.onchange = function() {
                if (this.checked) {
                  selectedMaterials.add(material.id);
                } else {
                  selectedMaterials.delete(material.id);
                }
              };
              
              item.appendChild(checkbox);
              item.appendChild(document.createTextNode(' ' + material.id + ' - ' + material.name));
              listEl.appendChild(item);
            });
            
            // Search functionality
            document.getElementById('selectorSearch').oninput = function() {
              const query = this.value.toLowerCase();
              document.querySelectorAll('.selector-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(query) ? 'block' : 'none';
              });
            };
          }
          
          function exportData() {
            const format = document.querySelector('input[name="exportFormat"]:checked').value;
            const range = document.querySelector('input[name="exportRange"]:checked').value;
            
            // Get data to export
            let dataToExport = [];
            if (range === 'all') {
              dataToExport = allData;
            } else if (range === 'filtered') {
              dataToExport = currentFilteredData;
            } else if (range === 'selected') {
              dataToExport = allData.filter(m => selectedMaterials.has(m.id));
            }
            
            if (dataToExport.length === 0) {
              alert(t('export.noDataToExport'));
              return;
            }
            
            // Get selected properties
            const includeStructure = document.getElementById('propStructure').checked;
            const includeThermodynamics = document.getElementById('propThermodynamics').checked;
            const includeMechanics = document.getElementById('propMechanics').checked;
            const includeDefects = document.getElementById('propDefects').checked;
            
            // Filter properties in each data point
            const filteredDataExport = dataToExport.map(material => {
              const newMaterial = {
                id: material.id,
                name: material.name,
                type: material.type,
                composition: material.composition,
                data: material.data.map(dp => {
                  const newDp = {
                    temperature: dp.temperature,
                    source: dp.source,
                    properties: {}
                  };
                  
                  if (includeStructure && dp.properties.structure) {
                    newDp.properties.structure = dp.properties.structure;
                  }
                  if (includeThermodynamics && dp.properties.thermodynamics) {
                    newDp.properties.thermodynamics = dp.properties.thermodynamics;
                  }
                  if (includeMechanics && dp.properties.mechanics) {
                    newDp.properties.mechanics = dp.properties.mechanics;
                  }
                  if (includeDefects && dp.properties.defects) {
                    newDp.properties.defects = dp.properties.defects;
                  }
                  
                  return newDp;
                })
              };
              return newMaterial;
            });
            
            // Export based on format
            if (format === 'json') {
              exportJSON(filteredDataExport);
            } else if (format === 'csv') {
              exportCSV(filteredDataExport);
            }
            
            // Close modal
            document.getElementById('exportModal').style.display = 'none';
          }
          
          function exportJSON(data) {
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'alloy_materials_' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          }
          
          // Download all POSCAR files as ZIP
          async function downloadAllPOSCAR() {
            const range = document.querySelector('input[name="exportRange"]:checked').value;
            
            // Get materials to export
            let materialsToExport = [];
            if (range === 'all') {
              materialsToExport = allData;
            } else if (range === 'filtered') {
              materialsToExport = currentFilteredData;
            } else if (range === 'selected') {
              materialsToExport = allData.filter(m => selectedMaterials.has(m.id));
            }
            
            // Collect all POSCAR files
            const poscarFiles = [];
            materialsToExport.forEach(material => {
              material.data.forEach(dataPoint => {
                const struct = dataPoint.properties?.structure;
                if (struct && struct.poscar) {
                  poscarFiles.push({
                    url: struct.poscar,
                    filename: `${material.id}_${material.name.replace(/[^a-zA-Z0-9]/g, '_')}_${dataPoint.temperature}K_${dataPoint.source}.vasp`
                  });
                }
              });
            });
            
            if (poscarFiles.length === 0) {
              alert(currentLang === 'en' ? 
                'No POSCAR files found in selected materials' : 
                'ÊâÄÈÄâÊùêÊñô‰∏≠Êú™ÊâæÂà∞POSCARÊñá‰ª∂');
              return;
            }
            
            // Check if JSZip is available
            if (typeof JSZip === 'undefined') {
              alert(currentLang === 'en' ? 
                'JSZip library not loaded. Please refresh the page.' : 
                'JSZipÂ∫ìÊú™Âä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢');
              return;
            }
            
            // Create ZIP file
            const zip = new JSZip();
            const poscarFolder = zip.folder('poscar');
            
            // Show progress
            const progressMsg = currentLang === 'en' ? 
              `Downloading ${poscarFiles.length} POSCAR files...` : 
              `Ê≠£Âú®‰∏ãËΩΩ ${poscarFiles.length} ‰∏™POSCARÊñá‰ª∂...`;
            
            const loadingEl = document.getElementById('loading');
            if (loadingEl) {
              loadingEl.textContent = progressMsg;
              loadingEl.style.display = 'block';
            }
            
            try {
              // Download all files
              const downloadPromises = poscarFiles.map(async file => {
                try {
                  const response = await fetch(file.url);
                  if (!response.ok) throw new Error(`Failed to fetch ${file.url}`);
                  const content = await response.text();
                  poscarFolder.file(file.filename, content);
                  return true;
                } catch (error) {
                  console.error(`Error downloading ${file.url}:`, error);
                  return false;
                }
              });
              
              await Promise.all(downloadPromises);
              
              // Generate ZIP
              const zipBlob = await zip.generateAsync({ type: 'blob' });
              
              // Download ZIP file
              const url = URL.createObjectURL(zipBlob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `poscar_files_${new Date().toISOString().split('T')[0]}.zip`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
              
              if (loadingEl) {
                loadingEl.textContent = currentLang === 'en' ? 
                  'Download complete!' : '‰∏ãËΩΩÂÆåÊàêÔºÅ';
                setTimeout(() => {
                  loadingEl.style.display = 'none';
                  loadingEl.textContent = 'Loading...';
                }, 2000);
              }
              
              // Close modal
              document.getElementById('exportModal').style.display = 'none';
              
            } catch (error) {
              console.error('Error creating ZIP:', error);
              alert(currentLang === 'en' ? 
                'Failed to create ZIP file' : 
                'ÂàõÂª∫ZIPÊñá‰ª∂Â§±Ë¥•');
              
              if (loadingEl) {
                loadingEl.style.display = 'none';
                loadingEl.textContent = 'Loading...';
              }
            }
          }
          
          function exportCSV(data) {
            // Flatten V2 data to CSV format (primary data only)
            const rows = [];
            const headers = [
              'ID', 'Name', 'Type', 'Composition',
              'Temperature', 'Source',
              'Density', 'PointGroup', 'a', 'b', 'c', 'alpha', 'beta', 'gamma',
              'SpecificHeat', 'MixingEnthalpy', 'DiffusionCoeff', 'ThermalExpansion',
              'YoungsModulus', 'PoissonsRatio',
              'VacancyEnergy', 'InterstitialEnergy', 'StackingFaultEnergy'
            ];
            rows.push(headers.join(','));
            
            data.forEach(material => {
              material.data.forEach(dp => {
                const row = [];
                row.push(material.id);
                row.push('"' + material.name + '"');
                row.push(material.type);
                row.push('"' + material.composition + '"');
                row.push(dp.temperature);
                row.push(dp.source);
                
                const props = dp.properties || {};
                const struct = props.structure || {};
                const thermo = props.thermodynamics || {};
                const mech = props.mechanics || {};
                const defects = props.defects || {};
                
                row.push(struct.density || '');
                row.push(struct.latticeParameters?.pointGroup || '');
                row.push(struct.latticeParameters?.a || '');
                row.push(struct.latticeParameters?.b || '');
                row.push(struct.latticeParameters?.c || '');
                row.push(struct.latticeParameters?.alpha || '');
                row.push(struct.latticeParameters?.beta || '');
                row.push(struct.latticeParameters?.gamma || '');
                row.push(thermo.specificHeat || '');
                row.push(thermo.mixingEnthalpy || '');
                row.push(thermo.diffusionCoefficient || '');
                row.push(thermo.thermalExpansion || '');
                row.push(mech.youngsModulus || '');
                row.push(mech.poissonsRatio || '');
                row.push(defects.vacancyFormationEnergy || '');
                row.push(typeof defects.interstitialFormationEnergy === 'object' ? 
                  JSON.stringify(defects.interstitialFormationEnergy) : 
                  (defects.interstitialFormationEnergy || ''));
                row.push(defects.stackingFaultEnergy || '');
                
                rows.push(row.join(','));
              });
            });
            
            const csvStr = rows.join('\n');
            const blob = new Blob([csvStr], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'alloy_materials_' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          }
          
          // Modal close handlers
          document.getElementById('modalClose').onclick = function() {
            document.getElementById('detailModal').style.display = 'none';
          };
          
          document.getElementById('exportModalClose').onclick = function() {
            document.getElementById('exportModal').style.display = 'none';
          };
          
          document.getElementById('executeExport').onclick = function() {
            exportData();
          };
          
          document.getElementById('cancelExport').onclick = function() {
            document.getElementById('exportModal').style.display = 'none';
          };
          
          window.onclick = function(event) {
            const detailModal = document.getElementById('detailModal');
            const exportModal = document.getElementById('exportModal');
            if (event.target === detailModal) {
              detailModal.style.display = 'none';
            }
            if (event.target === exportModal) {
              exportModal.style.display = 'none';
            }
          };
          EOF
      
      - name: Enhance index.html
        run: |
          cat > _site/index.html << 'EOF'
          <!doctype html>
          <html lang="zh-CN">
          <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width,initial-scale=1" />
            <title>Alloy Materials Database / ÂêàÈáëÊùêÊñôÊï∞ÊçÆÂ∫ì</title>
            <meta name="description" content="Alloy materials database - Primary focus: Al-Ni-Cu-Zr-Nb-Ta-W system" />
            <link rel="stylesheet" href="css/style.css" />
            <!-- 3Dmol.js for molecular visualization -->
            <script src="https://cdn.jsdelivr.net/npm/3dmol@latest/build/3Dmol-min.js"></script>
            <!-- JSZip for batch POSCAR download -->
            <script src="https://cdn.jsdelivr.net/npm/jszip@3/dist/jszip.min.js"></script>
          </head>
          <body>
            <header>
              <div class="header-content">
                <div>
                  <h1 id="title">7-Element Alloy Materials Database</h1>
                  <p class="subtitle" id="subtitle">Al-Ni-Cu-Zr-Nb-Ta-W System Material Properties</p>
                </div>
                <button id="langToggle" class="lang-toggle" title="Switch Language / ÂàáÊç¢ËØ≠Ë®Ä">
                  <span id="langText">‰∏≠Êñá</span>
                </button>
              </div>
            </header>
            
            <main>
              <!-- Search Panel -->
              <div class="search-panel">
                <div class="search-group">
                  <input id="q" placeholder="Search materials or elements..." />
                  <button id="search" class="btn-primary"><span id="searchBtnText">Search</span></button>
                  <button id="exportBtn" class="btn-export" title="Export data / ÂØºÂá∫Êï∞ÊçÆ"><span id="exportBtnText">üì• Export</span></button>
                </div>
                <div class="info-badge">
                  <span id="infoText">Tip: Select material type and property category, or use search to find specific materials</span>
                </div>
              </div>
              
              <!-- Material Type Selection -->
              <div class="tabs-container">
                <h3 id="typeTitle">Material Type</h3>
                <div class="tabs">
                  <button class="type-tab active" data-type="all"><span data-i18n="type.all">All</span></button>
                  <button class="type-tab" data-type="element"><span data-i18n="type.element">Element</span></button>
                  <button class="type-tab" data-type="solid-solution"><span data-i18n="type.solid-solution">Solid Solution</span></button>
                  <button class="type-tab" data-type="intermetallic"><span data-i18n="type.intermetallic">Intermetallic</span></button>
                  <button class="type-tab" data-type="amorphous"><span data-i18n="type.amorphous">Amorphous</span></button>
                  <button class="type-tab" data-type="interface"><span data-i18n="type.interface">Interface</span></button>
                </div>
              </div>
              
              <!-- Property Category Selection -->
              <div class="tabs-container">
                <h3 id="propertyTitle">Property Category</h3>
                <div class="tabs">
                  <button class="property-tab active" data-property="structure"><span data-i18n="property.structure">Structure</span></button>
                  <button class="property-tab" data-property="thermodynamics"><span data-i18n="property.thermodynamics">Thermodynamics</span></button>
                  <button class="property-tab" data-property="mechanics"><span data-i18n="property.mechanics">Mechanics</span></button>
                  <button class="property-tab" data-property="defects"><span data-i18n="property.defects">Defects</span></button>
                </div>
              </div>
              
              <!-- Data Display Area -->
              <div id="table" class="results-container">
                <p class="loading" id="loading">Loading...</p>
              </div>
            </main>
            
            <!-- Material Detail Modal -->
            <div id="detailModal" class="modal">
              <div class="modal-content">
                <span class="modal-close" id="modalClose">&times;</span>
                <div id="detailContent"></div>
              </div>
            </div>
            
            <!-- Export Dialog -->
            <div id="exportModal" class="modal">
              <div class="modal-content export-modal">
                <span class="modal-close" id="exportModalClose">&times;</span>
                <h2 id="exportTitle">Export Data / ÂØºÂá∫Êï∞ÊçÆ</h2>
                
                <div class="export-section">
                  <h3 id="exportFormatTitle">Export Format / ÂØºÂá∫Ê†ºÂºè</h3>
                  <div class="format-options">
                    <label class="format-option">
                      <input type="radio" name="exportFormat" value="json" checked />
                      <span>JSON</span>
                      <small id="jsonDesc">Complete data with full structure / ÂÆåÊï¥Êï∞ÊçÆÁªìÊûÑ</small>
                    </label>
                    <label class="format-option">
                      <input type="radio" name="exportFormat" value="csv" />
                      <span>CSV</span>
                      <small id="csvDesc">Spreadsheet format (primary data only) / Ë°®Ê†ºÊ†ºÂºèÔºà‰ªÖ‰∏ªÊï∞ÊçÆÔºâ</small>
                    </label>
                  </div>
                </div>
                
                <div class="export-section">
                  <h3 id="exportRangeTitle">Export Range / ÂØºÂá∫ËåÉÂõ¥</h3>
                  <div class="range-options">
                    <label class="range-option">
                      <input type="radio" name="exportRange" value="all" checked />
                      <span id="rangeAll">All materials</span>
                    </label>
                    <label class="range-option">
                      <input type="radio" name="exportRange" value="filtered" />
                      <span id="rangeFiltered">Current filtered results</span>
                      <small id="filteredCount">(0 materials)</small>
                    </label>
                    <label class="range-option">
                      <input type="radio" name="exportRange" value="selected" />
                      <span id="rangeSelected">Selected materials</span>
                    </label>
                  </div>
                  <div id="materialSelector" class="material-selector hidden">
                    <div class="selector-search">
                      <input type="text" id="selectorSearch" placeholder="Search to select..." />
                    </div>
                    <div class="selector-list" id="selectorList"></div>
                  </div>
                </div>
                
                <div class="export-section">
                  <h3 id="exportPropsTitle">Properties to Export / ÂØºÂá∫Â±ûÊÄß</h3>
                  <div class="props-options">
                    <label><input type="checkbox" id="propStructure" checked /> <span id="propStructureLabel">Structure</span></label>
                    <label><input type="checkbox" id="propThermodynamics" checked /> <span id="propThermodynamicsLabel">Thermodynamics</span></label>
                    <label><input type="checkbox" id="propMechanics" checked /> <span id="propMechanicsLabel">Mechanics</span></label>
                    <label><input type="checkbox" id="propDefects" checked /> <span id="propDefectsLabel">Defects</span></label>
                  </div>
                </div>
                
                <div class="export-actions">
                  <button id="executeExport" class="btn-primary"><span id="exportExecuteBtn">üì• Export</span></button>
                  <button id="downloadPOSCAR" class="btn-primary" onclick="downloadAllPOSCAR()"><span id="poscarDownloadBtn">üî¨ Download POSCAR (ZIP)</span></button>
                  <button id="cancelExport" class="btn-secondary"><span id="exportCancelBtn">Cancel</span></button>
                </div>
              </div>
            </div>
            
            <footer>
              <p>
                <a href="https://github.com/wqchen007/jkw-7element-alloy-database" target="_blank" id="githubLink">
                  GitHub Repository
                </a> | 
                <a href="https://github.com/wqchen007/jkw-7element-alloy-database/blob/main/README.md" target="_blank" id="docsLink">Documentation</a> |
                <span id="updateLabel">Data Updated:</span> <span id="updateTime"></span>
              </p>
            </footer>
            
            <script src="js/app.js"></script>
          </body>
          </html>
          EOF
      
      - name: Enhance CSS
        run: |
          cat > _site/css/style.css << 'EOF'
          * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
          }
          
          body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
          }
          
          header {
            background: white;
            border-radius: 12px;
            padding: 2em;
            margin-bottom: 2em;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
          }
          
          .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
          }
          
          .header-content > div {
            flex: 1;
            text-align: center;
          }
          
          .lang-toggle {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s;
            white-space: nowrap;
          }
          
          .lang-toggle:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
          }
          
          .lang-toggle:active {
            transform: translateY(0);
          }
          
          h1 {
            color: #667eea;
            margin-bottom: 0.5em;
            font-size: 2em;
          }
          
          .subtitle {
            color: #666;
            font-size: 1.1em;
          }
          
          main {
            background: white;
            border-radius: 12px;
            padding: 2em;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2em;
          }
          
          .search-panel {
            margin-bottom: 2em;
          }
          
          .search-group {
            display: flex;
            gap: 10px;
            margin-bottom: 1em;
          }
          
          input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
          }
          
          input:focus {
            outline: none;
            border-color: #667eea;
          }
          
          .btn-primary {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: 500;
          }
          
          .btn-primary:hover {
            background: #5568d3;
          }
          
          .btn-secondary {
            padding: 12px 24px;
            background: #e0e0e0;
            color: #333;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: 500;
          }
          
          .btn-secondary:hover {
            background: #d0d0d0;
          }
          
          .btn-export {
            padding: 12px 24px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            margin-left: 10px;
          }
          
          .btn-export:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
          }
          
          .info-badge {
            background: #f0f7ff;
            border-left: 4px solid #667eea;
            padding: 12px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #555;
          }
          
          .tabs-container {
            margin-bottom: 1.5em;
          }
          
          .tabs-container h3 {
            color: #667eea;
            margin-bottom: 0.8em;
            font-size: 1.1em;
          }
          
          .tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
          }
          
          .type-tab, .property-tab {
            padding: 10px 20px;
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95em;
            font-weight: 500;
          }
          
          .type-tab:hover, .property-tab:hover {
            background: #e8eeff;
            border-color: #667eea;
          }
          
          .type-tab.active, .property-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
          }
          
          .results-container {
            margin-top: 1.5em;
          }
          
          .result-count {
            margin-bottom: 1em;
            padding: 10px;
            background: #f0f7ff;
            border-radius: 6px;
            color: #667eea;
            font-weight: 500;
          }
          
          .table-wrapper {
            overflow-x: auto;
          }
          
          table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
            min-width: 800px;
          }
          
          thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
          }
          
          th {
            padding: 14px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
          }
          
          td {
            padding: 12px 10px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9em;
          }
          
          tr:hover {
            background: #f8f9fa;
          }
          
          tbody tr:nth-child(even) {
            background: #fafbfc;
          }
          
          tbody tr:nth-child(even):hover {
            background: #f0f2f5;
          }
          
          .loading, .no-data {
            text-align: center;
            padding: 3em 2em;
            color: #666;
            font-size: 1.1em;
          }
          
          .no-data {
            background: #fff3cd;
            border-radius: 8px;
            color: #856404;
          }
          
          footer {
            text-align: center;
            color: white;
            padding: 1em;
          }
          
          footer a {
            color: white;
            text-decoration: none;
            border-bottom: 1px solid rgba(255,255,255,0.5);
            transition: border-bottom-color 0.3s;
          }
          
          footer a:hover {
            border-bottom-color: white;
          }
          
          /* Ë°®Ê†ºÂÜÖÈìæÊé•Ê†∑Âºè */
          table a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
          }
          
          table a:hover {
            text-decoration: underline;
          }
          
          .material-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
          }
          
          .material-link:hover {
            color: #5568d3;
            text-decoration: underline;
          }
          
          .material-link:active {
            color: #4557c2;
          }
          
          /* V2 Features: Expandable Rows, Composition, Data Notes */
          .data-note {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 12px 16px;
            margin-bottom: 16px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #1565c0;
          }
          
          .composition {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 500;
            color: #333;
          }
          
          .poscar-icon {
            font-size: 1.3em;
            cursor: help;
            transition: transform 0.2s;
            display: inline-block;
          }
          
          .poscar-icon:hover {
            transform: scale(1.2);
          }
          
          .data-meta {
            font-size: 0.85em;
            color: #666;
            font-weight: normal;
          }
          
          /* Expandable Row System */
          .expand-cell {
            width: 30px;
            text-align: center;
            padding: 4px !important;
          }
          
          .expand-btn {
            background: transparent;
            border: none;
            font-size: 0.9em;
            cursor: pointer;
            color: #667eea;
            padding: 2px 6px;
            transition: transform 0.2s;
          }
          
          .expand-btn:hover {
            transform: scale(1.2);
          }
          
          .expanded-row {
            background: #f8f9fa;
          }
          
          .expanded-row.hidden {
            display: none;
          }
          
          .expanded-content {
            padding: 16px;
            border-top: 2px solid #e0e0e0;
          }
          
          .expanded-selectors {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
            padding: 12px;
            background: #f0f4ff;
            border-radius: 6px;
            border: 1px solid #d0d7e5;
          }
          
          .expanded-selectors .selector-group {
            display: flex;
            align-items: center;
            gap: 8px;
          }
          
          .expanded-selectors label {
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
            white-space: nowrap;
          }
          
          .expanded-selectors select {
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: white;
            font-size: 0.9em;
            cursor: pointer;
            min-width: 120px;
          }
          
          .expanded-selectors select:hover {
            border-color: #667eea;
          }
          
          .expanded-selectors select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
          }
          
          .sub-table {
            width: 100%;
            background: white;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
          }
          
          .sub-table th {
            background: #667eea;
            color: white;
            padding: 8px;
            font-size: 0.9em;
          }
          
          .sub-table td {
            padding: 8px;
            font-size: 0.9em;
            border-bottom: 1px solid #eee;
          }
          
          /* Lattice Parameters Dropdown */
          .lattice-cell {
            position: relative;
          }
          
          .lattice-display {
            display: flex;
            align-items: center;
            gap: 8px;
          }
          
          .point-group {
            font-weight: 600;
            color: #333;
          }
          
          .lattice-expand {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 0.8em;
            cursor: pointer;
            transition: background 0.2s;
          }
          
          .lattice-expand:hover {
            background: #5568d3;
          }
          
          .lattice-details {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            padding: 12px;
            z-index: 100;
            min-width: 150px;
            margin-top: 4px;
          }
          
          .lattice-details.hidden {
            display: none;
          }
          
          .lattice-details div {
            padding: 4px 0;
            font-size: 0.9em;
            color: #333;
          }
          
          /* Elastic Constants Matrix */
          .elastic-cell {
            position: relative;
          }
          
          .elastic-display {
            display: flex;
            align-items: center;
            gap: 8px;
          }
          
          .matrix-expand {
            background: transparent;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            padding: 2px 6px;
            transition: transform 0.2s;
          }
          
          .matrix-expand:hover {
            transform: scale(1.2);
          }
          
          .matrix-details {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
            padding: 16px;
            z-index: 200;
            margin-top: 8px;
          }
          
          .matrix-details.hidden {
            display: none;
          }
          
          .cij-matrix {
            border-collapse: separate;
            border-spacing: 0;
          }
          
          .cij-matrix td {
            border: 1px solid #ddd;
            padding: 6px 10px;
            text-align: center;
            font-size: 0.85em;
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
          }
          
          .cij-matrix tr:first-child td {
            background: #e3f2fd;
          }
          
          .cij-matrix td:first-child {
            background: #e3f2fd;
          }
          
          /* Interstitial Sites */
          .interstitial-cell {
            position: relative;
          }
          
          .interstitial-display {
            display: flex;
            align-items: center;
            gap: 8px;
          }
          
          .sites-expand {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 0.8em;
            cursor: pointer;
            transition: background 0.2s;
          }
          
          .sites-expand:hover {
            background: #5568d3;
          }
          
          .sites-details {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            padding: 12px;
            z-index: 100;
            min-width: 200px;
            margin-top: 4px;
          }
          
          .sites-details.hidden {
            display: none;
          }
          
          .sites-details div {
            padding: 4px 0;
            font-size: 0.9em;
            color: #333;
          }
          
          /* Modal Styles */
          .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            overflow: auto;
          }
          
          .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease-out;
          }
          
          @keyframes slideIn {
            from {
              transform: translateY(-50px);
              opacity: 0;
            }
            to {
              transform: translateY(0);
              opacity: 1;
            }
          }
          
          .modal-close {
            color: #aaa;
            float: right;
            font-size: 32px;
            font-weight: bold;
            padding: 10px 20px;
            cursor: pointer;
            transition: color 0.3s;
          }
          
          .modal-close:hover,
          .modal-close:focus {
            color: #667eea;
          }
          
          /* Export Modal */
          .export-modal {
            max-width: 800px;
            padding: 30px;
          }
          
          .export-modal h2 {
            color: #667eea;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
          }
          
          .export-section {
            margin-bottom: 25px;
          }
          
          .export-section h3 {
            color: #555;
            margin-bottom: 15px;
            font-size: 1.1em;
          }
          
          .format-options, .range-options, .props-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
          }
          
          .format-option, .range-option {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
          }
          
          .format-option:hover, .range-option:hover {
            border-color: #667eea;
            background: #f0f7ff;
          }
          
          .format-option input, .range-option input {
            margin-right: 12px;
            cursor: pointer;
          }
          
          .format-option span, .range-option span {
            font-weight: 500;
            color: #333;
          }
          
          .format-option small, .range-option small {
            display: block;
            color: #666;
            font-size: 0.85em;
            margin-top: 4px;
          }
          
          .props-options {
            flex-direction: row;
            flex-wrap: wrap;
          }
          
          .props-options label {
            padding: 10px 15px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
          }
          
          .props-options label:hover {
            border-color: #667eea;
            background: #f0f7ff;
          }
          
          .props-options input {
            margin-right: 8px;
            cursor: pointer;
          }
          
          .material-selector {
            margin-top: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
          }
          
          .material-selector.hidden {
            display: none;
          }
          
          .selector-search {
            padding: 12px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
          }
          
          .selector-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
          }
          
          .selector-list {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
          }
          
          .selector-item {
            display: block;
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.2s;
          }
          
          .selector-item:hover {
            background: #f0f7ff;
          }
          
          .selector-item input {
            margin-right: 10px;
          }
          
          .export-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
          }
          
          .export-actions button {
            flex: 1;
          }
          
          #detailContent {
            padding: 20px 30px 30px;
          }
          
          #detailContent h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
          }
          
          .detail-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
          }
          
          .detail-section h3 {
            color: #555;
            margin-bottom: 15px;
            font-size: 1.3em;
          }
          
          .detail-section h4 {
            color: #666;
            margin-top: 15px;
            margin-bottom: 10px;
          }
          
          .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
          }
          
          .detail-item {
            display: flex;
            align-items: baseline;
            padding: 10px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
          }
          
          .detail-item label {
            font-weight: 600;
            color: #667eea;
            min-width: 150px;
            margin-right: 10px;
          }
          
          .detail-item span {
            color: #333;
            word-break: break-word;
          }
          
          .detail-item.full-width {
            grid-column: 1 / -1;
            flex-direction: column;
          }
          
          .detail-item.full-width label {
            margin-bottom: 10px;
          }
          
          .sites-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
          }
          
          .sites-list div {
            padding: 8px 12px;
            background: #f0f0f0;
            border-radius: 4px;
          }
          
          .cij-matrix-large {
            margin-top: 10px;
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
          }
          
          .cij-matrix-large td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            font-size: 0.95em;
          }
          
          .cij-matrix-large tr:first-child td {
            background: #e3f2fd;
            font-weight: 600;
          }
          
          .cij-matrix-large td:first-child {
            background: #e3f2fd;
            font-weight: 600;
          }
          
          .data-selector {
            background: #fff9e6;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 20px;
          }
          
          .data-selector .selector-group {
            display: flex;
            align-items: center;
            gap: 10px;
          }
          
          .data-selector label {
            font-weight: 600;
            color: #333;
            white-space: nowrap;
          }
          
          .data-selector select {
            min-width: 120px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.95em;
            background: white;
            cursor: pointer;
          }
          
          .data-selector select:hover {
            border-color: #667eea;
          }
          
          .data-point-section {
            margin-bottom: 20px;
          }
          
          .data-point-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 1.1em;
          }
          
          .data-separator {
            margin: 30px 0;
            border: none;
            border-top: 2px dashed #ddd;
          }
          
          /* Elastic Constants Matrix */
          .elastic-constants-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
          }
          
          .elastic-constants-section h4 {
            color: #667eea;
            margin-bottom: 15px;
          }
          
          .cij-matrix {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          }
          
          .cij-matrix th {
            background: #667eea;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: 600;
          }
          
          .cij-matrix td {
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
          }
          
          .cij-matrix tbody tr:nth-child(even) {
            background: #f8f9fa;
          }
          
          .cij-matrix tbody tr:hover {
            background: #e3f2fd;
          }
          
          /* 3D Structure Viewer */
          .structure-viewer-container {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          }
          
          .structure-viewer-container h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: 600;
          }
          
          .structure-viewer {
            width: 100%;
            height: 500px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
            position: relative;
            overflow: hidden;
          }
          
          .viewer-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
          }
          
          .viewer-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
          }
          
          .viewer-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
          }
          
          .viewer-btn:active {
            transform: translateY(0);
          }
          
          .viewer-btn.download-btn {
            background: #4caf50;
          }
          
          .viewer-btn.download-btn:hover {
            background: #45a049;
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
          }
          
          .error-message {
            padding: 20px;
            text-align: center;
            color: #d32f2f;
            font-weight: 500;
          }
          
          .chart-container {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
          }
          
          .chart-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          }
          
          .chart-canvas {
            width: 100%;
            max-width: 800px;
            height: 300px;
            display: block;
            margin: 10px auto;
          }
          
          @media (max-width: 768px) {
            body {
              padding: 10px;
            }
            
            h1 {
              font-size: 1.5em;
            }
            
            .search-group {
              flex-direction: column;
            }
            
            .tabs {
              justify-content: flex-start;
            }
            
            .type-tab, .property-tab {
              flex: 1 1 auto;
              min-width: 100px;
              text-align: center;
            }
            
            table {
              font-size: 0.85em;
              min-width: 600px;
            }
            
            th, td {
              padding: 8px 6px;
            }
            
            .table-wrapper {
              border: 1px solid #e0e0e0;
              border-radius: 8px;
            }
            
            .modal-content {
              width: 95%;
              margin: 5% auto;
            }
            
            .detail-grid {
              grid-template-columns: 1fr;
            }
            
            .detail-item {
              flex-direction: column;
              align-items: flex-start;
            }
            
            .detail-item label {
              min-width: auto;
              margin-bottom: 5px;
            }
          }
          EOF
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
