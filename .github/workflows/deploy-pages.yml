name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
      - scaffold/frontend-backend-structure
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Check for real data
        id: check_data
        run: |
          if [ -f "real-data/materials.json" ]; then
            echo "has_real_data=true" >> $GITHUB_OUTPUT
            echo "Using real data from real-data/materials.json"
          else
            echo "has_real_data=false" >> $GITHUB_OUTPUT
            echo "No real data found, will generate sample data"
          fi
      
      - name: Generate sample data
        if: steps.check_data.outputs.has_real_data == 'false'
        run: |
          cd scripts
          node generate-sample-data.js
          echo "Generated sample data"
      
      - name: Use real data
        if: steps.check_data.outputs.has_real_data == 'true'
        run: |
          mkdir -p backend/data
          cp real-data/materials.json backend/data/materials.json
          echo "Copied real data to backend/data/"
      
      - name: Prepare deployment
        run: |
          mkdir -p _site
          cp -r frontend/* _site/
          cp -r backend/data _site/data
          
          # Create a simple API mock for GitHub Pages
          cat > _site/api-mock.js << 'EOF'
          // Simple client-side API mock for GitHub Pages
          async function loadMaterials() {
            const response = await fetch('./data/materials.json');
            return await response.json();
          }
          
          window.MaterialsAPI = {
            async search(query = {}) {
              const allData = await loadMaterials();
              let results = allData;
              
              // Filter by query string
              if (query.q) {
                const searchTerm = query.q.toLowerCase();
                results = results.filter(item => 
                  item.name.toLowerCase().includes(searchTerm) ||
                  item.elements.some(el => el.toLowerCase().includes(searchTerm))
                );
              }
              
              // Filter by type
              if (query.type) {
                results = results.filter(item => item.type === query.type);
              }
              
              // Filter by element
              if (query.element) {
                results = results.filter(item => item.elements.includes(query.element));
              }
              
              // Pagination
              const page = parseInt(query.page) || 1;
              const perPage = parseInt(query.per_page) || 25;
              const total = results.length;
              const start = (page - 1) * perPage;
              const end = start + perPage;
              
              return {
                total,
                page,
                per_page: perPage,
                results: results.slice(start, end)
              };
            },
            
            async getById(id) {
              const allData = await loadMaterials();
              return allData.find(item => item.id == id);
            }
          };
          EOF
      
      - name: Update frontend to use mock API
        run: |
          # Update app.js to use the mock API for GitHub Pages with i18n support
          cat > _site/js/app.js << 'EOF'
          // Internationalization
          const translations = {
            en: {
              title: 'Alloy Materials Database',
              subtitle: 'Material Properties (Primary: Al-Ni-Cu-Zr-Nb-Ta-W System)',
              elementNote: 'Note: Database supports elements beyond the primary 7-element system',
              search: 'Search',
              searchPlaceholder: 'Search materials or elements...',
              infoText: 'Tip: Select material type and property category, or use search to find specific materials',
              typeTitle: 'Material Type',
              propertyTitle: 'Property Category',
              loading: 'Loading...',
              noData: 'No matching data found',
              resultsCount: 'Found {count} results',
              githubLink: 'GitHub Repository',
              docsLink: 'Documentation',
              updateLabel: 'Data Updated:',
              viewDetails: 'View Details',
              closeDetails: 'Close',
              allProperties: 'All Properties',
              basicInfo: 'Basic Information',
              structureInfo: 'Structure Properties',
              thermoInfo: 'Thermodynamics Properties',
              mechInfo: 'Mechanics Properties',
              defectInfo: 'Defect Properties',
              noDataAvailable: 'No data available',
              plotData: 'Plot Data',
              type: {
                all: 'All',
                crystalline: 'Crystalline',
                amorphous: 'Amorphous',
                interface: 'Interface'
              },
              property: {
                structure: 'Structure',
                thermodynamics: 'Thermodynamics',
                mechanics: 'Mechanics',
                defects: 'Defects'
              },
              table: {
                id: 'ID',
                name: 'Name',
                type: 'Type',
                elements: 'Elements',
                density: 'Density',
                latticeA: 'Lattice a',
                latticeB: 'Lattice b',
                latticeC: 'Lattice c',
                rdf: 'RDF',
                specificHeat: 'Specific Heat',
                mixingEnthalpy: 'Mixing Enthalpy',
                diffusionCoeff: 'Diffusion Coeff.',
                thermalExpansion: 'Thermal Expansion',
                elasticConstants: 'Elastic Constants',
                stressStrain: 'Stress-Strain',
                youngsModulus: "Young's Modulus",
                poissonsRatio: "Poisson's Ratio",
                vacancyEnergy: 'Vacancy Energy',
                interstitialEnergy: 'Interstitial Energy',
                stackingFault: 'Stacking Fault'
              }
            },
            zh: {
              title: 'ÂêàÈáëÊùêÊñôÊï∞ÊçÆÂ∫ì',
              subtitle: 'ÊùêÊñôÊÄßËÉΩÊï∞ÊçÆÔºà‰∏ªË¶ÅÂÖ≥Ê≥®ÔºöAl-Ni-Cu-Zr-Nb-Ta-W ‰ΩìÁ≥ªÔºâ',
              elementNote: 'ËØ¥ÊòéÔºöÊï∞ÊçÆÂ∫ìÊîØÊåÅ‰∏ªË¶Å7ÂÖÉÁ¥†‰ΩìÁ≥ª‰πãÂ§ñÁöÑÂÖ∂‰ªñÂÖÉÁ¥†',
              search: 'ÊêúÁ¥¢',
              searchPlaceholder: 'ÊêúÁ¥¢ÊùêÊñôÂêçÁß∞ÊàñÂÖÉÁ¥†...',
              infoText: 'ÊèêÁ§∫ÔºöÈÄâÊã©ÊùêÊñôÁ±ªÂûãÂíåÊÄßË¥®ÂàÜÁ±ªÔºåÊàñ‰ΩøÁî®ÊêúÁ¥¢ÂäüËÉΩÊü•ÊâæÁâπÂÆöÊùêÊñô',
              typeTitle: 'ÊùêÊñôÁ±ªÂûã',
              propertyTitle: 'ÊÄßË¥®ÂàÜÁ±ª',
              loading: 'Âä†ËΩΩ‰∏≠...',
              noData: 'Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÊï∞ÊçÆ',
              resultsCount: 'ÊâæÂà∞ {count} Êù°ÁªìÊûú',
              githubLink: 'GitHub ‰ªìÂ∫ì',
              docsLink: '‰ΩøÁî®ËØ¥Êòé',
              updateLabel: 'Êï∞ÊçÆÊõ¥Êñ∞Êó∂Èó¥:',
              viewDetails: 'Êü•ÁúãËØ¶ÊÉÖ',
              closeDetails: 'ÂÖ≥Èó≠',
              allProperties: 'ÊâÄÊúâÊÄßË¥®',
              basicInfo: 'Âü∫Êú¨‰ø°ÊÅØ',
              structureInfo: 'ÁªìÊûÑÊÄßË¥®',
              thermoInfo: 'ÁÉ≠ÂäõÂ≠¶ÊÄßË¥®',
              mechInfo: 'ÂäõÂ≠¶ÊÄßËÉΩ',
              defectInfo: 'Áº∫Èô∑ÊÄßË¥®',
              noDataAvailable: 'Êó†Êï∞ÊçÆ',
              plotData: 'ÁªòÂà∂Êï∞ÊçÆ',
              type: {
                all: 'ÂÖ®ÈÉ®',
                crystalline: 'Êô∂ÊÄÅ',
                amorphous: 'ÈùûÊô∂ÊÄÅ',
                interface: 'ÁïåÈù¢'
              },
              property: {
                structure: 'ÁªìÊûÑ‰ø°ÊÅØ',
                thermodynamics: 'ÁÉ≠ÂäõÂ≠¶/Âä®ÂäõÂ≠¶',
                mechanics: 'ÂäõÂ≠¶ÊÄßËÉΩ',
                defects: 'Áº∫Èô∑ÊÄßË¥®'
              },
              table: {
                id: 'ID',
                name: 'ÂêçÁß∞',
                type: 'Á±ªÂûã',
                elements: 'ÂÖÉÁ¥†',
                density: 'ÂØÜÂ∫¶',
                latticeA: 'Êô∂Ê†ºÂ∏∏Êï∞ a',
                latticeB: 'Êô∂Ê†ºÂ∏∏Êï∞ b',
                latticeC: 'Êô∂Ê†ºÂ∏∏Êï∞ c',
                rdf: 'ÂæÑÂêëÂàÜÂ∏ÉÂáΩÊï∞',
                specificHeat: 'ÊØîÁÉ≠ÂÆπ',
                mixingEnthalpy: 'Ê∑∑ÂêàÁÑì',
                diffusionCoeff: 'Êâ©Êï£Á≥ªÊï∞',
                thermalExpansion: 'ÁÉ≠ËÜ®ËÉÄÁ≥ªÊï∞',
                elasticConstants: 'ÂºπÊÄßÂ∏∏Êï∞',
                stressStrain: 'Â∫îÂäõ-Â∫îÂèòÊõ≤Á∫ø',
                youngsModulus: 'Êù®Ê∞èÊ®°Èáè',
                poissonsRatio: 'Ê≥äÊùæÊØî',
                vacancyEnergy: 'Á©∫‰ΩçÂΩ¢ÊàêËÉΩ',
                interstitialEnergy: 'Èó¥ÈöôÂΩ¢ÊàêËÉΩ',
                stackingFault: 'Â±ÇÈîôËÉΩ'
              }
            }
          };
          
          // Global state
          let allData = [];
          let currentType = 'all';
          let currentProperty = 'structure';
          let currentLang = localStorage.getItem('lang') || 'en';
          
          // Load the API mock
          const script = document.createElement('script');
          script.src = './api-mock.js';
          document.head.appendChild(script);
          
          script.onload = function() {
            initApp();
          };
          
          // Translation function
          function t(key) {
            const keys = key.split('.');
            let value = translations[currentLang];
            for (const k of keys) {
              value = value[k];
              if (!value) return key;
            }
            return value;
          }
          
          // Update UI text
          function updateUIText() {
            document.getElementById('title').textContent = t('title');
            document.getElementById('subtitle').textContent = t('subtitle');
            document.getElementById('searchBtnText').textContent = t('search');
            document.getElementById('q').placeholder = t('searchPlaceholder');
            document.getElementById('infoText').textContent = t('infoText');
            document.getElementById('typeTitle').textContent = t('typeTitle');
            document.getElementById('propertyTitle').textContent = t('propertyTitle');
            document.getElementById('loading').textContent = t('loading');
            document.getElementById('githubLink').textContent = t('githubLink');
            document.getElementById('docsLink').textContent = t('docsLink');
            document.getElementById('updateLabel').textContent = t('updateLabel');
            document.getElementById('langText').textContent = currentLang === 'en' ? '‰∏≠Êñá' : 'English';
            
            // Update data-i18n elements
            document.querySelectorAll('[data-i18n]').forEach(el => {
              el.textContent = t(el.dataset.i18n);
            });
            
            // Update date format
            const dateOptions = currentLang === 'zh' ? 
              { year: 'numeric', month: '2-digit', day: '2-digit', locale: 'zh-CN' } :
              { year: 'numeric', month: 'short', day: 'numeric', locale: 'en-US' };
            document.getElementById('updateTime').textContent = new Date().toLocaleDateString(
              currentLang === 'zh' ? 'zh-CN' : 'en-US'
            );
            
            // Update HTML lang attribute
            document.documentElement.lang = currentLang === 'zh' ? 'zh-CN' : 'en';
            
            // Re-render table if data is loaded
            if (allData.length > 0) {
              filterAndDisplay();
            }
          }
          
          async function initApp() {
            // Load all data
            const response = await fetch('./data/materials.json');
            allData = await response.json();
            
            // Initialize UI text
            updateUIText();
            
            // Bind events
            document.getElementById('search').onclick = () => filterAndDisplay();
            document.getElementById('q').addEventListener('keypress', function(e) {
              if (e.key === 'Enter') filterAndDisplay();
            });
            
            // Language toggle
            document.getElementById('langToggle').addEventListener('click', function() {
              currentLang = currentLang === 'en' ? 'zh' : 'en';
              localStorage.setItem('lang', currentLang);
              updateUIText();
            });
            
            // Material type tabs
            document.querySelectorAll('.type-tab').forEach(tab => {
              tab.addEventListener('click', function() {
                document.querySelectorAll('.type-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentType = this.dataset.type;
                filterAndDisplay();
              });
            });
            
            // Property category tabs
            document.querySelectorAll('.property-tab').forEach(tab => {
              tab.addEventListener('click', function() {
                document.querySelectorAll('.property-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentProperty = this.dataset.property;
                filterAndDisplay();
              });
            });
            
            // Initial display
            filterAndDisplay();
          }
          
          function filterAndDisplay() {
            const searchTerm = document.getElementById('q').value.toLowerCase();
            
            // Filter data
            let filtered = allData;
            
            // Filter by type
            if (currentType !== 'all') {
              filtered = filtered.filter(item => item.type === currentType);
            }
            
            // Filter by search term
            if (searchTerm) {
              filtered = filtered.filter(item => 
                item.name.toLowerCase().includes(searchTerm) ||
                item.elements.some(el => el.toLowerCase().includes(searchTerm))
              );
            }
            
            displayResults(filtered);
          }
          
          function displayResults(data) {
            const container = document.getElementById('table');
            
            if (data.length === 0) {
              container.innerHTML = '<p class="no-data">' + t('noData') + '</p>';
              return;
            }
            
            let html = '<div class="result-count">' + t('resultsCount').replace('{count}', data.length) + '</div>';
            
            // Display different tables based on selected property category
            if (currentProperty === 'structure') {
              html += displayStructureTable(data);
            } else if (currentProperty === 'thermodynamics') {
              html += displayThermodynamicsTable(data);
            } else if (currentProperty === 'mechanics') {
              html += displayMechanicsTable(data);
            } else if (currentProperty === 'defects') {
              html += displayDefectsTable(data);
            }
            
            container.innerHTML = html;
          }
          
          function displayStructureTable(data) {
            let html = '<div class="table-wrapper"><table><thead><tr>';
            html += '<th>' + t('table.id') + '</th>';
            html += '<th>' + t('table.name') + '</th>';
            html += '<th>' + t('table.type') + '</th>';
            html += '<th>' + t('table.elements') + '</th>';
            html += '<th>' + t('table.density') + '<br/>(g/cm¬≥)</th>';
            html += '<th>' + t('table.latticeA') + '<br/>(√Ö)</th>';
            html += '<th>' + t('table.latticeB') + '<br/>(√Ö)</th>';
            html += '<th>' + t('table.latticeC') + '<br/>(√Ö)</th>';
            html += '<th>' + t('table.rdf') + '</th>';
            html += '<th>' + t('viewDetails') + '</th>';
            html += '</tr></thead><tbody>';
            
            for (const x of data) {
              html += '<tr>';
              html += '<td>' + x.id + '</td>';
              html += '<td>' + x.name + '</td>';
              html += '<td>' + translateType(x.type) + '</td>';
              html += '<td>' + x.elements.join(', ') + '</td>';
              html += '<td>' + formatValue(x.density, 3) + '</td>';
              html += '<td>' + formatValue(x.structure?.latticeConstants?.a, 3) + '</td>';
              html += '<td>' + formatValue(x.structure?.latticeConstants?.b, 3) + '</td>';
              html += '<td>' + formatValue(x.structure?.latticeConstants?.c, 3) + '</td>';
              html += '<td>' + formatFile(x.structure?.rdf) + '</td>';
              html += '<td><button class="btn-detail" onclick="showDetail(\'' + x.id + '\')">üëÅÔ∏è</button></td>';
              html += '</tr>';
            }
            
            html += '</tbody></table></div>';
            return html;
          }
          
          function displayThermodynamicsTable(data) {
            let html = '<div class="table-wrapper"><table><thead><tr>';
            html += '<th>' + t('table.id') + '</th>';
            html += '<th>' + t('table.name') + '</th>';
            html += '<th>' + t('table.type') + '</th>';
            html += '<th>' + t('table.elements') + '</th>';
            html += '<th>' + t('table.specificHeat') + '<br/>(J/kg¬∑K)</th>';
            html += '<th>' + t('table.mixingEnthalpy') + '<br/>(kJ/mol)</th>';
            html += '<th>' + t('table.diffusionCoeff') + '<br/>(m¬≤/s)</th>';
            html += '<th>' + t('table.thermalExpansion') + '<br/>(10‚Åª‚Å∂/K)</th>';
            html += '<th>' + t('viewDetails') + '</th>';
            html += '</tr></thead><tbody>';
            
            for (const x of data) {
              html += '<tr>';
              html += '<td>' + x.id + '</td>';
              html += '<td>' + x.name + '</td>';
              html += '<td>' + translateType(x.type) + '</td>';
              html += '<td>' + x.elements.join(', ') + '</td>';
              html += '<td>' + formatValue(x.thermodynamics?.specificHeat, 2) + '</td>';
              html += '<td>' + formatValue(x.thermodynamics?.mixingEnthalpy, 2) + '</td>';
              html += '<td>' + formatScientific(x.thermodynamics?.diffusionCoefficient) + '</td>';
              html += '<td>' + formatScientific(x.thermodynamics?.thermalExpansion) + '</td>';
              html += '<td><button class="btn-detail" onclick="showDetail(\'' + x.id + '\')">üëÅÔ∏è</button></td>';
              html += '</tr>';
            }
            
            html += '</tbody></table></div>';
            return html;
          }
          
          function displayMechanicsTable(data) {
            let html = '<div class="table-wrapper"><table><thead><tr>';
            html += '<th>' + t('table.id') + '</th>';
            html += '<th>' + t('table.name') + '</th>';
            html += '<th>' + t('table.type') + '</th>';
            html += '<th>' + t('table.elements') + '</th>';
            html += '<th>C11<br/>(GPa)</th>';
            html += '<th>C12<br/>(GPa)</th>';
            html += '<th>C44<br/>(GPa)</th>';
            html += '<th>' + t('table.youngsModulus') + '<br/>(GPa)</th>';
            html += '<th>' + t('table.poissonsRatio') + '</th>';
            html += '<th>' + t('table.stressStrain') + '</th>';
            html += '<th>' + t('viewDetails') + '</th>';
            html += '</tr></thead><tbody>';
            
            for (const x of data) {
              html += '<tr>';
              html += '<td>' + x.id + '</td>';
              html += '<td>' + x.name + '</td>';
              html += '<td>' + translateType(x.type) + '</td>';
              html += '<td>' + x.elements.join(', ') + '</td>';
              html += '<td>' + formatValue(x.mechanics?.elasticConstants?.C11, 2) + '</td>';
              html += '<td>' + formatValue(x.mechanics?.elasticConstants?.C12, 2) + '</td>';
              html += '<td>' + formatValue(x.mechanics?.elasticConstants?.C44, 2) + '</td>';
              html += '<td>' + formatValue(x.mechanics?.youngsModulus, 2) + '</td>';
              html += '<td>' + formatValue(x.mechanics?.poissonsRatio, 3) + '</td>';
              html += '<td>' + formatFile(x.mechanics?.stressStrain) + '</td>';
              html += '<td><button class="btn-detail" onclick="showDetail(\'' + x.id + '\')">üëÅÔ∏è</button></td>';
              html += '</tr>';
            }
            
            html += '</tbody></table></div>';
            return html;
          }
          
          function displayDefectsTable(data) {
            let html = '<div class="table-wrapper"><table><thead><tr>';
            html += '<th>' + t('table.id') + '</th>';
            html += '<th>' + t('table.name') + '</th>';
            html += '<th>' + t('table.type') + '</th>';
            html += '<th>' + t('table.elements') + '</th>';
            html += '<th>' + t('table.vacancyEnergy') + '<br/>(eV)</th>';
            html += '<th>' + t('table.interstitialEnergy') + '<br/>(eV)</th>';
            html += '<th>' + t('table.stackingFault') + '<br/>(mJ/m¬≤)</th>';
            html += '<th>' + t('viewDetails') + '</th>';
            html += '</tr></thead><tbody>';
            
            for (const x of data) {
              html += '<tr>';
              html += '<td>' + x.id + '</td>';
              html += '<td>' + x.name + '</td>';
              html += '<td>' + translateType(x.type) + '</td>';
              html += '<td>' + x.elements.join(', ') + '</td>';
              html += '<td>' + formatValue(x.defects?.vacancyFormationEnergy, 3) + '</td>';
              html += '<td>' + formatValue(x.defects?.interstitialFormationEnergy, 3) + '</td>';
              html += '<td>' + formatValue(x.defects?.stackingFaultEnergy, 2) + '</td>';
              html += '<td><button class="btn-detail" onclick="showDetail(\'' + x.id + '\')">üëÅÔ∏è</button></td>';
              html += '</tr>';
            }
            
            html += '</tbody></table></div>';
            return html;
          }
          
          function formatValue(val, decimals = 2) {
            if (val === null || val === undefined) return '-';
            if (typeof val === 'number') return val.toFixed(decimals);
            return val;
          }
          
          function formatScientific(val) {
            if (val === null || val === undefined) return '-';
            if (typeof val === 'number') return val.toExponential(2);
            return val;
          }
          
          function formatFile(file) {
            if (!file) return '-';
            const filename = file.split('/').pop();
            return '<a href="' + file + '" target="_blank">üìÑ ' + filename + '</a>';
          }
          
          function translateType(type) {
            const typeMap = {
              en: {
                'amorphous': 'Amorphous',
                'crystalline': 'Crystalline',
                'interface': 'Interface'
              },
              zh: {
                'amorphous': 'ÈùûÊô∂ÊÄÅ',
                'crystalline': 'Êô∂ÊÄÅ',
                'interface': 'ÁïåÈù¢'
              }
            };
            return typeMap[currentLang][type] || type;
          }
          
          // Show material detail in modal
          window.showDetail = function(materialId) {
            const material = allData.find(m => m.id === materialId);
            if (!material) return;
            
            const modal = document.getElementById('detailModal');
            const content = document.getElementById('detailContent');
            
            let html = '<h2>' + material.name + '</h2>';
            
            // Basic Information
            html += '<div class="detail-section">';
            html += '<h3>' + t('basicInfo') + '</h3>';
            html += '<div class="detail-grid">';
            html += '<div class="detail-item"><label>ID:</label><span>' + material.id + '</span></div>';
            html += '<div class="detail-item"><label>' + t('table.name') + ':</label><span>' + material.name + '</span></div>';
            html += '<div class="detail-item"><label>' + t('table.type') + ':</label><span>' + translateType(material.type) + '</span></div>';
            html += '<div class="detail-item"><label>' + t('table.elements') + ':</label><span>' + material.elements.join(', ') + '</span></div>';
            html += '<div class="detail-item"><label>' + t('table.density') + ':</label><span>' + formatValue(material.density, 3) + ' g/cm¬≥</span></div>';
            html += '</div></div>';
            
            // Structure Properties
            html += '<div class="detail-section">';
            html += '<h3>' + t('structureInfo') + '</h3>';
            html += '<div class="detail-grid">';
            if (material.structure?.latticeConstants) {
              html += '<div class="detail-item"><label>' + t('table.latticeA') + ':</label><span>' + formatValue(material.structure.latticeConstants.a, 3) + ' √Ö</span></div>';
              html += '<div class="detail-item"><label>' + t('table.latticeB') + ':</label><span>' + formatValue(material.structure.latticeConstants.b, 3) + ' √Ö</span></div>';
              html += '<div class="detail-item"><label>' + t('table.latticeC') + ':</label><span>' + formatValue(material.structure.latticeConstants.c, 3) + ' √Ö</span></div>';
            }
            html += '</div>';
            if (material.structure?.rdf) {
              html += '<div class="chart-container">';
              html += '<h4>' + t('table.rdf') + '</h4>';
              html += renderChart(material.structure.rdf, 'rdf-' + material.id, 'RDF');
              html += '</div>';
            }
            html += '</div>';
            
            // Thermodynamics Properties
            html += '<div class="detail-section">';
            html += '<h3>' + t('thermoInfo') + '</h3>';
            html += '<div class="detail-grid">';
            html += '<div class="detail-item"><label>' + t('table.specificHeat') + ':</label><span>' + formatValue(material.thermodynamics?.specificHeat, 2) + ' J/kg¬∑K</span></div>';
            html += '<div class="detail-item"><label>' + t('table.mixingEnthalpy') + ':</label><span>' + formatValue(material.thermodynamics?.mixingEnthalpy, 2) + ' kJ/mol</span></div>';
            html += '<div class="detail-item"><label>' + t('table.diffusionCoeff') + ':</label><span>' + formatScientific(material.thermodynamics?.diffusionCoefficient) + ' m¬≤/s</span></div>';
            html += '<div class="detail-item"><label>' + t('table.thermalExpansion') + ':</label><span>' + formatScientific(material.thermodynamics?.thermalExpansion) + ' 10‚Åª‚Å∂/K</span></div>';
            html += '</div></div>';
            
            // Mechanics Properties
            html += '<div class="detail-section">';
            html += '<h3>' + t('mechInfo') + '</h3>';
            html += '<div class="detail-grid">';
            if (material.mechanics?.elasticConstants) {
              html += '<div class="detail-item"><label>C11:</label><span>' + formatValue(material.mechanics.elasticConstants.C11, 2) + ' GPa</span></div>';
              html += '<div class="detail-item"><label>C12:</label><span>' + formatValue(material.mechanics.elasticConstants.C12, 2) + ' GPa</span></div>';
              html += '<div class="detail-item"><label>C44:</label><span>' + formatValue(material.mechanics.elasticConstants.C44, 2) + ' GPa</span></div>';
            }
            html += '<div class="detail-item"><label>' + t('table.youngsModulus') + ':</label><span>' + formatValue(material.mechanics?.youngsModulus, 2) + ' GPa</span></div>';
            html += '<div class="detail-item"><label>' + t('table.poissonsRatio') + ':</label><span>' + formatValue(material.mechanics?.poissonsRatio, 3) + '</span></div>';
            html += '</div>';
            if (material.mechanics?.stressStrain) {
              html += '<div class="chart-container">';
              html += '<h4>' + t('table.stressStrain') + '</h4>';
              html += renderChart(material.mechanics.stressStrain, 'stress-' + material.id, 'Stress-Strain');
              html += '</div>';
            }
            html += '</div>';
            
            // Defect Properties
            html += '<div class="detail-section">';
            html += '<h3>' + t('defectInfo') + '</h3>';
            html += '<div class="detail-grid">';
            html += '<div class="detail-item"><label>' + t('table.vacancyEnergy') + ':</label><span>' + formatValue(material.defects?.vacancyFormationEnergy, 3) + ' eV</span></div>';
            html += '<div class="detail-item"><label>' + t('table.interstitialEnergy') + ':</label><span>' + formatValue(material.defects?.interstitialFormationEnergy, 3) + ' eV</span></div>';
            html += '<div class="detail-item"><label>' + t('table.stackingFault') + ':</label><span>' + formatValue(material.defects?.stackingFaultEnergy, 2) + ' mJ/m¬≤</span></div>';
            html += '</div></div>';
            
            content.innerHTML = html;
            modal.style.display = 'block';
          };
          
          // Render chart (image or plot)
          function renderChart(data, id, title) {
            if (!data || data === '-') {
              return '<p class="no-data">' + t('noDataAvailable') + '</p>';
            }
            
            // If data is a URL (string), display as image
            if (typeof data === 'string') {
              return '<img src="' + data + '" alt="' + title + '" class="chart-image" />';
            }
            
            // If data is an array, create a simple plot
            if (Array.isArray(data)) {
              return '<canvas id="' + id + '" class="chart-canvas"></canvas><script>renderPlot("' + id + '", ' + JSON.stringify(data) + ', "' + title + '");</script>';
            }
            
            return '<p>' + t('noDataAvailable') + '</p>';
          }
          
          // Simple plot rendering using Canvas
          window.renderPlot = function(canvasId, data, title) {
            setTimeout(function() {
              const canvas = document.getElementById(canvasId);
              if (!canvas) return;
              
              const ctx = canvas.getContext('2d');
              const width = canvas.width = canvas.offsetWidth;
              const height = canvas.height = 300;
              
              // Clear canvas
              ctx.clearRect(0, 0, width, height);
              
              // Simple line plot
              ctx.strokeStyle = '#667eea';
              ctx.lineWidth = 2;
              ctx.beginPath();
              
              const padding = 40;
              const plotWidth = width - 2 * padding;
              const plotHeight = height - 2 * padding;
              
              const xStep = plotWidth / (data.length - 1);
              const yMin = Math.min(...data.map(d => d.y || d[1] || d));
              const yMax = Math.max(...data.map(d => d.y || d[1] || d));
              const yRange = yMax - yMin || 1;
              
              data.forEach((point, i) => {
                const y = typeof point === 'object' ? (point.y || point[1]) : point;
                const x = padding + i * xStep;
                const plotY = height - padding - ((y - yMin) / yRange) * plotHeight;
                
                if (i === 0) {
                  ctx.moveTo(x, plotY);
                } else {
                  ctx.lineTo(x, plotY);
                }
              });
              
              ctx.stroke();
              
              // Draw axes
              ctx.strokeStyle = '#333';
              ctx.lineWidth = 1;
              ctx.beginPath();
              ctx.moveTo(padding, padding);
              ctx.lineTo(padding, height - padding);
              ctx.lineTo(width - padding, height - padding);
              ctx.stroke();
              
              // Add labels
              ctx.fillStyle = '#333';
              ctx.font = '12px Arial';
              ctx.textAlign = 'center';
              ctx.fillText(title, width / 2, 20);
            }, 100);
          };
          
          // Modal close handlers
          document.getElementById('modalClose').onclick = function() {
            document.getElementById('detailModal').style.display = 'none';
          };
          
          window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target === modal) {
              modal.style.display = 'none';
            }
          };
          EOF
      
      - name: Enhance index.html
        run: |
          cat > _site/index.html << 'EOF'
          <!doctype html>
          <html lang="zh-CN">
          <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width,initial-scale=1" />
            <title>Alloy Materials Database / ÂêàÈáëÊùêÊñôÊï∞ÊçÆÂ∫ì</title>
            <meta name="description" content="Alloy materials database - Primary focus: Al-Ni-Cu-Zr-Nb-Ta-W system" />
            <link rel="stylesheet" href="css/style.css" />
          </head>
          <body>
            <header>
              <div class="header-content">
                <div>
                  <h1 id="title">7-Element Alloy Materials Database</h1>
                  <p class="subtitle" id="subtitle">Al-Ni-Cu-Zr-Nb-Ta-W System Material Properties</p>
                </div>
                <button id="langToggle" class="lang-toggle" title="Switch Language / ÂàáÊç¢ËØ≠Ë®Ä">
                  <span id="langText">‰∏≠Êñá</span>
                </button>
              </div>
            </header>
            
            <main>
              <!-- Search Panel -->
              <div class="search-panel">
                <div class="search-group">
                  <input id="q" placeholder="Search materials or elements..." />
                  <button id="search" class="btn-primary"><span id="searchBtnText">Search</span></button>
                </div>
                <div class="info-badge">
                  <span id="infoText">Tip: Select material type and property category, or use search to find specific materials</span>
                </div>
              </div>
              
              <!-- Material Type Selection -->
              <div class="tabs-container">
                <h3 id="typeTitle">Material Type</h3>
                <div class="tabs">
                  <button class="type-tab active" data-type="all"><span data-i18n="type.all">All</span></button>
                  <button class="type-tab" data-type="crystalline"><span data-i18n="type.crystalline">Crystalline</span></button>
                  <button class="type-tab" data-type="amorphous"><span data-i18n="type.amorphous">Amorphous</span></button>
                  <button class="type-tab" data-type="interface"><span data-i18n="type.interface">Interface</span></button>
                </div>
              </div>
              
              <!-- Property Category Selection -->
              <div class="tabs-container">
                <h3 id="propertyTitle">Property Category</h3>
                <div class="tabs">
                  <button class="property-tab active" data-property="structure"><span data-i18n="property.structure">Structure</span></button>
                  <button class="property-tab" data-property="thermodynamics"><span data-i18n="property.thermodynamics">Thermodynamics</span></button>
                  <button class="property-tab" data-property="mechanics"><span data-i18n="property.mechanics">Mechanics</span></button>
                  <button class="property-tab" data-property="defects"><span data-i18n="property.defects">Defects</span></button>
                </div>
              </div>
              
              <!-- Data Display Area -->
              <div id="table" class="results-container">
                <p class="loading" id="loading">Loading...</p>
              </div>
            </main>
            
            <!-- Material Detail Modal -->
            <div id="detailModal" class="modal">
              <div class="modal-content">
                <span class="modal-close" id="modalClose">&times;</span>
                <div id="detailContent"></div>
              </div>
            </div>
            
            <footer>
              <p>
                <a href="https://github.com/wqchen007/jkw-7element-alloy-database" target="_blank" id="githubLink">
                  GitHub Repository
                </a> | 
                <a href="https://github.com/wqchen007/jkw-7element-alloy-database/blob/main/README.md" target="_blank" id="docsLink">Documentation</a> |
                <span id="updateLabel">Data Updated:</span> <span id="updateTime"></span>
              </p>
            </footer>
            
            <script src="js/app.js"></script>
          </body>
          </html>
          EOF
      
      - name: Enhance CSS
        run: |
          cat > _site/css/style.css << 'EOF'
          * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
          }
          
          body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
          }
          
          header {
            background: white;
            border-radius: 12px;
            padding: 2em;
            margin-bottom: 2em;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
          }
          
          .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
          }
          
          .header-content > div {
            flex: 1;
            text-align: center;
          }
          
          .lang-toggle {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s;
            white-space: nowrap;
          }
          
          .lang-toggle:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
          }
          
          .lang-toggle:active {
            transform: translateY(0);
          }
          
          h1 {
            color: #667eea;
            margin-bottom: 0.5em;
            font-size: 2em;
          }
          
          .subtitle {
            color: #666;
            font-size: 1.1em;
          }
          
          main {
            background: white;
            border-radius: 12px;
            padding: 2em;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2em;
          }
          
          .search-panel {
            margin-bottom: 2em;
          }
          
          .search-group {
            display: flex;
            gap: 10px;
            margin-bottom: 1em;
          }
          
          input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
          }
          
          input:focus {
            outline: none;
            border-color: #667eea;
          }
          
          .btn-primary {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: 500;
          }
          
          .btn-primary:hover {
            background: #5568d3;
          }
          
          .info-badge {
            background: #f0f7ff;
            border-left: 4px solid #667eea;
            padding: 12px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #555;
          }
          
          .tabs-container {
            margin-bottom: 1.5em;
          }
          
          .tabs-container h3 {
            color: #667eea;
            margin-bottom: 0.8em;
            font-size: 1.1em;
          }
          
          .tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
          }
          
          .type-tab, .property-tab {
            padding: 10px 20px;
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95em;
            font-weight: 500;
          }
          
          .type-tab:hover, .property-tab:hover {
            background: #e8eeff;
            border-color: #667eea;
          }
          
          .type-tab.active, .property-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
          }
          
          .results-container {
            margin-top: 1.5em;
          }
          
          .result-count {
            margin-bottom: 1em;
            padding: 10px;
            background: #f0f7ff;
            border-radius: 6px;
            color: #667eea;
            font-weight: 500;
          }
          
          .table-wrapper {
            overflow-x: auto;
          }
          
          table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
            min-width: 800px;
          }
          
          thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
          }
          
          th {
            padding: 14px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
          }
          
          td {
            padding: 12px 10px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9em;
          }
          
          tr:hover {
            background: #f8f9fa;
          }
          
          tbody tr:nth-child(even) {
            background: #fafbfc;
          }
          
          tbody tr:nth-child(even):hover {
            background: #f0f2f5;
          }
          
          .loading, .no-data {
            text-align: center;
            padding: 3em 2em;
            color: #666;
            font-size: 1.1em;
          }
          
          .no-data {
            background: #fff3cd;
            border-radius: 8px;
            color: #856404;
          }
          
          footer {
            text-align: center;
            color: white;
            padding: 1em;
          }
          
          footer a {
            color: white;
            text-decoration: none;
            border-bottom: 1px solid rgba(255,255,255,0.5);
            transition: border-bottom-color 0.3s;
          }
          
          footer a:hover {
            border-bottom-color: white;
          }
          
          /* Ë°®Ê†ºÂÜÖÈìæÊé•Ê†∑Âºè */
          table a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
          }
          
          table a:hover {
            text-decoration: underline;
          }
          
          .btn-detail {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s;
          }
          
          .btn-detail:hover {
            background: #5568d3;
            transform: scale(1.1);
          }
          
          /* Modal Styles */
          .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            overflow: auto;
          }
          
          .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease-out;
          }
          
          @keyframes slideIn {
            from {
              transform: translateY(-50px);
              opacity: 0;
            }
            to {
              transform: translateY(0);
              opacity: 1;
            }
          }
          
          .modal-close {
            color: #aaa;
            float: right;
            font-size: 32px;
            font-weight: bold;
            padding: 10px 20px;
            cursor: pointer;
            transition: color 0.3s;
          }
          
          .modal-close:hover,
          .modal-close:focus {
            color: #667eea;
          }
          
          #detailContent {
            padding: 20px 30px 30px;
          }
          
          #detailContent h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
          }
          
          .detail-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
          }
          
          .detail-section h3 {
            color: #555;
            margin-bottom: 15px;
            font-size: 1.3em;
          }
          
          .detail-section h4 {
            color: #666;
            margin-top: 15px;
            margin-bottom: 10px;
          }
          
          .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
          }
          
          .detail-item {
            display: flex;
            align-items: baseline;
            padding: 10px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
          }
          
          .detail-item label {
            font-weight: 600;
            color: #667eea;
            min-width: 150px;
            margin-right: 10px;
          }
          
          .detail-item span {
            color: #333;
            word-break: break-word;
          }
          
          .chart-container {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
          }
          
          .chart-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          }
          
          .chart-canvas {
            width: 100%;
            max-width: 800px;
            height: 300px;
            display: block;
            margin: 10px auto;
          }
          
          @media (max-width: 768px) {
            body {
              padding: 10px;
            }
            
            h1 {
              font-size: 1.5em;
            }
            
            .search-group {
              flex-direction: column;
            }
            
            .tabs {
              justify-content: flex-start;
            }
            
            .type-tab, .property-tab {
              flex: 1 1 auto;
              min-width: 100px;
              text-align: center;
            }
            
            table {
              font-size: 0.85em;
              min-width: 600px;
            }
            
            th, td {
              padding: 8px 6px;
            }
            
            .table-wrapper {
              border: 1px solid #e0e0e0;
              border-radius: 8px;
            }
            
            .modal-content {
              width: 95%;
              margin: 5% auto;
            }
            
            .detail-grid {
              grid-template-columns: 1fr;
            }
            
            .detail-item {
              flex-direction: column;
              align-items: flex-start;
            }
            
            .detail-item label {
              min-width: auto;
              margin-bottom: 5px;
            }
          }
          EOF
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
