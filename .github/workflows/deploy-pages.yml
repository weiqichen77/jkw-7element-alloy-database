name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
      - scaffold/frontend-backend-structure
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Generate sample data
        run: |
          cd scripts
          node generate-sample-data.js
      
      - name: Prepare deployment
        run: |
          mkdir -p _site
          cp -r frontend/* _site/
          cp -r backend/data _site/data
          
          # Create a simple API mock for GitHub Pages
          cat > _site/api-mock.js << 'EOF'
          // Simple client-side API mock for GitHub Pages
          async function loadMaterials() {
            const response = await fetch('./data/materials.json');
            return await response.json();
          }
          
          window.MaterialsAPI = {
            async search(query = {}) {
              const allData = await loadMaterials();
              let results = allData;
              
              // Filter by query string
              if (query.q) {
                const searchTerm = query.q.toLowerCase();
                results = results.filter(item => 
                  item.name.toLowerCase().includes(searchTerm) ||
                  item.elements.some(el => el.toLowerCase().includes(searchTerm))
                );
              }
              
              // Filter by type
              if (query.type) {
                results = results.filter(item => item.type === query.type);
              }
              
              // Filter by element
              if (query.element) {
                results = results.filter(item => item.elements.includes(query.element));
              }
              
              // Pagination
              const page = parseInt(query.page) || 1;
              const perPage = parseInt(query.per_page) || 25;
              const total = results.length;
              const start = (page - 1) * perPage;
              const end = start + perPage;
              
              return {
                total,
                page,
                per_page: perPage,
                results: results.slice(start, end)
              };
            },
            
            async getById(id) {
              const allData = await loadMaterials();
              return allData.find(item => item.id == id);
            }
          };
          EOF
      
      - name: Update frontend to use mock API
        run: |
          # Update app.js to use the mock API for GitHub Pages
          cat > _site/js/app.js << 'EOF'
          // Load the API mock
          const script = document.createElement('script');
          script.src = './api-mock.js';
          document.head.appendChild(script);
          
          script.onload = function() {
            // Initialize the app after API mock is loaded
            initApp();
          };
          
          function initApp() {
            document.getElementById('search').onclick = fetchData;
            document.getElementById('q').addEventListener('keypress', function(e) {
              if (e.key === 'Enter') fetchData();
            });
            
            // Load data on page load
            fetchData();
          }
          
          async function fetchData() {
            const q = document.getElementById('q').value;
            const typeFilter = document.getElementById('typeFilter')?.value || '';
            const elementFilter = document.getElementById('elementFilter')?.value || '';
            
            const query = { q, page: 1, per_page: 50 };
            if (typeFilter) query.type = typeFilter;
            if (elementFilter) query.element = elementFilter;
            
            try {
              const data = await window.MaterialsAPI.search(query);
              displayResults(data);
            } catch (error) {
              console.error('Error fetching data:', error);
              document.getElementById('table').innerHTML = '<p style="color:red;">Error loading data</p>';
            }
          }
          
          function displayResults(data) {
            let html = '<div style="margin-bottom:1em;">æ‰¾åˆ° ' + data.total + ' æ¡ç»“æœ</div>';
            html += '<table><thead><tr><th>ID</th><th>åç§°</th><th>ç±»å‹</th><th>å…ƒç´ </th><th>å¯†åº¦ (g/cmÂ³)</th><th>æ¯”çƒ­å®¹ (J/kgÂ·K)</th></tr></thead><tbody>';
            
            for (const x of data.results) {
              const specificHeat = x.properties?.specific_heat || '-';
              html += '<tr>';
              html += '<td>' + x.id + '</td>';
              html += '<td>' + x.name + '</td>';
              html += '<td>' + translateType(x.type) + '</td>';
              html += '<td>' + x.elements.join(', ') + '</td>';
              html += '<td>' + (x.density ? x.density.toFixed(2) : '-') + '</td>';
              html += '<td>' + (typeof specificHeat === 'number' ? specificHeat.toFixed(2) : specificHeat) + '</td>';
              html += '</tr>';
            }
            
            html += '</tbody></table>';
            document.getElementById('table').innerHTML = html;
          }
          
          function translateType(type) {
            const typeMap = {
              'amorphous': 'éæ™¶æ€',
              'crystalline': 'æ™¶æ€',
              'interface': 'ç•Œé¢'
            };
            return typeMap[type] || type;
          }
          EOF
      
      - name: Enhance index.html
        run: |
          cat > _site/index.html << 'EOF'
          <!doctype html>
          <html lang="zh-CN">
          <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width,initial-scale=1" />
            <title>7å…ƒç´ åˆé‡‘ææ–™æ•°æ®åº“</title>
            <meta name="description" content="éæ™¶åˆé‡‘ã€åˆé‡‘åŠéæ™¶-æ™¶ä½“ç•Œé¢ææ–™æ•°æ®åº“" />
            <link rel="stylesheet" href="css/style.css" />
          </head>
          <body>
            <header>
              <h1>ğŸ”¬ 7å…ƒç´ åˆé‡‘ææ–™æ•°æ®åº“</h1>
              <p class="subtitle">Al-Ni-Cu-Zr-Nb-Ta-W ä½“ç³»ææ–™æ€§èƒ½æ•°æ®</p>
            </header>
            
            <main>
              <div class="search-panel">
                <div class="search-group">
                  <input id="q" placeholder="æœç´¢ææ–™åç§°æˆ–å…ƒç´ ..." />
                  <button id="search" class="btn-primary">ğŸ” æœç´¢</button>
                </div>
                <div class="info-badge">
                  <span>ğŸ’¡ æç¤ºï¼šè¾“å…¥å…ƒç´ ç¬¦å·ï¼ˆå¦‚ Al, Niï¼‰æˆ–ææ–™ç±»å‹è¿›è¡Œæœç´¢</span>
                </div>
              </div>
              
              <div id="table" class="results-container">
                <p class="loading">åŠ è½½ä¸­...</p>
              </div>
            </main>
            
            <footer>
              <p>
                <a href="https://github.com/wqchen007/jkw-7element-alloy-database" target="_blank">
                  ğŸ“š GitHubä»“åº“
                </a> | 
                <a href="./docs/API.md" target="_blank">APIæ–‡æ¡£</a> |
                æ•°æ®æ›´æ–°æ—¶é—´: <span id="updateTime"></span>
              </p>
            </footer>
            
            <script>
              document.getElementById('updateTime').textContent = new Date().toLocaleDateString('zh-CN');
            </script>
            <script src="js/app.js"></script>
          </body>
          </html>
          EOF
      
      - name: Enhance CSS
        run: |
          cat > _site/css/style.css << 'EOF'
          * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
          }
          
          body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
          }
          
          header {
            background: white;
            border-radius: 12px;
            padding: 2em;
            margin-bottom: 2em;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
          }
          
          h1 {
            color: #667eea;
            margin-bottom: 0.5em;
            font-size: 2em;
          }
          
          .subtitle {
            color: #666;
            font-size: 1.1em;
          }
          
          main {
            background: white;
            border-radius: 12px;
            padding: 2em;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2em;
          }
          
          .search-panel {
            margin-bottom: 2em;
          }
          
          .search-group {
            display: flex;
            gap: 10px;
            margin-bottom: 1em;
          }
          
          input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
          }
          
          input:focus {
            outline: none;
            border-color: #667eea;
          }
          
          .btn-primary {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: 500;
          }
          
          .btn-primary:hover {
            background: #5568d3;
          }
          
          .info-badge {
            background: #f0f7ff;
            border-left: 4px solid #667eea;
            padding: 12px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #555;
          }
          
          table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
          }
          
          thead {
            background: #f8f9fa;
          }
          
          th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #667eea;
            border-bottom: 2px solid #667eea;
          }
          
          td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
          }
          
          tr:hover {
            background: #f8f9fa;
          }
          
          .loading {
            text-align: center;
            padding: 2em;
            color: #666;
          }
          
          footer {
            text-align: center;
            color: white;
            padding: 1em;
          }
          
          footer a {
            color: white;
            text-decoration: none;
            border-bottom: 1px solid rgba(255,255,255,0.5);
          }
          
          footer a:hover {
            border-bottom-color: white;
          }
          
          @media (max-width: 768px) {
            body {
              padding: 10px;
            }
            
            h1 {
              font-size: 1.5em;
            }
            
            .search-group {
              flex-direction: column;
            }
            
            table {
              font-size: 0.9em;
            }
            
            th, td {
              padding: 8px;
            }
          }
          EOF
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
