name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
      - scaffold/frontend-backend-structure
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Generate sample data
        run: |
          cd scripts
          node generate-sample-data.js
      
      - name: Prepare deployment
        run: |
          mkdir -p _site
          cp -r frontend/* _site/
          cp -r backend/data _site/data
          
          # Create a simple API mock for GitHub Pages
          cat > _site/api-mock.js << 'EOF'
          // Simple client-side API mock for GitHub Pages
          async function loadMaterials() {
            const response = await fetch('./data/materials.json');
            return await response.json();
          }
          
          window.MaterialsAPI = {
            async search(query = {}) {
              const allData = await loadMaterials();
              let results = allData;
              
              // Filter by query string
              if (query.q) {
                const searchTerm = query.q.toLowerCase();
                results = results.filter(item => 
                  item.name.toLowerCase().includes(searchTerm) ||
                  item.elements.some(el => el.toLowerCase().includes(searchTerm))
                );
              }
              
              // Filter by type
              if (query.type) {
                results = results.filter(item => item.type === query.type);
              }
              
              // Filter by element
              if (query.element) {
                results = results.filter(item => item.elements.includes(query.element));
              }
              
              // Pagination
              const page = parseInt(query.page) || 1;
              const perPage = parseInt(query.per_page) || 25;
              const total = results.length;
              const start = (page - 1) * perPage;
              const end = start + perPage;
              
              return {
                total,
                page,
                per_page: perPage,
                results: results.slice(start, end)
              };
            },
            
            async getById(id) {
              const allData = await loadMaterials();
              return allData.find(item => item.id == id);
            }
          };
          EOF
      
      - name: Update frontend to use mock API
        run: |
          # Update app.js to use the mock API for GitHub Pages
          cat > _site/js/app.js << 'EOF'
          // å…¨å±€çŠ¶æ€
          let allData = [];
          let currentType = 'all';
          let currentProperty = 'structure';
          
          // Load the API mock
          const script = document.createElement('script');
          script.src = './api-mock.js';
          document.head.appendChild(script);
          
          script.onload = function() {
            initApp();
          };
          
          async function initApp() {
            // åŠ è½½æ‰€æœ‰æ•°æ®
            const response = await fetch('./data/materials.json');
            allData = await response.json();
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('search').onclick = () => filterAndDisplay();
            document.getElementById('q').addEventListener('keypress', function(e) {
              if (e.key === 'Enter') filterAndDisplay();
            });
            
            // ææ–™ç±»å‹åˆ‡æ¢
            document.querySelectorAll('.type-tab').forEach(tab => {
              tab.addEventListener('click', function() {
                document.querySelectorAll('.type-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentType = this.dataset.type;
                filterAndDisplay();
              });
            });
            
            // æ€§è´¨åˆ†ç±»åˆ‡æ¢
            document.querySelectorAll('.property-tab').forEach(tab => {
              tab.addEventListener('click', function() {
                document.querySelectorAll('.property-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentProperty = this.dataset.property;
                filterAndDisplay();
              });
            });
            
            // åˆå§‹æ˜¾ç¤º
            filterAndDisplay();
          }
          
          function filterAndDisplay() {
            const searchTerm = document.getElementById('q').value.toLowerCase();
            
            // ç­›é€‰æ•°æ®
            let filtered = allData;
            
            // æŒ‰ç±»å‹ç­›é€‰
            if (currentType !== 'all') {
              filtered = filtered.filter(item => item.type === currentType);
            }
            
            // æŒ‰æœç´¢è¯ç­›é€‰
            if (searchTerm) {
              filtered = filtered.filter(item => 
                item.name.toLowerCase().includes(searchTerm) ||
                item.elements.some(el => el.toLowerCase().includes(searchTerm))
              );
            }
            
            displayResults(filtered);
          }
          
          function displayResults(data) {
            const container = document.getElementById('table');
            
            if (data.length === 0) {
              container.innerHTML = '<p class="no-data">æœªæ‰¾åˆ°åŒ¹é…çš„æ•°æ®</p>';
              return;
            }
            
            let html = '<div class="result-count">æ‰¾åˆ° ' + data.length + ' æ¡ç»“æœ</div>';
            
            // æ ¹æ®é€‰ä¸­çš„æ€§è´¨ç±»åˆ«æ˜¾ç¤ºä¸åŒçš„è¡¨æ ¼
            if (currentProperty === 'structure') {
              html += displayStructureTable(data);
            } else if (currentProperty === 'thermodynamics') {
              html += displayThermodynamicsTable(data);
            } else if (currentProperty === 'mechanics') {
              html += displayMechanicsTable(data);
            } else if (currentProperty === 'defects') {
              html += displayDefectsTable(data);
            }
            
            container.innerHTML = html;
          }
          
          function displayStructureTable(data) {
            let html = '<div class="table-wrapper"><table><thead><tr>';
            html += '<th>ID</th><th>åç§°</th><th>ç±»å‹</th><th>å…ƒç´ </th><th>å¯†åº¦<br/>(g/cmÂ³)</th>';
            html += '<th>æ™¶æ ¼å¸¸æ•° a<br/>(Ã…)</th><th>æ™¶æ ¼å¸¸æ•° b<br/>(Ã…)</th><th>æ™¶æ ¼å¸¸æ•° c<br/>(Ã…)</th>';
            html += '<th>å¾„å‘åˆ†å¸ƒå‡½æ•°</th>';
            html += '</tr></thead><tbody>';
            
            for (const x of data) {
              html += '<tr>';
              html += '<td>' + x.id + '</td>';
              html += '<td>' + x.name + '</td>';
              html += '<td>' + translateType(x.type) + '</td>';
              html += '<td>' + x.elements.join(', ') + '</td>';
              html += '<td>' + formatValue(x.density, 3) + '</td>';
              html += '<td>' + formatValue(x.structure?.lattice_constant?.a, 3) + '</td>';
              html += '<td>' + formatValue(x.structure?.lattice_constant?.b, 3) + '</td>';
              html += '<td>' + formatValue(x.structure?.lattice_constant?.c, 3) + '</td>';
              html += '<td>' + formatFile(x.structure?.radial_distribution) + '</td>';
              html += '</tr>';
            }
            
            html += '</tbody></table></div>';
            return html;
          }
          
          function displayThermodynamicsTable(data) {
            let html = '<div class="table-wrapper"><table><thead><tr>';
            html += '<th>ID</th><th>åç§°</th><th>ç±»å‹</th><th>å…ƒç´ </th>';
            html += '<th>æ¯”çƒ­å®¹<br/>(J/kgÂ·K)</th><th>æ··åˆç„“<br/>(kJ/mol)</th>';
            html += '<th>æ‰©æ•£ç³»æ•°<br/>(mÂ²/s)</th><th>çƒ­è†¨èƒ€ç³»æ•°<br/>(1/K)</th>';
            html += '</tr></thead><tbody>';
            
            for (const x of data) {
              html += '<tr>';
              html += '<td>' + x.id + '</td>';
              html += '<td>' + x.name + '</td>';
              html += '<td>' + translateType(x.type) + '</td>';
              html += '<td>' + x.elements.join(', ') + '</td>';
              html += '<td>' + formatValue(x.thermodynamics?.specific_heat, 2) + '</td>';
              html += '<td>' + formatValue(x.thermodynamics?.mixing_enthalpy, 2) + '</td>';
              html += '<td>' + formatScientific(x.thermodynamics?.diffusion_coefficient) + '</td>';
              html += '<td>' + formatScientific(x.thermodynamics?.thermal_expansion) + '</td>';
              html += '</tr>';
            }
            
            html += '</tbody></table></div>';
            return html;
          }
          
          function displayMechanicsTable(data) {
            let html = '<div class="table-wrapper"><table><thead><tr>';
            html += '<th>ID</th><th>åç§°</th><th>ç±»å‹</th><th>å…ƒç´ </th>';
            html += '<th>C11<br/>(GPa)</th><th>C12<br/>(GPa)</th><th>C44<br/>(GPa)</th>';
            html += '<th>æ¨æ°æ¨¡é‡<br/>(GPa)</th><th>æ³Šæ¾æ¯”</th><th>åº”åŠ›åº”å˜æ›²çº¿</th>';
            html += '</tr></thead><tbody>';
            
            for (const x of data) {
              html += '<tr>';
              html += '<td>' + x.id + '</td>';
              html += '<td>' + x.name + '</td>';
              html += '<td>' + translateType(x.type) + '</td>';
              html += '<td>' + x.elements.join(', ') + '</td>';
              html += '<td>' + formatValue(x.mechanics?.elastic_constants?.C11, 2) + '</td>';
              html += '<td>' + formatValue(x.mechanics?.elastic_constants?.C12, 2) + '</td>';
              html += '<td>' + formatValue(x.mechanics?.elastic_constants?.C44, 2) + '</td>';
              html += '<td>' + formatValue(x.mechanics?.youngs_modulus, 2) + '</td>';
              html += '<td>' + formatValue(x.mechanics?.poisson_ratio, 3) + '</td>';
              html += '<td>' + formatFile(x.mechanics?.stress_strain_curve) + '</td>';
              html += '</tr>';
            }
            
            html += '</tbody></table></div>';
            return html;
          }
          
          function displayDefectsTable(data) {
            let html = '<div class="table-wrapper"><table><thead><tr>';
            html += '<th>ID</th><th>åç§°</th><th>ç±»å‹</th><th>å…ƒç´ </th>';
            html += '<th>ç©ºä½å½¢æˆèƒ½<br/>(eV)</th><th>é—´éš™å½¢æˆèƒ½<br/>(eV)</th><th>å±‚é”™èƒ½<br/>(mJ/mÂ²)</th>';
            html += '</tr></thead><tbody>';
            
            for (const x of data) {
              html += '<tr>';
              html += '<td>' + x.id + '</td>';
              html += '<td>' + x.name + '</td>';
              html += '<td>' + translateType(x.type) + '</td>';
              html += '<td>' + x.elements.join(', ') + '</td>';
              html += '<td>' + formatValue(x.defects?.vacancy_formation_energy, 3) + '</td>';
              html += '<td>' + formatValue(x.defects?.interstitial_formation_energy, 3) + '</td>';
              html += '<td>' + formatValue(x.defects?.stacking_fault_energy, 2) + '</td>';
              html += '</tr>';
            }
            
            html += '</tbody></table></div>';
            return html;
          }
          
          function formatValue(val, decimals = 2) {
            if (val === null || val === undefined) return '-';
            if (typeof val === 'number') return val.toFixed(decimals);
            return val;
          }
          
          function formatScientific(val) {
            if (val === null || val === undefined) return '-';
            if (typeof val === 'number') return val.toExponential(2);
            return val;
          }
          
          function formatFile(file) {
            if (!file) return '-';
            const filename = file.split('/').pop();
            return '<a href="' + file + '" target="_blank">ğŸ“„ ' + filename + '</a>';
          }
          
          function translateType(type) {
            const typeMap = {
              'amorphous': 'éæ™¶æ€',
              'crystalline': 'æ™¶æ€',
              'interface': 'ç•Œé¢'
            };
            return typeMap[type] || type;
          }
          EOF
      
      - name: Enhance index.html
        run: |
          cat > _site/index.html << 'EOF'
          <!doctype html>
          <html lang="zh-CN">
          <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width,initial-scale=1" />
            <title>7å…ƒç´ åˆé‡‘ææ–™æ•°æ®åº“</title>
            <meta name="description" content="éæ™¶åˆé‡‘ã€åˆé‡‘åŠéæ™¶-æ™¶ä½“ç•Œé¢ææ–™æ•°æ®åº“" />
            <link rel="stylesheet" href="css/style.css" />
          </head>
          <body>
            <header>
              <h1>ğŸ”¬ 7å…ƒç´ åˆé‡‘ææ–™æ•°æ®åº“</h1>
              <p class="subtitle">Al-Ni-Cu-Zr-Nb-Ta-W ä½“ç³»ææ–™æ€§èƒ½æ•°æ®</p>
            </header>
            
            <main>
              <!-- æœç´¢é¢æ¿ -->
              <div class="search-panel">
                <div class="search-group">
                  <input id="q" placeholder="æœç´¢ææ–™åç§°æˆ–å…ƒç´ ..." />
                  <button id="search" class="btn-primary">ğŸ” æœç´¢</button>
                </div>
                <div class="info-badge">
                  <span>ğŸ’¡ æç¤ºï¼šé€‰æ‹©ææ–™ç±»å‹å’Œæ€§è´¨åˆ†ç±»ï¼Œæˆ–ä½¿ç”¨æœç´¢åŠŸèƒ½æŸ¥æ‰¾ç‰¹å®šææ–™</span>
                </div>
              </div>
              
              <!-- ææ–™ç±»å‹é€‰æ‹© -->
              <div class="tabs-container">
                <h3>ğŸ“Š ææ–™ç±»å‹</h3>
                <div class="tabs">
                  <button class="type-tab active" data-type="all">å…¨éƒ¨</button>
                  <button class="type-tab" data-type="crystalline">æ™¶æ€</button>
                  <button class="type-tab" data-type="amorphous">éæ™¶æ€</button>
                  <button class="type-tab" data-type="interface">ç•Œé¢</button>
                </div>
              </div>
              
              <!-- æ€§è´¨åˆ†ç±»é€‰æ‹© -->
              <div class="tabs-container">
                <h3>ğŸ” æ€§è´¨åˆ†ç±»</h3>
                <div class="tabs">
                  <button class="property-tab active" data-property="structure">ç»“æ„ä¿¡æ¯</button>
                  <button class="property-tab" data-property="thermodynamics">çƒ­åŠ›å­¦/åŠ¨åŠ›å­¦</button>
                  <button class="property-tab" data-property="mechanics">åŠ›å­¦æ€§èƒ½</button>
                  <button class="property-tab" data-property="defects">ç¼ºé™·æ€§è´¨</button>
                </div>
              </div>
              
              <!-- æ•°æ®æ˜¾ç¤ºåŒº -->
              <div id="table" class="results-container">
                <p class="loading">åŠ è½½ä¸­...</p>
              </div>
            </main>
            
            <footer>
              <p>
                <a href="https://github.com/wqchen007/jkw-7element-alloy-database" target="_blank">
                  ğŸ“š GitHubä»“åº“
                </a> | 
                <a href="https://github.com/wqchen007/jkw-7element-alloy-database/blob/main/README.md" target="_blank">ä½¿ç”¨è¯´æ˜</a> |
                æ•°æ®æ›´æ–°æ—¶é—´: <span id="updateTime"></span>
              </p>
            </footer>
            
            <script>
              document.getElementById('updateTime').textContent = new Date().toLocaleDateString('zh-CN');
            </script>
            <script src="js/app.js"></script>
          </body>
          </html>
          EOF
      
      - name: Enhance CSS
        run: |
          cat > _site/css/style.css << 'EOF'
          * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
          }
          
          body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
          }
          
          header {
            background: white;
            border-radius: 12px;
            padding: 2em;
            margin-bottom: 2em;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
          }
          
          h1 {
            color: #667eea;
            margin-bottom: 0.5em;
            font-size: 2em;
          }
          
          .subtitle {
            color: #666;
            font-size: 1.1em;
          }
          
          main {
            background: white;
            border-radius: 12px;
            padding: 2em;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2em;
          }
          
          .search-panel {
            margin-bottom: 2em;
          }
          
          .search-group {
            display: flex;
            gap: 10px;
            margin-bottom: 1em;
          }
          
          input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
          }
          
          input:focus {
            outline: none;
            border-color: #667eea;
          }
          
          .btn-primary {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: 500;
          }
          
          .btn-primary:hover {
            background: #5568d3;
          }
          
          .info-badge {
            background: #f0f7ff;
            border-left: 4px solid #667eea;
            padding: 12px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #555;
          }
          
          .tabs-container {
            margin-bottom: 1.5em;
          }
          
          .tabs-container h3 {
            color: #667eea;
            margin-bottom: 0.8em;
            font-size: 1.1em;
          }
          
          .tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
          }
          
          .type-tab, .property-tab {
            padding: 10px 20px;
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95em;
            font-weight: 500;
          }
          
          .type-tab:hover, .property-tab:hover {
            background: #e8eeff;
            border-color: #667eea;
          }
          
          .type-tab.active, .property-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
          }
          
          .results-container {
            margin-top: 1.5em;
          }
          
          .result-count {
            margin-bottom: 1em;
            padding: 10px;
            background: #f0f7ff;
            border-radius: 6px;
            color: #667eea;
            font-weight: 500;
          }
          
          .table-wrapper {
            overflow-x: auto;
          }
          
          table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
            min-width: 800px;
          }
          
          thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
          }
          
          th {
            padding: 14px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
          }
          
          td {
            padding: 12px 10px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9em;
          }
          
          tr:hover {
            background: #f8f9fa;
          }
          
          tbody tr:nth-child(even) {
            background: #fafbfc;
          }
          
          tbody tr:nth-child(even):hover {
            background: #f0f2f5;
          }
          
          .loading, .no-data {
            text-align: center;
            padding: 3em 2em;
            color: #666;
            font-size: 1.1em;
          }
          
          .no-data {
            background: #fff3cd;
            border-radius: 8px;
            color: #856404;
          }
          
          footer {
            text-align: center;
            color: white;
            padding: 1em;
          }
          
          footer a {
            color: white;
            text-decoration: none;
            border-bottom: 1px solid rgba(255,255,255,0.5);
            transition: border-bottom-color 0.3s;
          }
          
          footer a:hover {
            border-bottom-color: white;
          }
          
          /* è¡¨æ ¼å†…é“¾æ¥æ ·å¼ */
          table a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
          }
          
          table a:hover {
            text-decoration: underline;
          }
          
          @media (max-width: 768px) {
            body {
              padding: 10px;
            }
            
            h1 {
              font-size: 1.5em;
            }
            
            .search-group {
              flex-direction: column;
            }
            
            .tabs {
              justify-content: flex-start;
            }
            
            .type-tab, .property-tab {
              flex: 1 1 auto;
              min-width: 100px;
              text-align: center;
            }
            
            table {
              font-size: 0.85em;
              min-width: 600px;
            }
            
            th, td {
              padding: 8px 6px;
            }
            
            .table-wrapper {
              border: 1px solid #e0e0e0;
              border-radius: 8px;
            }
          }
          EOF
            margin-bottom: 0.5em;
            font-size: 2em;
          }
          
          .subtitle {
            color: #666;
            font-size: 1.1em;
          }
          
          main {
            background: white;
            border-radius: 12px;
            padding: 2em;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2em;
          }
          
          .search-panel {
            margin-bottom: 2em;
          }
          
          .search-group {
            display: flex;
            gap: 10px;
            margin-bottom: 1em;
          }
          
          input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
          }
          
          input:focus {
            outline: none;
            border-color: #667eea;
          }
          
          .btn-primary {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: 500;
          }
          
          .btn-primary:hover {
            background: #5568d3;
          }
          
          .info-badge {
            background: #f0f7ff;
            border-left: 4px solid #667eea;
            padding: 12px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #555;
          }
          
          table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
          }
          
          thead {
            background: #f8f9fa;
          }
          
          th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #667eea;
            border-bottom: 2px solid #667eea;
          }
          
          td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
          }
          
          tr:hover {
            background: #f8f9fa;
          }
          
          .loading {
            text-align: center;
            padding: 2em;
            color: #666;
          }
          
          footer {
            text-align: center;
            color: white;
            padding: 1em;
          }
          
          footer a {
            color: white;
            text-decoration: none;
            border-bottom: 1px solid rgba(255,255,255,0.5);
          }
          
          footer a:hover {
            border-bottom-color: white;
          }
          
          @media (max-width: 768px) {
            body {
              padding: 10px;
            }
            
            h1 {
              font-size: 1.5em;
            }
            
            .search-group {
              flex-direction: column;
            }
            
            table {
              font-size: 0.9em;
            }
            
            th, td {
              padding: 8px;
            }
          }
          EOF
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
