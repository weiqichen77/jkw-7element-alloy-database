name: Create scaffold PR

on:
  workflow_dispatch:

jobs:
  create-scaffold-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Create scaffold pull request (files mapping)
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: scaffold/frontend-backend-structure
          title: "Scaffold: frontend/backend structure for 7-element alloy database"
          body: |
            This PR adds an initial scaffold for the 7-element alloy database:
            - frontend/ static pages (search, pagination, CRUD UI)
            - backend/api/ serverless APIs (materials CRUD, search, stats)
            - scripts/generate-sample-data.js (creates sample records using elements Al,Ni,Cu,Zr,Nb,Ta,W)
            - docs and deploy guide
            Notes:
            - Write operations require token auth via header x-api-token (ADMIN_TOKEN).
            - For production, migrate storage to a DB (Postgres/Typesense/Elastic) and replace simple token auth with OAuth or RBAC.
          labels: scaffold
          files: |
            README.md: |
              # 非晶合金 / 合金 / 非晶-晶体界面材料数据库（7-element 模板）
              
              本仓库为“非晶合金、合金及非晶-晶体界面材料数据库”模板：
              - 前端：静态页面（适合 GitHub Pages）
              - 后端：Vercel 风格 serverless API（api/*.js）
              - 样例数据可生成于 backend/data/materials.json（使用脚本生成）
              - 脚本：scripts/generate-sample-data.js（用于生成样例数据）
              
              快速开始：
              1. 在 Actions -> Create scaffold PR -> Run workflow 触发本 workflow
              2. 合并 PR 到 main 后，根据 deploy-guide.md 部署前端（GitHub Pages）和后端（Vercel）

            deploy-guide.md: |
              # 部署指南（快速）
              
              前端（GitHub Pages）
              - 将 frontend/ 内容发布到 GitHub Pages（可用 gh-pages 分支或 docs/）。
              
              后端（Vercel）
              - 在 Vercel 控制台新建项目并连接本仓库。
              - Vercel 会将 backend/api/*.js 识别为 Serverless 函数。
              - 在 Vercel 项目设置 -> Environment Variables 中设置 ADMIN_TOKEN（用于简单 token 验证）。
              
              本地测试
              - 合并 PR 后可在本地运行 scripts/generate-sample-data.js 生成示例数据并用 vercel dev 或本地代理测试。

            frontend/index.html: |
              <!doctype html>
              <html lang="zh-CN">
              <head>
                <meta charset="utf-8" />
                <meta name="viewport" content="width=device-width,initial-scale=1" />
                <title>材料数据库 — 浏览与检索</title>
                <link rel="stylesheet" href="css/style.css" />
                <link rel="stylesheet" href="css/chart.css" />
                <script src="https://cdn.jsdelivr.net/npm/chart.js@4.9.0/dist/chart.umd.min.js"></script>
              </head>
              <body>
                <header>
                  <h1>非晶/合金/界面 材料数据库</h1>
                  <div class="controls">
                    <input id="searchInput" placeholder="搜索材料名、元素或属性..." />
                    <select id="typeFilter">
                      <option value="">全部类型</option>
                      <option value="amorphous">非晶合金</option>
                      <option value="crystalline">合金</option>
                      <option value="interface">非晶-晶体界面</option>
                    </select>
                    <select id="elementFilter"><option value="">元素</option></select>
                    <button id="searchBtn">搜索</button>
                    <button id="newBtn">新增条目</button>
                  </div>
                </header>
                <main>
                  <section id="summary" class="card">
                    <h2>统计概览</h2>
                    <div id="statBoxes"></div>
                    <canvas id="typeChart" width="400" height="160"></canvas>
                  </section>
                  <section id="results" class="card">
                    <h2>检索结果</h2>
                    <div id="tableContainer"></div>
                    <div id="pagination"></div>
                  </section>
                  <section id="detail" class="card">
                    <h2>材料详情</h2>
                    <div id="detailView">选中行以查看详情</div>
                  </section>
                </main>
                <footer>
                  <small>模板 — 需结合生产数据库与真实认证</small>
                </footer>
                <script src="js/app.js"></script>
                <script src="js/table-manager.js"></script>
                <script src="js/chart-manager.js"></script>
                <script src="js/github-auth.js"></script>
              </body>
              </html>

            frontend/css/style.css: |
              /* 基本布局 */
              body { font-family: Arial, Helvetica, sans-serif; margin: 0; padding: 0; background: #f5f7fb; color:#222; }
              header { background: #0b4a6f; color: #fff; padding: 12px 20px; display:flex; flex-direction:column; gap:8px; }
              header h1 { margin:0; font-size:1.2rem; }
              .controls { display:flex; gap:8px; align-items:center; }
              .controls input, .controls select { padding:6px 8px; border-radius:4px; border:1px solid #ccc; }
              main { display:grid; grid-template-columns: 1fr 400px; gap: 18px; padding: 20px; }
              .card { background: #fff; padding: 12px; border-radius:6px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
              #tableContainer { overflow:auto; max-height:420px; }

            frontend/js/app.js: |
              // 前端主逻辑（简化版）
              const API_BASE = '/api';
              const ADMIN_TOKEN = '';
              const state = { page: 1, per_page: 25, q: '', type: '', element: '' };
              async function init() {
                document.getElementById('searchBtn').addEventListener('click', onSearch);
                document.getElementById('newBtn').addEventListener('click', createNew);
                await loadStats(); await loadPage(1);
              }
              async function fetchAPI(path, params={}, options={}) {
                let url = new URL(API_BASE + path, location.origin);
                Object.entries(params).forEach(([k,v])=>{ if(v!==undefined && v!=='') url.searchParams.set(k,v); });
                const fetchOpts = Object.assign({ headers: {} }, options);
                if (ADMIN_TOKEN) fetchOpts.headers['x-api-token'] = ADMIN_TOKEN;
                const res = await fetch(url, fetchOpts);
                if(!res.ok) throw new Error('API error: ' + res.status + ' ' + await res.text());
                return res.json();
              }
              /* 渲染表格、分页、CRUD 等函数略（可在 PR review 后拓展） */
              window.addEventListener('load', init);

            backend/api/materials.js: |
              // materials API (file-backed simple implementation)
              const fs = require('fs');
              const path = require('path');
              const DATA_DIR = path.join(__dirname, '..', 'data');
              const DATA_PATH = path.join(DATA_DIR, 'materials.json');
              function loadData(){ if(!fs.existsSync(DATA_PATH)) return []; try{return JSON.parse(fs.readFileSync(DATA_PATH,'utf8'))}catch(e){console.error(e);return[]} }
              function saveData(d){ if(!fs.existsSync(DATA_DIR)) fs.mkdirSync(DATA_DIR,{recursive:true}); fs.writeFileSync(DATA_PATH, JSON.stringify(d,null,2),'utf8'); }
              function getAuthToken(req){ const header = req.headers['x-api-token'] || req.headers['X-Api-Token']; const q = req.query.token || req.query.api_token; return header || q || process.env.ADMIN_TOKEN || null; }
              function checkAuth(req){ const admin = process.env.ADMIN_TOKEN || ''; if(!admin) return true; const t = getAuthToken(req); return t && t===admin; }
              module.exports = (req,res) => {
                const method = req.method.toUpperCase();
                const parts = req.url.split('?')[0].split('/').filter(Boolean);
                const idPart = parts[2];
                const data = loadData();
                if (method==='GET' && !idPart) {
                  const q=(req.query.q||'').toLowerCase(); const page=Math.max(1,parseInt(req.query.page||'1',10)); const per_page=Math.min(200,Math.max(1,parseInt(req.query.per_page||'25',10)));
                  const type=req.query.type||''; const element=req.query.element||'';
                  let results = data.slice();
                  if(type) results = results.filter(r=>r.type===type);
                  if(element) results = results.filter(r=> (r.elements||[]).includes(element));
                  if(q) results = results.filter(r=> (r.name+' '+(r.elements||[]).join(' ')+' '+JSON.stringify(r.properties||{})).toLowerCase().includes(q));
                  const total=results.length; const start=(page-1)*per_page; const paged=results.slice(start,start+per_page);
                  const typeCounts={amorphous:0,crystalline:0,interface:0}; const allElements=new Set();
                  for(const r of data){ typeCounts[r.type]=(typeCounts[r.type]||0)+1; (r.elements||[]).forEach(e=>allElements.add(e)); }
                  return res.json({ total, page, per_page, results: paged, typeCounts, allElements: Array.from(allElements).sort() });
                }
                if(method==='GET' && idPart){ const id=Number(idPart); const rec=data.find(r=>r.id===id); if(!rec) return res.status(404).json({error:'not found'}); return res.json(rec); }
                if(!checkAuth(req)) return res.status(401).json({ error: 'unauthorized' });
                if(method==='POST' && !idPart){ const body=req.body||{}; const maxId=data.reduce((m,r)=>Math.max(m,Number(r.id||0)),0); const newRec=Object.assign({id:maxId+1,name:body.name||`new-${Date.now()}`,type:body.type||'amorphous',elements:body.elements||[],density:Number(body.density||0)}, body); data.push(newRec); saveData(data); return res.status(201).json(newRec); }
                if((method==='PUT' || method==='PATCH') && idPart){ const id=Number(idPart); const idx=data.findIndex(r=>r.id===id); if(idx===-1) return res.status(404).json({error:'not found'}); const body=req.body||{}; data[idx]=Object.assign({}, data[idx], body); saveData(data); return res.json(data[idx]); }
                if(method==='DELETE' && idPart){ const id=Number(idPart); const idx=data.findIndex(r=>r.id===id); if(idx===-1) return res.status(404).json({error:'not found'}); const removed=data.splice(idx,1); saveData(data); return res.json({deleted: removed[0]}); }
                return res.status(405).json({ error: 'method not allowed' });
              }

            scripts/generate-sample-data.js: |
              // Generate sample data (simple)
              const fs = require('fs');
              const path = require('path');
              const OUT_DIR = path.join(__dirname, '..', 'backend', 'data');
              if(!fs.existsSync(OUT_DIR)) fs.mkdirSync(OUT_DIR,{recursive:true});
              const OUT_FILE = path.join(OUT_DIR, 'materials.json');
              const ELEMENTS = ['Al','Ni','Cu','Zr','Nb','Ta','W'];
              function rnd(min,max,d=4){ return Number((Math.random()*(max-min)+min).toFixed(d)); }
              function pickN(arr,n){ const s=new Set(); while(s.size<n) s.add(arr[Math.floor(Math.random()*arr.length)]); return Array.from(s); }
              const N = 50; const types=['amorphous','crystalline','interface']; const out=[];
              for(let i=1;i<=N;i++){ const t=types[i%types.length]; const elems=pickN(ELEMENTS,2+(i%3)); out.push({ id:i, name:`${t}-Sample-${i}`, type:t, elements:elems, density:rnd(2.0,9.5), properties:{ specific_heat:rnd(100,900), expansion_coeff:rnd(1,20) } }); }
              fs.writeFileSync(OUT_FILE, JSON.stringify(out,null,2),'utf8'); console.log(`Wrote ${N} records to ${OUT_FILE}`);

            docs/API.md: |
              # API 文档（模板）
              ## GET /api/materials
              支持参数： q, page, per_page, type, element
              返回： { total, page, per_page, results, typeCounts, allElements }
