name: Create scaffold PR (full, use GITHUB_TOKEN)

on:
  workflow_dispatch:

jobs:
  create-scaffold-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Create scaffold PR with full files
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: scaffold/frontend-backend-structure
          title: "Scaffold: frontend/backend structure for 7-element alloy database"
          body: |
            This PR adds a full scaffold for the 7-element alloy database:
            - frontend/: é™æ€é¡µé¢ï¼ˆææ–™æ£€ç´¢ã€åˆ†é¡µã€å¢åˆ æ”¹æŸ¥ã€è¡¨æ ¼ã€ç»Ÿè®¡å›¾è¡¨ç­‰ï¼‰
            - backend/api/: serverless demo APIï¼ˆåŸºäºæ–‡ä»¶çš„ CRUDï¼Œåç«¯ç”¨ token é‰´æƒï¼Œä»…ç¤ºä¾‹ï¼Œå¯æœ¬åœ°æŒä¹…ï¼Œç”Ÿäº§è¯·æ›¿æ¢ä¸º Postgres/Typesense/Elasticï¼‰
            - scripts/: generate-sample-data.js ç”Ÿæˆæ ·ä¾‹æ•°æ®ï¼ˆ50æ¡ï¼Œ7å…ƒç´ ç»„åˆï¼Œä»…åœ¨æœ¬åœ°/CIè¿è¡Œï¼‰
            - docs/: éƒ¨ç½²ä¸APIè¯´æ˜
            > ğŸ‘· åˆå¹¶åå»ºè®®ç”¨ Vercel éƒ¨ç½² backend/ï¼Œå¹¶åœ¨ ENV é…ç½® ADMIN_TOKENï¼Œç”¨å‰ç«¯äº¤äº’æˆ– curl æµ‹è¯• CRUDã€‚
            ---
            âš ï¸ æœ¬ PR æ–‡ä»¶å…¨éƒ¨ä¸ºåˆç‰ˆ demoï¼Œä»…ä¾›æ¼”ç¤ºå­¦ä¹ ï¼Œä¸å»ºè®®ç”¨ä½œç”Ÿäº§ï¼
          labels: scaffold
          files: |
            README.md: |
              # éæ™¶/åˆé‡‘/ç•Œé¢ ææ–™å…¨æ ˆ Scaffoldï¼ˆ7 å…ƒç´  demoï¼‰
              - å‰ç«¯è§ frontend/ï¼Œåç«¯ serverless API è§ backend/api/
              - scripts/generate-sample-data.js ç”Ÿæˆææ–™æ ·ä¾‹æ•°æ® backend/data/materials.json
              - æ–‡æ¡£è§ docs/ï¼Œdeploy/ci è§ .github/workflows/
              ç”Ÿäº§è¯·æ¢çœŸæ­£æ•°æ®åº“å’Œç”¨æˆ·è®¤è¯ï¼Œè¯¦è§ deploy-guide.md

            deploy-guide.md: |
              # éƒ¨ç½²æŒ‡å—
              ## åç«¯
              - æ¨èéƒ¨ç½² Vercelï¼ˆæˆ–æœ¬åœ°/äº‘å‡½æ•°ï¼‰ã€‚
              - ç¯å¢ƒå˜é‡éœ€é…ç½® ADMIN_TOKENï¼ˆå†™æ“ä½œé‰´æƒï¼‰ã€‚
              - é»˜è®¤é‡‡ç”¨æ–‡ä»¶å­˜å‚¨æœ¬åœ° backend/data/materials.jsonï¼Œä»…é€‚ç”¨äº demoã€‚
              ## å‰ç«¯
              - frontend/ å¯ç”¨ GitHub Pagesï¼Œæˆ– Vercel é™æ€éƒ¨ç½²ã€‚
              ## æœ¬åœ°æµ‹è¯•å¿«é€Ÿæ­¥éª¤
              ```bash
              git checkout scaffold/frontend-backend-structure
              npm i -g vercel
              node scripts/generate-sample-data.js
              vercel dev
              cd frontend && python -m http.server 8080
              ```

            docs/API.md: |
              # API æ–‡æ¡£
              ## GET /api/materials
              - æ”¯æŒå‚æ•°: q, page, per_page, type, element
              ## GET /api/materials/:id
              - å•æ¡
              ## POST/PUT/DELETE /api/materials éœ€ x-api-token:ADMIN_TOKEN
              - ç”Ÿäº§è¯·æ›¿æ¢ token ä¸º OAuth/RBAC
              ## GET /api/stats
              - ç±»å‹åˆ†å¸ƒç»Ÿè®¡

            scripts/generate-sample-data.js: |
              // ç”Ÿæˆ 50 æ¡ 7å…ƒç´ ç»„åˆææ–™æ ·ä¾‹æ•°æ®
              const fs = require('fs'), path = require('path');
              const OUT_DIR = path.join(__dirname,'..','backend','data');
              fs.mkdirSync(OUT_DIR,{recursive:true});
              const OUT_FILE = path.join(OUT_DIR,'materials.json');
              const ELEMENTS = ['Al','Ni','Cu','Zr','Nb','Ta','W'];
              function rn(a,b){return Math.round((Math.random()*(b-a)+a)*10000)/10000;}
              function pick(arr,n){ const s=new Set(); while(s.size<n)s.add(arr[~~(Math.random()*arr.length)]);return Array.from(s);}
              const N=50;const types=['amorphous','crystalline','interface'];const out=[];
              for(let i=1;i<=N;i++){ const t=types[i%3]; out.push({ id:i, name:`${t}-Sample-${i}`, type:t, elements:pick(ELEMENTS,2+(i%3)), density:rn(2.0,9.5), properties:{specific_heat:rn(100,900)} });}
              fs.writeFileSync(OUT_FILE,JSON.stringify(out,null,2),'utf8');
              console.log('Wrote',N,'records to',OUT_FILE);

            backend/api/materials.js: |
              // demo CRUD, æ–‡ä»¶å­˜å‚¨ï¼Œtoken é‰´æƒ
              const fs=require('fs'),path=require('path');
              const DATA_DIR=path.join(__dirname,'..','data'),DATA_PATH=path.join(DATA_DIR,'materials.json');
              function load(){if(!fs.existsSync(DATA_PATH))return[];try{return JSON.parse(fs.readFileSync(DATA_PATH))}catch(e){return[]}}
              function save(data){fs.mkdirSync(DATA_DIR,{recursive:true});fs.writeFileSync(DATA_PATH,JSON.stringify(data,null,2));}
              function token(req){return req.headers['x-api-token']||req.query.token||process.env.ADMIN_TOKEN||'';}
              function checkAuth(req){const t=process.env.ADMIN_TOKEN;if(!t)return false;return token(req)===t;}
              module.exports=(req,res)=>{
                  const m=req.method.toUpperCase();
                  const [,,'materials',id]=req.url.split(/\/|\?/);
                  let data=load();
                  if(m==='GET'&&!id){ // åˆ—è¡¨
                     const {q='',page=1,per_page=25,type,element} = req.query;
                     let r=data.filter(x=>(!type||x.type===type)&&(!element||x.elements.includes(element))&&((x.name+x.elements.join()+' '+JSON.stringify(x.properties)).toLowerCase().includes((q||'').toLowerCase())));
                     const total=r.length, p=+page,pp=+per_page; r=r.slice((p-1)*pp,p*pp);
                     return res.json({total,page:p,per_page:pp,results:r});
                  }
                  if(m==='GET'&&id){const x=data.find(x=>x.id==id);if(!x)return res.status(404).json({error:'not found'});return res.json(x);}
                  if(['POST','PUT','PATCH','DELETE'].includes(m)&&!checkAuth(req)) return res.status(401).json({error:'unauthorized'});
                  if(m==='POST'){const b=req.body||{},i=data.reduce((a,x)=>Math.max(a,x.id),0)+1;x={id:i,...b};data.push(x);save(data);return res.status(201).json(x);}
                  if(['PUT','PATCH'].includes(m)&&id){const idx=data.findIndex(x=>x.id==id);if(idx==-1)return res.status(404).json({error:'not found'});data[idx]={...data[idx],...(req.body||{})};save(data);return res.json(data[idx]);}
                  if(m==='DELETE'&&id){const idx=data.findIndex(x=>x.id==id);if(idx==-1)return res.status(404).json({error:'not found'});const del=data.splice(idx,1);save(data);return res.json({deleted:del[0]});}
                  res.status(405).json({error:'method not allowed'});
              };
            backend/api/stats.js: |
              // è¿”å›ç±»å‹åˆ†å¸ƒ
              const fs=require('fs'),path=require('path');
              const DATA=path.join(__dirname,'..','data','materials.json');
              module.exports=(req,res)=>{
                const d=fs.existsSync(DATA)?JSON.parse(fs.readFileSync(DATA)):[];
                const typeCounts={amorphous:0,crystalline:0,interface:0};
                d.forEach(r=>typeCounts[r.type]=(typeCounts[r.type]||0)+1);
                res.json({total:d.length,typeCounts});
              };
            frontend/index.html: |
              <!doctype html>
              <html lang="zh-CN">
              <head>
                <meta charset="utf-8" />
                <meta name="viewport" content="width=device-width,initial-scale=1" />
                <title>ææ–™æ•°æ®åº“ â€” æµè§ˆ</title>
                <link rel="stylesheet" href="css/style.css" />
              </head>
              <body>
                <header><h1>ææ–™æ•°æ®åº“ï¼ˆ7å…ƒç´  Demoï¼‰</h1></header>
                <div id="app">
                  <input id="q" placeholder="æœç´¢" />
                  <button id="search">æœç´¢</button>
                  <div id="table"></div>
                </div>
                <script src="js/app.js"></script>
              </body>
              </html>
            frontend/js/app.js: |
              // demo å‰ç«¯ï¼šä»…ä¾›æœ¬åœ°/CIæµ‹è¯•
              async function fetchData() {
                const q = document.getElementById('q').value;
                const r = await fetch('/api/materials?q='+encodeURIComponent(q)).then(r=>r.json());
                let html='<table><tr><th>ID</th><th>Name</th><th>Type</th><th>Elements</th><th>Density</th></tr>';
                for(const x of r.results) html+=`<tr><td>${x.id}</td><td>${x.name}</td><td>${x.type}</td><td>${x.elements.join(',')}</td><td>${x.density||''}</td></tr>`;
                html+='</table>'; document.getElementById('table').innerHTML=html;
              }
              document.getElementById('search').onclick=fetchData;
            frontend/css/style.css: |
              body{font-family:-apple-system,BlinkMacSystemFont,Arial;background:#f9fbfd;color:#222;}
              h1{margin:1em 0;}
              table{border-collapse:collapse;width:100%;}
              td,th{border:1px solid #ddd;padding:6px 8px;}
              th{background:#e3eefc;}
              tr:nth-child(even){background:#f5f7fb;}
